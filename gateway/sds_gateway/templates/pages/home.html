{% extends "base.html" %}

{% load static i18n %}
{% load socialaccount %}

{% block title %}
    SDS Gateway
{% endblock title %}
{% block head %}
    <meta name="csrf-token" content="{{ csrf_token }}" />
{% endblock head %}
{% block content %}
{% endblock content %}
{% block body %}
    <main class="container mt-4">
        <!-- Description Section (Visible by default) -->
        <div class="collapse show" id="descriptionSection">
            <div class="p-5 mb-4 bg-light rounded-3">
                <div class="container-fluid py-5 text-center">
                    <h1 class="display-5 fw-bold">SpectrumX Data System</h1>
                    <p class="fs-5">
                        The SpectrumX Data System (SDS) is a key component of <a href="https://www.spectrumx.org/project/spectrum-awareness-for-coexistence/"
        target="_blank"
        rel="noopener noreferrer"
        class="external-link">SpectrumX Flagship Project 1: Spectrum Awareness for Coexistence</a> in support of SpectrumX's vision to be a trusted resource in the spectrum ecosystem. SpectrumX aims to provide objective, long-term, and innovative policy and technical contributions through collaborative, inclusive, and integrative education and research activities.
                    </p>
                    <div class="mt-4">
                        <button class="btn btn-primary btn-lg" 
                                type="button" 
                                id="showSearchBtn"
                                aria-expanded="false" 
                                aria-controls="descriptionSection searchSection">
                            <i class="bi bi-search me-2"></i>Search Public Datasets
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search Section (Hidden by default) -->
        <section class="collapse" id="searchSection">
            <div class="mb-3">
                <button class="btn btn-outline-secondary" 
                        type="button" 
                        id="showDescriptionBtn"
                        aria-expanded="true" 
                        aria-controls="descriptionSection searchSection">
                    <i class="bi bi-arrow-up me-2"></i>Back to Description
                </button>
            </div>
            <div class="row align-items-stretch">
                {% if latest_datasets %}
                    <!-- Search Form - 8 columns -->
                    <div class="col-md-8 d-flex">
                        {% include "users/partials/dataset_search_form.html" with show_clear_button=False %}
                    </div>
                    <!-- Latest 5 Public Datasets - 4 columns -->
                    <div class="col-md-4 d-flex">
                        <div class="card w-100">
                            <div class="card-body d-flex flex-column">
                                <h2 class="card-title h4 mb-3">Latest Public Datasets</h2>
                                <div class="list-group flex-grow-1">
                                    {% for dataset in latest_datasets %}
                                        <div class="list-group-item">
                                            <div class="d-flex w-100 justify-content-between">
                                                <h5 class="mb-1">
                                                    <a href="#" 
                                                        class="dataset-name-link text-decoration-none"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#datasetDetailsModal"
                                                        data-dataset-uuid="{{ dataset.uuid }}">
                                                        {{ dataset.name }}
                                                    </a>
                                                </h5>
                                                <small class="text-muted">
                                                    {% if dataset.dataset.created_at %}
                                                        {{ dataset.dataset.created_at|date:"Y-m-d" }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% if dataset.authors %}
                                                <p class="mb-1">
                                                    <small class="text-muted">
                                                        Authors: 
                                                        {% for author in dataset.authors|slice:":3" %}
                                                            {% if author.name %}{{ author.name }}{% else %}{{ author }}{% endif %}{% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                        {% if dataset.authors|length > 3 %}...{% endif %}
                                                    </small>
                                                </p>
                                            {% endif %}
                                            {% if dataset.keywords %}
                                                <div class="mb-1">
                                                    {% for keyword in dataset.keywords.all|slice:":5" %}
                                                        <span class="badge bg-secondary me-1">{{ keyword.name }}</span>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="col-md-12 d-flex mb-3">
                        <div class="card w-100">
                            <div class="card-body d-flex flex-column">
                                <div class="alert alert-info" role="alert">
                                    <h2 class="card-title h4 mb-3">No published datasets available</h2>
                                    <p class="card-text">There are no published datasets available at this time. Please check back later.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </section>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-code-slash text-success mb-3 fs-1" aria-hidden="true"></i>
                        <h2 class="card-title h5">SpectrumX SDK in PyPI</h2>
                        <p class="card-text mb-0">
                            <a href="https://pypi.org/project/spectrumx/"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="external-link">Python SDK for programmatic access</a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-book text-warning mb-3 fs-1" aria-hidden="true"></i>
                        <h2 class="card-title h5">Gateway API Documentation</h2>
                        <p class="card-text mb-0">
                            <a href="{% url 'api-docs' %}" class="capture-link external-link">Complete API reference and examples</a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-globe text-primary mb-3 fs-1" aria-hidden="true"></i>
                        <h2 class="card-title h5">SpectrumX Website</h2>
                        <p class="card-text mb-0">
                            <a href="https://www.spectrumx.org/"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="external-link">Learn more about NSF SpectrumX</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Dataset Details Modal -->
    {% include "users/partials/dataset_details_modal.html" %}
{% endblock body %}
{% block javascript %}
    {{ block.super }}
    <!-- Action components -->
    <script src="{% static 'js/actions/DetailsActionManager.js' %}"></script>
    <!-- Keyword chip input component -->
    <script src="{% static 'js/search/KeywordChipInput.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize DetailsActionManager for dataset details modal
            // For the home page, we use viewer-level permissions since we're showing public datasets
            if (typeof DetailsActionManager !== 'undefined' && typeof PermissionsManager !== 'undefined') {
                const permissions = new PermissionsManager({
                    userPermissionLevel: window.PermissionLevels.VIEWER,
                    currentUserId: {{ request.user.id|default:"null" }},
                    isOwner: false,
                    datasetPermissions: {
                        canEditMetadata: false,
                        canAddAssets: false,
                        canRemoveAnyAssets: false,
                        canRemoveOwnAssets: false,
                        canShare: false,
                        canDownload: true,  // Public datasets can be downloaded
                        canDelete: false
                    }
                });
                
                window.detailsActionManager = new DetailsActionManager({
                    permissions: permissions
                });
            }

            // Accordion functionality - ensure mutual exclusivity
            const descriptionSection = document.getElementById('descriptionSection');
            const searchSection = document.getElementById('searchSection');
            const showSearchBtn = document.getElementById('showSearchBtn');
            const showDescriptionBtn = document.getElementById('showDescriptionBtn');
            
            if (descriptionSection && searchSection && showSearchBtn && showDescriptionBtn && window.bootstrap) {
                // Show search section, hide description section
                showSearchBtn.addEventListener('click', function() {
                    const descCollapse = new bootstrap.Collapse(descriptionSection, { toggle: false });
                    const searchCollapse = new bootstrap.Collapse(searchSection, { toggle: false });
                    descCollapse.hide();
                    searchCollapse.show();
                });
                
                // Show description section, hide search section
                showDescriptionBtn.addEventListener('click', function() {
                    const descCollapse = new bootstrap.Collapse(descriptionSection, { toggle: false });
                    const searchCollapse = new bootstrap.Collapse(searchSection, { toggle: false });
                    searchCollapse.hide();
                    descCollapse.show();
                });
            }

            // Initialize keyword chip input when search section is shown
            if (searchSection && typeof KeywordChipInputInitializer !== 'undefined') {
                KeywordChipInputInitializer.initializeOnCollapseShow(searchSection);
                // Also try to initialize immediately in case section is already visible
                KeywordChipInputInitializer.initialize(searchSection);
            }
        });
    </script>
{% endblock javascript %}
