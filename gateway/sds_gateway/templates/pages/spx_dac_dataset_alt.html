{% extends "base.html" %}

{% load static i18n %}

{% block title %}
    NSF SpectrumX Data and Algorithm Competition (SpX-DAC)
{% endblock title %}
{% block content %}
{% endblock content %}
{% block body %}
    <main class="container mt-4">
        <div class="p-5 mb-4 bg-light rounded-3">
            <div class="container-fluid py-5">
                <h1 class="display-5 fw-bold text-dark mb-4">NSF SpectrumX Data and Algorithm Competition (SpX-DAC)</h1>
                <p class="col-md-10 fs-5 text-dark">
                    Welcome! The SpectrumX Data System (SDS) provides the data sharing platform for the NSF SpectrumX Data and Algorithm Competition (SpX-DAC). This page will guide you through accessing the competition dataset. You'll be using the SpectrumX Python library to download and work with the dataset.
                </p>
            </div>
        </div>
        <!-- Step 1: Generate API Key -->
        <div class="row mb-5">
            <div class="col-lg-10 mx-auto">
                <div class="mb-4">
                    <h2 class="h3 text-dark mb-3 text-start">
                        <span class="badge bg-primary me-2">Step 1</span>
                        Generate Your API Key
                    </h2>
                    <p class="text-dark">
                        First, you'll need an API key to access the competition dataset through the SpectrumX Data System. Click the button below to generate one. Your API key will appear here once generated - make sure to copy it, as you'll need it for the Python script.
                    </p>
                    <form id="api-key-form" class="mb-3">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary btn-lg" id="generate-key-btn">Generate API Key</button>
                    </form>
                    {# djlint:off H021 #}
                    <div id="api-key-result" class="mt-3" style="display: none;">
                        {# djlint:on #}
                        <div class="alert alert-success" role="alert">
                            <h5 class="alert-heading">Your API Key:</h5>
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <code id="api-key-display" class="fs-6"></code>
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary"
                                        id="copy-key-btn">Copy</button>
                            </div>
                            <p class="mb-0">
                                <small>Copy this key now - you won't be able to see it again!</small>
                            </p>
                        </div>
                    </div>
                    {# djlint:off H021 #}
                    <div id="api-key-error"
                         class="alert alert-danger mt-3"
                         role="alert"
                         style="display: none">
                        {# djlint:on #}
                        <span id="api-key-error-message"></span>
                    </div>
                </div>
            </div>
        </div>
        <!-- Step 2: Install Package -->
        <div class="row mb-5">
            <div class="col-lg-10 mx-auto">
                <h2 class="h3 text-dark mb-3 text-start">
                    <span class="badge bg-primary me-2">Step 2</span>
                    Install the SpectrumX Package
                </h2>
                <p class="text-dark mb-3">Install the SpectrumX Python package from PyPI using pip:</p>
                <div class="bg-dark text-light p-4 rounded mb-3">
                    <code class="text-light">pip install spectrumx</code>
                </div>
                <p class="text-muted">
                    If you're using a virtual environment (recommended), make sure it's activated before running this command.
                </p>
            </div>
        </div>
        <!-- Step 3: Download Dataset -->
        <div class="row mb-5">
            <div class="col-lg-10 mx-auto">
                <h2 class="h3 text-dark mb-3 text-start">
                    <span class="badge bg-primary me-2">Step 3</span>
                    Download the Dataset
                </h2>
                <p class="text-dark mb-3">
                    Use the following Python script to download the SpX-DAC competition dataset from the SpectrumX Data System. The script below will be automatically updated with your API key once you generate it in Step 1.
                </p>
                <div class="code-example mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0 text-dark">
                            <i class="bi bi-filetype-py"></i> Python Example
                        </h6>
                        <button class="btn btn-sm btn-outline-primary copy-code-btn"
                                data-clipboard-target="#python-code-example"
                                title="Copy to clipboard">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <pre id="python-code-example" class="bg-light p-3 rounded border" style="font-size: 0.875rem; line-height: 1.6; font-family: 'Consolas', 'Monaco', 'Courier New', monospace;"><code class="language-python">from spectrumx import Client
from spectrumx.errors import SDSError
from pathlib import Path
from uuid import UUID

# Initialize the client with your SDS host
client = Client(
    host="sds.crc.nd.edu",
    # env_file=Path(".env"),  # default, recommended to keep tokens out of version control
    env_config={"SDS_SECRET_TOKEN": "YOUR_API_KEY"},  # Replace with your API key from Step 1
)

# when in dry-run (default), no changes are made to the SDS or the local filesystem
# to enable the changes, set dry_run to False, as in:
client.dry_run = False  # ⚠️ This is required to actually download files!

# authenticate using either the token from
# the .env file or in the config passed in
client.authenticate()

# Download a dataset by UUID
try:
    # Specify the dataset UUID and local download path
    dataset_uuid_str = "{{ dataset_id }}"
    dataset_uuid = UUID(dataset_uuid_str)  # Convert to UUID object
    download_path = Path("./competition_dataset")

    print(f"Downloading dataset: {dataset_uuid_str}")
    print(f"Download path: {download_path}")

    # Download all files in the dataset
    results = client.download_dataset(
        dataset_uuid=dataset_uuid,
        to_local_path=download_path,
        skip_contents=False,  # Set to True to download only metadata
        overwrite=False,      # Set to True to overwrite existing files
        verbose=True          # Show progress bars
    )

    # Check results for any errors
    successful_downloads = [r for r in results if r]  # Result objects are truthy if successful
    failed_downloads = [r for r in results if not r]  # Result objects are falsy if failed

    print(f"Download completed!")
    print(f"Successfully downloaded: {len(successful_downloads)} files")
    print(f"Failed downloads: {len(failed_downloads)} files")

    if failed_downloads:
        print("\nFailed downloads:")
        for result in failed_downloads:
            file_info = result.error_info.get('file', {})
            file_name = file_info.get('name', 'Unknown') if isinstance(file_info, dict) else 'Unknown'
            print(f"  - {file_name}: {result.exception_or('Unknown error')}")

except SDSError as e:
    print(f"Error downloading dataset: {e}")
except Exception as e:
    print(f"Unexpected error: {e}")</code></pre>
                </div>
                <p class="text-muted">
                    This script will download the dataset to a folder called <code>competition_dataset</code> in your current directory. You can change the output directory to wherever you'd like to save the data.
                </p>
            </div>
        </div>
        <!-- Having Trouble? -->
        <div class="row mb-5">
            <div class="col-lg-10 mx-auto">
                <h2 class="h3 text-dark mb-3 text-start">Having Trouble?</h2>
                <p class="text-dark mb-4">
                    If you're experiencing issues with the Python library or need assistance, we're here to help!
                </p>
                <div class="mb-4">
                    <h4 class="h5 text-dark mb-2">Contact Support</h4>
                    <p class="text-dark mb-2">
                        For technical support or questions about accessing the dataset, please contact the SDS support team:
                    </p>
                    <p class="mb-0">
                        <a href="mailto:crc-sds-list@nd.edu" class="text-decoration-none">
                            <i class="bi bi-envelope me-2" aria-hidden="true"></i>
                            <strong>crc-sds-list@nd.edu</strong>
                        </a>
                    </p>
                </div>
                {% if s3_bucket_url %}
                    <div class="mb-4">
                        <p class="text-dark mb-2">
                            If you've exhausted other options and need a direct download link, you can expand the section below:
                        </p>
                        <button class="btn btn-outline-secondary btn-sm mb-3"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#directDownloadSection"
                                aria-expanded="false"
                                aria-controls="directDownloadSection">
                            <i class="bi bi-chevron-down me-2" aria-hidden="true"></i>
                            Show Direct Download Link
                        </button>
                        <div class="collapse" id="directDownloadSection">
                            <div class="card card-body bg-light">
                                <p class="text-dark mb-3">
                                    <strong>Note:</strong> We strongly recommend using the Python script method above, as it's the recommended way to access data through the SpectrumX Data System.
                                </p>
                                <div class="d-grid gap-2 col-md-6">
                                    <a href="{{ s3_bucket_url }}"
                                       target="_blank"
                                       rel="noopener noreferrer"
                                       class="btn btn-primary btn-lg">
                                        <i class="bi bi-download me-2" aria-hidden="true"></i>
                                        Download Here
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        <!-- Additional Resources -->
        <div class="row mb-5">
            <div class="col-lg-10 mx-auto">
                <h2 class="h3 text-dark mb-3 text-start">Additional Resources</h2>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="bi bi-book me-2 text-primary" aria-hidden="true"></i>
                        <a href="https://pypi.org/project/spectrumx/"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-decoration-none">SpectrumX Package Documentation on PyPI</a>
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-code-square me-2 text-primary" aria-hidden="true"></i>
                        <a href="{% url 'api-docs' %}" class="text-decoration-none">Gateway API Documentation</a>
                    </li>
                </ul>
            </div>
        </div>
    </main>
{% endblock body %}
{% block inline_javascript %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('api-key-form');
            const generateBtn = document.getElementById('generate-key-btn');
            const resultDiv = document.getElementById('api-key-result');
            const errorDiv = document.getElementById('api-key-error');
            const apiKeyDisplay = document.getElementById('api-key-display');
            const copyBtn = document.getElementById('copy-key-btn');
            const errorMessage = document.getElementById('api-key-error-message');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Disable button and show loading state
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating...';

                // Hide previous results
                resultDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                try {
                    const formData = new FormData(form);
                    const data = {};
                    for (const [key, value] of formData.entries()) {
                        if (value) {
                            data[key] = value;
                        }
                    }
                    const response = await window.APIClient.post('{% url "spx_dac_dataset_alt" %}', data);

                    if (response.success) {
                        const apiKey = response.api_key;
                        apiKeyDisplay.textContent = apiKey;
                        resultDiv.style.display = 'block';
                        errorDiv.style.display = 'none';

                        // Update the Python code with the API key
                        updatePythonCode(apiKey);
                    } else {
                        errorMessage.textContent = response.error || 'Failed to generate API key';
                        errorDiv.style.display = 'block';
                        resultDiv.style.display = 'none';
                    }
                } catch (error) {
                    errorMessage.textContent = error.message || 'An error occurred. Please try again.';
                    errorDiv.style.display = 'block';
                    resultDiv.style.display = 'none';
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = 'Generate API Key';
                }
            });

            copyBtn.addEventListener('click', function() {
                const apiKey = apiKeyDisplay.textContent;
                navigator.clipboard.writeText(apiKey).then(function() {
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'Copied!';
                    copyBtn.classList.add('btn-success');
                    copyBtn.classList.remove('btn-outline-secondary');
                    setTimeout(function() {
                        copyBtn.textContent = originalText;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-outline-secondary');
                    }, 2000);
                });
            });

            // Copy code button functionality
            const copyCodeBtn = document.querySelector('.copy-code-btn');
            if (copyCodeBtn) {
                copyCodeBtn.addEventListener('click', function() {
                    const codeElement = document.getElementById('python-code-example');
                    if (codeElement) {
                        const textToCopy = codeElement.textContent;
                        if (navigator.clipboard && window.isSecureContext) {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                showCopySuccess(this);
                            }).catch(() => {
                                fallbackCopyTextToClipboard(textToCopy, this);
                            });
                        } else {
                            fallbackCopyTextToClipboard(textToCopy, this);
                        }
                    }
                });
            }

            // Function to update Python code with API key
            function updatePythonCode(apiKey) {
                const codeElement = document.getElementById('python-code-example');
                if (codeElement) {
                    const currentCode = codeElement.textContent;
                    const updatedCode = currentCode.replace(
                        /env_config=\{"SDS_SECRET_TOKEN": "YOUR_API_KEY"\}/,
                        `env_config={"SDS_SECRET_TOKEN": "${apiKey}"}`
                    );
                    codeElement.textContent = updatedCode;

                    // Re-highlight if Prism is available
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightElement(codeElement);
                    }
                }
            }

            function showCopySuccess(button) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> Copied!';
                button.classList.add('btn-success');
                button.classList.remove('btn-outline-primary');

                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-primary');
                }, 2000);
            }

            function fallbackCopyTextToClipboard(text, button) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    showCopySuccess(button);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }

                document.body.removeChild(textArea);
            }
        });
    </script>
    <!-- Prism.js CSS for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
          rel="stylesheet" />
    <style>
        /* Improve code block readability */
        #python-code-example {
            font-size: 0.875rem !important;
            line-height: 1.6 !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            overflow-x: auto;
            color: #212529 !important;
        }

        #python-code-example code {
            font-size: inherit !important;
            font-family: inherit !important;
            line-height: inherit !important;
            color: inherit !important;
        }
    </style>
    <!-- Prism.js JavaScript for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script>
        // Initialize syntax highlighting after page load
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
        });
    </script>
{% endblock inline_javascript %}
