{# templates/users/file_list.html #}
{% extends "base.html" %}

{% load static %}

{% block bodyclass %}
    hero-white-page
{% endblock bodyclass %}
{% block body %}
    <!-- Add Font Awesome for sort arrows -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Add noUiSlider CSS first -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <!-- Add file_list.css for upload modal styling -->
    <link rel="stylesheet" href="{% static 'css/file_list.css' %}" />
    <!-- Add noUiSlider JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        .clear-search-hidden {
            display: none;
        }
    </style>
    <!-- CSRF Token for JavaScript -->
    {% csrf_token %}
    <!-- System-wide notifications -->
    {% if system_notifications %}
        <div class="container">
            {% for notification in system_notifications %}
                <div class="alert alert-dismissible alert-{{ notification.level }}">{{ notification.user_message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% if messages %}
        <div class="container">
            {% for message in messages %}
                <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                    {{ message }}
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="alert"
                            aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    <div id="upload-alert-container" class="container mt-3"></div>
    <div class="container-fluid px-5 pt-4">
        <!-- Headers Row -->
        <div class="row mb-1">
            <div class="col-12">
                <h1 class="mb-0 text-start">Captures</h1>
            </div>
        </div>
        <!-- Content Row -->
        <div class="row">
            <!-- Sidebar Filters -->
            <aside class="col-md-3 mb-4">
                <div class="sidebar-filters">
                    <div class="accordion" id="filtersAccordion">
                        <!-- Frequency -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFrequency">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-target="#collapseFrequency"
                                        aria-expanded="false"
                                        aria-controls="collapseFrequency">
                                    <i class="fas fa-signal me-2"></i>
                                    Center Frequency
                                </button>
                            </h2>
                            <div id="collapseFrequency" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <label for="frequency-range" class="form-label">Center Frequency Range</label>
                                    <div id="frequency-range-slider"
                                         class="mt-3 mb-3"
                                         role="slider"
                                         aria-valuemin="0"
                                         aria-valuemax="10"
                                         aria-valuenow="0,10"
                                         aria-valuetext="Frequency range from 0.0 GHz to 10.0 GHz"></div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span id="frequency-range-lower" aria-live="polite">0 GHz</span>
                                        <span id="frequency-range-upper" aria-live="polite">10 GHz</span>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <label for="centerFreqMinInput" class="form-label small">Min (GHz)</label>
                                            <input type="number"
                                                   id="centerFreqMinInput"
                                                   class="form-control form-control-sm"
                                                   min="0"
                                                   max="10"
                                                   step="0.1"
                                                   value="0"
                                                   placeholder="0" />
                                        </div>
                                        <div class="col-6">
                                            <label for="centerFreqMaxInput" class="form-label small">Max (GHz)</label>
                                            <input type="number"
                                                   id="centerFreqMaxInput"
                                                   class="form-control form-control-sm"
                                                   min="0"
                                                   max="10"
                                                   step="0.1"
                                                   value="10"
                                                   placeholder="10" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Date -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDate">
                                <button class="accordion-button collapsed"
                                        type="button"
                                        data-bs-target="#collapseDate"
                                        aria-expanded="false"
                                        aria-controls="collapseDate">
                                    <i class="fas fa-calendar me-2"></i>
                                    Date Range
                                </button>
                            </h2>
                            <div id="collapseDate" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col mb-3">
                                            <label class="form-label" for="start_date">Start Date</label>
                                            <input type="date" class="form-control" id="start_date" name="date_start" />
                                        </div>
                                        <div class="col">
                                            <label class="form-label" for="end_date">End Date</label>
                                            <input type="date" class="form-control" id="end_date" name="date_end" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Receiver -->
                        <!--
          <div class="accordion-item mb-2">
            <h2 class="accordion-header" id="headingReceiver">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReceiver" aria-expanded="false" aria-controls="collapseReceiver">
                Receiver
              </button>
            </h2>
            <div id="collapseReceiver" class="accordion-collapse collapse" aria-labelledby="headingReceiver" data-bs-parent="#filtersAccordion">
              <div class="accordion-body">
                <select class="form-select" id="receiverSelect">
                  <option value="">Select Receiver</option>
                  <option value="receiver1">Receiver 1</option>
                  <option value="receiver2">Receiver 2</option>
                  <option value="receiver3">Receiver 3</option>
                </select>
              </div>
            </div>
          </div>
-->
                        <!-- Category -->
                        <!--
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingCategory">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCategory" aria-expanded="false" aria-controls="collapseCategory">
                [Category]
              </button>
            </h2>
            <div id="collapseCategory" class="accordion-collapse collapse" aria-labelledby="headingCategory" data-bs-parent="#filtersAccordion">
              <div class="accordion-body">
                <select class="form-select" id="categorySelect">
                  <option value="">Select Category</option>
                  <option value="category1">Category 1</option>
                  <option value="category2">Category 2</option>
                  <option value="category3">Category 3</option>
                </select>
              </div>
            </div>
          </div>
          -->
                    </div>
                    <div class="d-flex gap-3 mt-4">
                        <button class="btn btn-primary flex-fill"
                                type="button"
                                id="apply-filters-btn">Apply Filters</button>
                        <button class="btn btn-secondary flex-fill"
                                type="button"
                                id="clear-filters-btn">Clear Filters</button>
                    </div>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="col-md-9 pt-0">
                <!-- Search Form -->
                <form id="search-form"
                      role="search"
                      aria-label="Search captures"
                      class="text-start mt-0">
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <label for="search-input" class="visually-hidden">Search captures</label>
                            <div class="input-group">
                                <div class="position-relative flex-grow-1">
                                    <input type="search"
                                           class="form-control pe-5"
                                           id="search-input"
                                           placeholder="Search captures..."
                                           value="{{ search }}"
                                           aria-describedby="searchHelp" />
                                    <button type="button"
                                            class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-secondary px-3 clear-search-hidden"
                                            id="clear-search-btn"
                                            aria-label="Clear search">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <button class="btn btn-primary"
                                        type="submit"
                                        id="search-btn"
                                        aria-label="Search captures">
                                    <i class="fas fa-search" aria-hidden="true"></i>
                                    <span class="d-none d-sm-inline ms-1">Search</span>
                                </button>
                                <button type="button"
                                        class="btn btn-success"
                                        data-bs-toggle="modal"
                                        data-bs-target="#uploadCaptureModal">
                                    <i class="fas fa-upload"></i> Upload Capture
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
                <!-- Loading indicator -->
                <div id="loading-indicator" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Searching captures...</p>
                </div>
                <!-- Upload Capture Modal -->
                <div class="modal fade"
                     id="uploadCaptureModal"
                     tabindex="-1"
                     aria-labelledby="uploadCaptureModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <form id="uploadCaptureForm" enctype="multipart/form-data">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="uploadCaptureModalLabel">Upload Capture(s) or Folder</h5>
                                    <button type="button"
                                            class="btn-close"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <label for="captureFileInput" class="form-label">Select files or a folder to upload</label>
                                    <input type="file"
                                           id="captureFileInput"
                                           name="files"
                                           multiple
                                           webkitdirectory
                                           directory
                                           class="form-control" />
                                    <!-- Capture Type Selection -->
                                    <div class="mt-3">
                                        <label for="captureTypeSelect" class="form-label">Capture Type</label>
                                        <select id="captureTypeSelect"
                                                name="capture_type"
                                                class="form-select"
                                                required>
                                            <option value="">Select capture type...</option>
                                            <option value="drf">DigitalRF</option>
                                            <option value="rh">RadioHound</option>
                                        </select>
                                        <div class="form-text">
                                            <strong>DigitalRF:</strong> For .h5/.hdf5 files with channel-based structure
                                            <br />
                                            <strong>RadioHound:</strong> For .rh.json files with scan group metadata
                                        </div>
                                    </div>
                                    <!-- Channel Input (shown for DigitalRF) -->
                                    <div id="channelInputGroup" class="mt-3 hidden-input-group">
                                        <label for="captureChannelsInput" class="form-label">Capture Channel Names (comma-separated)</label>
                                        <input type="text"
                                               id="captureChannelsInput"
                                               name="channels"
                                               class="form-control"
                                               placeholder="e.g. ch1,ch2,ch3" />
                                        <div class="form-text">Required for DigitalRF captures</div>
                                    </div>
                                    <!-- Scan Group Input (shown for RadioHound) -->
                                    <div id="scanGroupInputGroup" class="mt-3 hidden-input-group">
                                        <label for="captureScanGroupInput" class="form-label">Scan Group</label>
                                        <input type="text"
                                               id="captureScanGroupInput"
                                               name="scan_group"
                                               class="form-control"
                                               placeholder="Enter scan group identifier" />
                                        <div class="form-text">Required for RadioHound captures</div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">
                                        <span class="upload-text">Upload</span>
                                        <span class="upload-spinner d-none">
                                            <span class="spinner-border spinner-border-sm me-2"
                                                  role="status"
                                                  aria-hidden="true"></span>
                                            Uploading...
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- Upload Result Modal -->
                <div class="modal fade"
                     id="uploadResultModal"
                     tabindex="-1"
                     aria-labelledby="uploadResultModalLabel"
                     aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="uploadResultModalLabel">Upload Result</h5>
                                <button type="button"
                                        class="btn-close"
                                        data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="uploadResultModalBody">
                                <!-- Content will be set by JS -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Captures Table -->
                {% include "users/partials/captures_page_table.html" %}
            </main>
        </div>
    </div>
    <!-- Capture Details Modal -->
    {% include "users/partials/capture_modal.html" %}
{% endblock body %}
{% block javascript %}
    {{ block.super }}
    <script src="{% static 'js/components.js' %}"></script>
    <script src="{% static 'js/file-list.js' %}"></script>
    <script src="{% static 'js/userSearchComponent.js' %}"></script>
    <script>
        // Initialize noUiSlider for frequency range
        document.addEventListener('DOMContentLoaded', function() {
            const frequencyRangeSlider = document.getElementById('frequency-range-slider');
            if (frequencyRangeSlider) {
                noUiSlider.create(frequencyRangeSlider, {
                    start: [0, 10],
                    connect: true,
                    range: {
                        'min': 0,
                        'max': 10
                    },
                    step: 0.1,
                    format: {
                        to: function(value) {
                            return parseFloat(value).toFixed(1);
                        },
                        from: function(value) {
                            return parseFloat(value);
                        }
                    }
                });

                const lowerValue = document.getElementById('frequency-range-lower');
                const upperValue = document.getElementById('frequency-range-upper');
                const minInput = document.getElementById('centerFreqMinInput');
                const maxInput = document.getElementById('centerFreqMaxInput');

                // Track user interaction with slider
                let userInteractedWithSlider = false;

                frequencyRangeSlider.noUiSlider.on('update', function(values, handle) {
                    const value = parseFloat(values[handle]);
                    if (handle === 0) {
                        lowerValue.textContent = value + ' GHz';
                        minInput.value = value;
                        frequencyRangeSlider.setAttribute('aria-valuetext', `Frequency range from ${value} GHz to ${parseFloat(values[1])} GHz`);
                    } else {
                        upperValue.textContent = value + ' GHz';
                        maxInput.value = value;
                        frequencyRangeSlider.setAttribute('aria-valuetext', `Frequency range from ${parseFloat(values[0])} GHz to ${value} GHz`);
                    }
                });

                // Mark as interacted when user changes slider
                frequencyRangeSlider.noUiSlider.on('change', function() {
                    userInteractedWithSlider = true;
                    // Trigger the global tracking
                    if (window.initializeFrequencySlider) {
                        // Update the global interaction tracking
                        const event = new Event('change');
                        minInput.dispatchEvent(event);
                    }
                });

                // Update slider when input values change
                minInput.addEventListener('change', function() {
                    const value = parseFloat(this.value);
                    if (!isNaN(value) && value >= 0 && value <= 10) {
                        frequencyRangeSlider.noUiSlider.set([value, null]);
                    }
                });

                maxInput.addEventListener('change', function() {
                    const value = parseFloat(this.value);
                    if (!isNaN(value) && value >= 0 && value <= 10) {
                        frequencyRangeSlider.noUiSlider.set([null, value]);
                    }
                });

                // Initialize from URL parameters after slider is created
                if (window.initializeFrequencySlider) {
                    window.initializeFrequencySlider();
                }
            }
        });

        // Initialize share modals for captures
        document.addEventListener('DOMContentLoaded', function() {
            // Create a UserSearchHandler for each share modal
            document.querySelectorAll('.modal[data-item-uuid]').forEach(modal => {
                const itemUuid = modal.getAttribute('data-item-uuid');
                const itemType = modal.getAttribute('data-item-type');
                if (window.UserSearchHandler) {
                    const handler = new window.UserSearchHandler();
                    // Store the handler on the modal element
                    modal.userSearchHandler = handler;
                }

                // On modal show, set the item info and call init()
                modal.addEventListener('show.bs.modal', function() {
                    if (modal.userSearchHandler) {
                        modal.userSearchHandler.setItemInfo(itemUuid, itemType);
                        modal.userSearchHandler.init();
                    }
                });

                // On modal hide, reset all selections and entered data
                modal.addEventListener('hidden.bs.modal', function() {
                    if (modal.userSearchHandler) {
                        modal.userSearchHandler.resetAll();
                    }
                });
            });

            // Check for download alert messages
            const downloadAlert = sessionStorage.getItem('captureDownloadAlert');
            if (downloadAlert) {
                const alertData = JSON.parse(downloadAlert);
                showAlert(alertData.message, alertData.type);
                sessionStorage.removeItem('captureDownloadAlert');
            }
        });

        // Function to show alerts (same as in dataset-list.js)
        function showAlert(message, type) {
            const alertClass = type === "success" ? "alert-success" : "alert-danger";
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

            const alertContainer = document.querySelector(".container-fluid");
            if (alertContainer) {
                alertContainer.insertAdjacentHTML("afterbegin", alertHtml);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Upload Capture Modal JS
            document.getElementById('uploadCaptureForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const input = document.getElementById('captureFileInput');
                const files = input.files;
                if (files.length === 0) {
                    showUploadAlert('Please select at least one file to upload.', 'danger');
                    return;
                }

                // Show uploading state
                const uploadBtn = document.getElementById('uploadSubmitBtn');
                const uploadText = uploadBtn.querySelector('.upload-text');
                const uploadSpinner = uploadBtn.querySelector('.upload-spinner');

                uploadText.classList.add('d-none');
                uploadSpinner.classList.remove('d-none');
                uploadBtn.disabled = true;

                const formData = new FormData();
                let topLevelFolder = '';
                if (files.length > 0 && files[0].webkitRelativePath) {
                    topLevelFolder = files[0].webkitRelativePath.split('/')[0];
                }
                formData.append('top_level_folder', topLevelFolder);
                // Add channels field
                const channels = document.getElementById('captureChannelsInput').value;
                formData.append('channels', channels);
                for (let i = 0; i < files.length; i++) {
                    // Send file with its original name
                    formData.append('files', files[i]);
                    // Send the relative path as a separate field
                    formData.append('relative_paths', files[i].webkitRelativePath || files[i].name);
                }
                fetch("{% url 'users:upload_files' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Reset uploading state
                        const uploadBtn = document.getElementById('uploadSubmitBtn');
                        const uploadText = uploadBtn.querySelector('.upload-text');
                        const uploadSpinner = uploadBtn.querySelector('.upload-spinner');

                        uploadText.classList.remove('d-none');
                        uploadSpinner.classList.add('d-none');
                        uploadBtn.disabled = false;

                        // Debug logging
                        console.log('Upload response data:', data);
                        console.log('Status:', data.status);
                        console.log('Captures:', data.captures);
                        console.log('Errors:', data.errors);

                        let modalBody = document.getElementById('uploadResultModalBody');
                        let resultModalEl = document.getElementById('uploadResultModal');
                        let modal = new bootstrap.Modal(resultModalEl);

                        // Close the upload modal before showing result modal
                        const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadCaptureModal'));
                        if (uploadModal) {
                            uploadModal.hide();
                        }

                        // Add event listener for reload on close
                        resultModalEl.addEventListener('hidden.bs.modal', function handler() {
                            location.reload();
                            resultModalEl.removeEventListener('hidden.bs.modal', handler);
                        });

                        if (data.status === 'success' || data.status === 'partial_success') {
                            let msg = `<b>Upload complete!</b><br />Files uploaded: <strong>${data.total_uploaded}</strong> / ${data.total_files}`;
                            if (data.captures && data.captures.length > 0) {
                                let uuids = data.captures.map(c => `<li>${c.uuid}</li>`).join('');
                                msg += `<br />Created capture UUID(s):<ul>${uuids}</ul>`;
                            }
                            // Show capture creation errors if any (for both success and partial_success)
                            if (data.errors && data.errors.length > 0) {
                                let captureErrors = data.errors.filter(e => e.toLowerCase().includes('capture') || e.toLowerCase().includes('channel'));
                                console.log('Capture errors found:', captureErrors);
                                if (captureErrors.length > 0) {
                                    let errs = captureErrors.map(e => `<li>${e}</li>`).join('');
                                    msg += `<br /><b>Capture creation errors:</b><ul>${errs}</ul>`;
                                }
                                // Show other errors (non-capture related)
                                let otherErrors = data.errors.filter(e => !e.toLowerCase().includes('capture') && !e.toLowerCase().includes('channel'));
                                console.log('Other errors found:', otherErrors);
                                if (otherErrors.length > 0) {
                                    let errs = otherErrors.map(e => `<li>${e}</li>`).join('');
                                    msg += `<br /><b>Other errors:</b><ul>${errs}</ul>`;
                                }
                            }
                            modalBody.innerHTML = msg;
                            modal.show();
                        } else {
                            let msg = 'Upload failed: ' + (data.error || 'Unknown error');
                            if (data.errors && data.errors.length > 0) {
                                let errs = data.errors.map(e => `<li>${e}</li>`).join('');
                                msg += `<br /><b>Errors:</b><ul>${errs}</ul>`;
                            }
                            modalBody.innerHTML = msg;
                            modal.show();
                        }
                    })
                    .catch(error => {
                        // Reset uploading state
                        const uploadBtn = document.getElementById('uploadSubmitBtn');
                        const uploadText = uploadBtn.querySelector('.upload-text');
                        const uploadSpinner = uploadBtn.querySelector('.upload-spinner');

                        uploadText.classList.remove('d-none');
                        uploadSpinner.classList.add('d-none');
                        uploadBtn.disabled = false;

                        showUploadAlert('Upload failed: ' + error, 'danger');
                    });
                // Keep upload modal open during upload, it will be closed when result modal shows
            });

            function showUploadAlert(message, type) {
                // Instead of alert, show modal with message
                const modalBody = document.getElementById('uploadResultModalBody');
                modalBody.innerHTML = message;
                const resultModalEl = document.getElementById('uploadResultModal');
                const resultModal = new bootstrap.Modal(resultModalEl);

                // Close the upload modal before showing result modal
                const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadCaptureModal'));
                if (uploadModal) {
                    uploadModal.hide();
                }

                // Add event listener for reload on close
                resultModalEl.addEventListener('hidden.bs.modal', function handler() {
                    location.reload();
                    resultModalEl.removeEventListener('hidden.bs.modal', handler);
                });
                resultModal.show();
            }
        });
    </script>
    <!-- Capture Type Selection JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const captureTypeSelect = document.getElementById('captureTypeSelect');
            const channelInputGroup = document.getElementById('channelInputGroup');
            const scanGroupInputGroup = document.getElementById('scanGroupInputGroup');
            const captureChannelsInput = document.getElementById('captureChannelsInput');
            const captureScanGroupInput = document.getElementById('captureScanGroupInput');

            if (captureTypeSelect) {
                captureTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    console.log('Capture type selected:', selectedType);

                    // Hide both input groups initially
                    if (channelInputGroup) channelInputGroup.classList.add('hidden-input-group');
                    if (scanGroupInputGroup) scanGroupInputGroup.classList.add('hidden-input-group');

                    // Clear required attributes
                    if (captureChannelsInput) captureChannelsInput.removeAttribute('required');
                    if (captureScanGroupInput) captureScanGroupInput.removeAttribute('required');

                    // Show appropriate input group based on selection
                    if (selectedType === 'drf') {
                        console.log('Showing channel input for DigitalRF');
                        if (channelInputGroup) channelInputGroup.classList.remove('hidden-input-group');
                        if (captureChannelsInput) captureChannelsInput.setAttribute('required', 'required');
                    } else if (selectedType === 'rh') {
                        console.log('Showing scan group input for RadioHound');
                        if (scanGroupInputGroup) scanGroupInputGroup.classList.remove('hidden-input-group');
                        if (captureScanGroupInput) captureScanGroupInput.setAttribute('required', 'required');
                    }
                });
            }

            // Reset form when modal is hidden
            const uploadModal = document.getElementById('uploadCaptureModal');
            if (uploadModal) {
                uploadModal.addEventListener('hidden.bs.modal', function() {
                    // Reset the form
                    const form = document.getElementById('uploadCaptureForm');
                    if (form) {
                        form.reset();
                    }

                    // Hide input groups
                    if (channelInputGroup) channelInputGroup.classList.add('hidden-input-group');
                    if (scanGroupInputGroup) scanGroupInputGroup.classList.add('hidden-input-group');

                    // Clear required attributes
                    if (captureChannelsInput) captureChannelsInput.removeAttribute('required');
                    if (captureScanGroupInput) captureScanGroupInput.removeAttribute('required');
                });
            }
        });
    </script>
    <!-- This code calculates BLAKE3 hashes in the browser for file deduplication -->
    <!-- Load the WASM library first -->
    <!-- TODO: Uncomment when implementing the file upload mode multiplexer -->
    <!--
    <script src="https://cdn.jsdelivr.net/npm/hash-wasm@4.12.0/dist/blake3.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('uploadCaptureModal');
            if (!modal) {
                console.warn('uploadCaptureModal not found');
                return;
            }
            modal.addEventListener('shown.bs.modal', function() {
                var fileInput = document.getElementById('captureFileInput');
                if (!fileInput) {
                    console.warn('captureFileInput not found');
                    return;
                }
                // Remove any previous handler to avoid duplicates
                fileInput.removeEventListener('change', window._blake3CaptureHandler);

                window._blake3CaptureHandler = async function(event) {
                    console.log('File input changed!');
                    const files = event.target.files;
                    if (!files || files.length === 0) {
                        console.log("No files selected.");
                        return;
                    }
                    for (const file of files) {
                        const buffer = await file.arrayBuffer();
                        const hasher = await hashwasm.createBLAKE3(); // async!
                        hasher.init();
                        hasher.update(new Uint8Array(buffer));
                        const hashHex = hasher.digest('hex');
                        console.log(`BLAKE3 hash for ${file.name}:`, hashHex);

                        // Send checksum to Django endpoint
                        const checkData = {
                            directory: "/", // You can modify this based on your needs
                            filename: file.name,
                            checksum: hashHex
                        };

                        fetch("{% url 'users:check_file_exists' %}", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify(checkData)
                            })
                            .then(response => response.json())
                            .then(data => {
                                console.log(`File ${file.name} exists:`, data.exists);
                                console.log(`Response data:`, data.data);
                            })
                            .catch(error => {
                                console.error(`Error checking file ${file.name}:`, error);
                            });
                    }
                };
                fileInput.addEventListener('change', window._blake3CaptureHandler);
            });
        });
    </script>
-->
{% endblock javascript %}
