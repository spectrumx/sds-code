{% comment %}
Dataset List Table Component
Renders the dataset table, results count, and pagination for AJAX updates

Context:
{
    "page_obj": Page object with datasets,
    "sort_by": "name" | "created_at" | "updated_at" | "authors",
    "sort_order": "asc" | "desc"
}
{% endcomment %}
{% load tz %}
<!-- Results count display -->
{% if page_obj.object_list %}
    <div class="d-flex justify-content-end mb-3">
        <span id="results-count" aria-live="polite" class="text-muted">
            {{ page_obj.paginator.count }} dataset{{ page_obj.paginator.count|pluralize }} found
        </span>
    </div>
{% endif %}
<!-- AJAX‑Updatable Table & Pagination -->
<div id="dynamic-table-container" class="table-and-pagination">
    <div class="table-container">
        <div class="table-responsive">
            {% if not page_obj %}
                <table class="table table-striped table-hover datasets-table-fixed">
                    <caption class="visually-hidden">Your datasets list</caption>
                    <thead>
                        <tr>
                            <th scope="col" class="sortable w-35" data-sort="name">
                                Dataset Name <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable w-35" data-sort="authors">
                                Author <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable w-20" data-sort="created_at">
                                Created At <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="w-5">Actions</th>
                        </tr>
                    </thead>
                </table>
                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">No datasets yet</h4>
                    <p>
                        It looks like you don't have any datasets yet. To get started, <a href="{% url 'users:group_captures' %}" class="alert-link">create a new dataset</a> from your captures and files.
                    </p>
                </div>
            {% else %}
                <table class="table table-striped table-hover datasets-table-fixed">
                    <caption class="visually-hidden">Your datasets list</caption>
                    <thead>
                        <tr>
                            <th scope="col" class="sortable w-35" data-sort="name">
                                Dataset Name <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable w-35" data-sort="authors">
                                Author <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="sortable w-20" data-sort="created_at">
                                Created At <i class="bi bi-caret-down-fill sort-icon"></i>
                            </th>
                            <th scope="col" class="w-5">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dataset in page_obj %}
                            <tr class="clickable-row" data-dataset-uuid="{{ dataset.uuid }}">
                                <td class="text-nowrap">
                                    {% if dataset.is_public %}
                                        <i class="bi bi-globe me-1 text-primary" title="Public"></i>
                                    {% else %}
                                        <i class="bi bi-lock-fill me-1 text-danger" title="Private"></i>
                                    {% endif %}
                                    <a href="#"
                                        class="dataset-name-link"
                                        data-bs-toggle="modal"
                                        data-bs-target="#datasetDetailsModal-{{ dataset.uuid }}"
                                        data-dataset-uuid="{{ dataset.uuid }}"
                                        aria-label="View details for {{ dataset.name }}">
                                        {{ dataset.name }}
                                    </a>
                                    {% if dataset.version > 1 %}
                                    <span class="ms-2 badge bg-primary">v{{ dataset.version }}</span>
                                    {% endif %}
                                    {% if dataset.status == 'draft' %}
                                        <span class="ms-2 badge bg-secondary">{{ dataset.status_display }}</span>
                                    {% endif %}
                                    {% if dataset.is_shared_with_me %}
                                        <span class="ms-2 align-middle"
                                              data-bs-toggle="tooltip"
                                              title="Shared with you">
                                            <i class="bi bi-people-fill text-success"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-break">
                                    {% if dataset.authors %}
                                        {% for author in dataset.authors %}
                                            {% if forloop.counter <= 2 %}
                                                {% if author.name %}
                                                    {% if author.orcid_id %}
                                                        <a href="https://orcid.org/{{ author.orcid_id }}"
                                                           target="_blank"
                                                           rel="noopener noreferrer"
                                                           class="text-decoration-none"
                                                           title="View {{ author.name }}'s ORCID profile">
                                                            {{ author.name }}
                                                            <i class="bi bi-box-arrow-up-right text-muted sort-icon"></i>
                                                        </a>
                                                    {% else %}
                                                        {{ author.name }}
                                                    {% endif %}
                                                    {% if not forloop.last and forloop.counter < 2 and dataset.authors|length > 1 %},{% endif %}
                                                {% else %}
                                                    {{ author }}
                                                    {% if not forloop.last and forloop.counter < 2 and dataset.authors|length > 1 %},{% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if dataset.authors|length > 2 %}<span class="text-muted">...</span>{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">
                                    {% if dataset.dataset.created_at %}
                                        {% localtime on %}
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="bg-transparent pe-2">{{ dataset.dataset.created_at|date:"Y-m-d" }}</span>
                                            <span class="text-muted bg-transparent">{{ dataset.dataset.created_at|date:"H:i:s T" }}</span>
                                        </div>
                                        {% endlocaltime %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light dropdown-toggle btn-icon-dropdown"
                                                type="button"
                                                data-bs-toggle="dropdown"
                                                data-bs-boundary="viewport"
                                                aria-expanded="false"
                                                aria-label="Actions for {{ dataset.name }}">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if dataset.can_edit %}
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            onclick="window.location.href='{% url 'users:group_captures' %}?dataset_uuid={{ dataset.uuid }}'">
                                                        <i class="bi bi-pencil me-2"></i>Edit
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#shareModal-{{ dataset.uuid }}">
                                                        <i class="bi bi-share me-2"></i>Share
                                                    </button>
                                                </li>
                                            {% endif %}
                                            {% if dataset.is_owner or dataset.permission_level == 'co-owner' %}
                                                {% if not dataset.dataset.status == 'final' %}
                                                    <li>
                                                        <button class="dropdown-item publish-dataset-btn"
                                                                type="button"
                                                                data-dataset-uuid="{{ dataset.uuid }}">
                                                            <i class="bi bi-journal-arrow-up me-2"></i>Publish
                                                        </button>
                                                    </li>
                                                {% endif %}
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            onclick="window.DOMUtils.openModal('versioningModal-{{ dataset.uuid }}')">
                                                            <i class="bi bi-folder-symlink me-2"></i>Create New Version
                                                    </button>
                                                </li>
                                            {% endif %}
                                            <li>
                                                <button class="dropdown-item"
                                                        type="button"
                                                        onclick="window.DOMUtils.openModal('webDownloadModal-{{ dataset.uuid }}')">
                                                    <i class="bi bi-download me-2"></i>Web Download
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item"
                                                        type="button"
                                                        onclick="window.DOMUtils.openModal('sdkDownloadModal-{{ dataset.uuid }}')">
                                                    <i class="bi bi-code-slash me-2"></i>SDK Download Instructions
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        </div>
    </div>
</div>
<!-- Pagination -->
{% if page_obj.object_list %}
    <nav aria-label="Dataset pagination">
        <ul class="pagination justify-content-center" id="pagination-controls">
            {% if page_obj.paginator.num_pages > 1 %}
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ page_obj.previous_page_number }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}"
                           aria-label="Previous">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            <span aria-hidden="true">«</span>
                        </a>
                    </li>
                {% endif %}
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num|add:0 > page_obj.number|add:'-3' and num|add:0 < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link"
                               href="?page={{ num }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                           href="?page={{ page_obj.next_page_number }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}"
                           aria-label="Next">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                            <span aria-hidden="true">»</span>
                        </a>
                    </li>
                {% endif %}
            {% endif %}
        </ul>
    </nav>
{% endif %}