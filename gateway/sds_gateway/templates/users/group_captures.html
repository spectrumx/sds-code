{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block title %}
    Group Captures
{% endblock title %}
{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
          rel="stylesheet" />
{% endblock extra_css %}
{% block content %}
    <body class="{% block bodyclass %} hero-white-page {% endblock bodyclass %} mb-4 page-body"
          id="body">
        <div class="container-fluid px-5 pt-4">
            <!-- Back button -->
            <div class="mb-3">
                <a href="{% url 'users:dataset_list' %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dataset List
                </a>
            </div>
            <form method="post" id="datasetForm">
                <div class="card mb-4" id="group-captures-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            {% if existing_dataset %}
                                Edit Dataset: {{ existing_dataset.name }}
                            {% else %}
                                Create Dataset from Captures and Artifact Files
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body" id="main-card-body">
                        <!-- Step Navigation -->
                        <div id="stepTabs-container">
                            <div class="btn-group w-100{% if not existing_dataset %} btn-group-disabled{% endif %}"
                                 role="group"
                                 id="stepTabs">
                                <button type="button" class="btn btn-primary active-tab" id="step1-tab">
                                    <span class="step-number">1</span> Dataset Info
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step2-tab">
                                    <span class="step-number">2</span> Select Captures
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step3-tab">
                                    <span class="step-number">3</span> Select Artifact Files
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step4-tab">
                                    <span class="step-number">4</span>
                                    {% if existing_dataset %}
                                        Review and Update
                                    {% else %}
                                        Review and Create
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                        <div id="stepTabsContent">
                            {% csrf_token %}
                            <!-- Error alert container -->
                            <div id="formErrors"
                                 class="alert alert-danger bg-danger-subtle text-danger mb-4 form-error-container d-none">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div class="error-content"></div>
                                </div>
                            </div>
                            <!-- Hidden fields for selected items -->
                            <input type="hidden"
                                   name="selected_captures"
                                   id="selected_captures"
                                   value="" />
                            <input type="hidden" name="selected_files" id="selected_files" value="" />
<<<<<<< HEAD
                            <div class="tab-content" id="stepTabsContentInner">
                                {% include "users/partials/step_1.html" %}
                                {% include "users/partials/step_2.html" %}
                                {% include "users/partials/step_3.html" %}
                                {% include "users/partials/step_4.html" %}
=======
                            <div class="tab-content" id="stepTabsContent">
                                <!-- Step 1: Dataset Info -->
                                <div class="tab-pane fade show active" id="step1">
                                    <div class="row g-4">
                                        <div class="col-md-2"></div>
                                        <div class="col-md-8">
                                            <div class="row g-6">
                                                <div class="col-md-4">
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.name.id_for_label }}" class="form-label">
                                                            {{ dataset_form.name.label }}
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        {{ dataset_form.name }}
                                                    </div>
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.author.id_for_label }}" class="form-label">
                                                            {{ dataset_form.author.label }}
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        {{ dataset_form.author }}
                                                    </div>
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.keywords.id_for_label }}" class="form-label">
                                                            {{ dataset_form.keywords.label }}
                                                            <span class="text-muted">(Optional)</span>
                                                        </label>
                                                        {{ dataset_form.keywords }}
                                                        {% if dataset_form.keywords.help_text %}<div class="form-text">{{ dataset_form.keywords.help_text }}</div>{% endif %}
                                                    </div>
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.status.id_for_label }}" class="form-label">
                                                            {{ dataset_form.status.label }}
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        {{ dataset_form.status }}
                                                        {% if dataset_form.status.help_text %}<div class="form-text">{{ dataset_form.status.help_text }}</div>{% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.description.id_for_label }}" class="form-label">
                                                            {{ dataset_form.description.label }}
                                                            <span class="text-muted">(Optional)</span>
                                                        </label>
                                                        {{ dataset_form.description }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-muted small mt-3">
                                                <span class="text-danger">*</span> Required fields
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Step 2: Captures Selection -->
                                <div class="tab-pane fade" id="step2">
                                    <div class="row g-4">
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">
                                                        Select Captures for Dataset: "<span class="dataset-name-display">Untitled Dataset</span>"
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3" id="captures-search-form">
                                                        <div class="row g-3">
                                                            {% for field in capture_search_form %}
                                                                <div class="col-md-3">
                                                                    <div class="form-group">
                                                                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                                                        {{ field }}
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                            <div class="col-12 d-flex gap-2">
                                                                <button type="button"
                                                                        class="btn btn-primary btn-sm btn-fixed-width"
                                                                        id="search-captures">Search Captures</button>
                                                                <button type="button"
                                                                        class="btn btn-secondary btn-sm btn-fixed-width"
                                                                        id="clear-captures-search">Clear</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% include "users/partials/captures_table.html" %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Step 3: Files Selection -->
                                <div class="tab-pane fade" id="step3">
                                    <div class="row g-4">
                                        <div class="col-md-1"></div>
                                        <div class="col-md-10">{% include "users/partials/file_browser.html" %}</div>
                                    </div>
                                </div>
                                <!-- Step 4: Review and Create -->
                                <div class="tab-pane fade" id="step4">
                                    <div class="row g-4">{% include "users/partials/review_create_dataset.html" %}</div>
                                </div>
>>>>>>> 283791a (Added keyword model and frontend view)
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" id="prevStep">Previous</button>
                            <button type="button" class="btn btn-primary me-2" id="nextStep">Next</button>
                            <button type="submit" class="btn btn-success" id="submitForm">
                                {% if existing_dataset %}
                                    Update Dataset
                                {% else %}
                                    Create Dataset
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </body>
    {% block extra_js %}
        <!-- Dataset components -->
        <script src="{% static 'js/dataset/DatasetModeManager.js' %}"></script>
        <script src="{% static 'js/dataset/DatasetCreationHandler.js' %}"></script>
        <script src="{% static 'js/dataset/DatasetEditingHandler.js' %}"></script>
        <!-- Search components -->
        <script src="{% static 'js/search/AssetSearchHandler.js' %}"></script>
        <!-- External JavaScript files -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'webpack_bundles/js/vendors.js' %}"></script>
        <script src="{% static 'webpack_bundles/js/project.js' %}"></script>
        {# djlint:off #}
        <script>
            document.addEventListener('DOMContentLoaded', () => {
<<<<<<< HEAD
                // Initialize the dataset mode manager
                const datasetModeManager = new DatasetModeManager({
                    isEditMode: {{ existing_dataset|yesno:"true,false" }},
                    datasetUuid: "{{ existing_dataset.uuid|default:'' }}",
                    userPermissionLevel: '{{ permission_level }}',
                    currentUserId: {{ request.user.id }},
                    isOwner: {% if is_owner %}true{% else %}false{% endif %},
                    datasetPermissions: {
                        canEditMetadata: {% if can_edit_metadata %}true{% else %}false{% endif %},
                        canAddAssets: {% if can_add_assets %}true{% else %}false{% endif %},
                        canRemoveAnyAssets: {% if can_remove_assets %}true{% else %}false{% endif %},
                        canRemoveOwnAssets: true,
                        canShare: {% if can_edit_metadata %}true{% else %}false{% endif %},
                        canDownload: true,
                        canDelete: {% if is_owner %}true{% else %}false{% endif %}
                    },
                    initialCaptures: {{ selected_captures|safe }},
                    initialFiles: {{ selected_files|safe }},
                    initialCaptureDetails: {{ selected_captures_details_json|safe }},
                    initialFileDetails: {{ selected_files_details_json|safe }},
                    initialAuthors: {{ existing_dataset.authors|safe|default:"[]" }}
=======
                // ========== Keyword Autocomplete ==========
                class KeywordAutocomplete {
                    constructor(inputElement, apiUrl = '/users/api/keyword-autocomplete/') {
                        this.input = inputElement;
                        this.apiUrl = apiUrl;
                        this.minChars = 1;
                        this.debounceMs = 300;
                        this.debounceTimer = null;
                        this.suggestionsContainer = null;
                        this.currentFocus = -1;
                        this.init();
                    }

                    init() {
                        this.createSuggestionsContainer();
                        this.input.addEventListener('input', this.handleInput.bind(this));
                        this.input.addEventListener('keydown', this.handleKeydown.bind(this));
                        this.input.addEventListener('blur', this.handleBlur.bind(this));
                        document.addEventListener('click', (e) => {
                            if (e.target !== this.input) this.closeSuggestions();
                        });
                    }

                    createSuggestionsContainer() {
                        this.suggestionsContainer = document.createElement('div');
                        this.suggestionsContainer.className = 'keyword-autocomplete-suggestions';
                        this.suggestionsContainer.style.cssText = 'position: absolute; border: 1px solid #ddd; border-top: none; z-index: 1000; background: white; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;';
                        this.input.parentNode.style.position = 'relative';
                        this.input.parentNode.appendChild(this.suggestionsContainer);
                    }

                    handleInput() {
                        const value = this.getCurrentWord();
                        if (this.debounceTimer) clearTimeout(this.debounceTimer);
                        if (value.length < this.minChars) {
                            this.closeSuggestions();
                            return;
                        }
                        this.debounceTimer = setTimeout(() => this.fetchSuggestions(value), this.debounceMs);
                    }

                    getCurrentWord() {
                        const fullValue = this.input.value;
                        const cursorPos = this.input.selectionStart;
                        const textBeforeCursor = fullValue.substring(0, cursorPos);
                        const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
                        return lastCommaIndex >= 0 ? textBeforeCursor.substring(lastCommaIndex + 1).trim() : textBeforeCursor.trim();
                    }

                    async fetchSuggestions(query) {
                        try {
                            const response = await fetch(`${this.apiUrl}?q=${encodeURIComponent(query)}`);
                            const data = await response.json();
                            if (data.suggestions && data.suggestions.length > 0) {
                                this.showSuggestions(data.suggestions);
                            } else {
                                this.closeSuggestions();
                            }
                        } catch (error) {
                            console.error('Error fetching keyword suggestions:', error);
                            this.closeSuggestions();
                        }
                    }

                    showSuggestions(suggestions) {
                        this.suggestionsContainer.innerHTML = '';
                        this.currentFocus = -1;
                        suggestions.forEach((suggestion) => {
                            const item = document.createElement('div');
                            item.className = 'keyword-autocomplete-item';
                            item.textContent = suggestion;
                            item.style.cssText = 'padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0;';
                            item.addEventListener('mouseenter', () => {
                                this.removeActiveClass();
                                item.classList.add('keyword-autocomplete-active');
                                item.style.backgroundColor = '#e9ecef';
                            });
                            item.addEventListener('mouseleave', () => {
                                item.classList.remove('keyword-autocomplete-active');
                                item.style.backgroundColor = '';
                            });
                            item.addEventListener('mousedown', (e) => {
                                e.preventDefault();
                                this.selectSuggestion(suggestion);
                            });
                            this.suggestionsContainer.appendChild(item);
                        });
                        const rect = this.input.getBoundingClientRect();
                        this.suggestionsContainer.style.width = `${rect.width}px`;
                        this.suggestionsContainer.style.top = `${this.input.offsetTop + this.input.offsetHeight}px`;
                        this.suggestionsContainer.style.left = `${this.input.offsetLeft}px`;
                        this.suggestionsContainer.style.display = 'block';
                    }

                    selectSuggestion(suggestion) {
                        const fullValue = this.input.value;
                        const cursorPos = this.input.selectionStart;
                        const textBeforeCursor = fullValue.substring(0, cursorPos);
                        const textAfterCursor = fullValue.substring(cursorPos);
                        const lastCommaIndex = textBeforeCursor.lastIndexOf(',');
                        let newValue;
                        if (lastCommaIndex >= 0) {
                            const beforeComma = fullValue.substring(0, lastCommaIndex + 1);
                            newValue = beforeComma + ' ' + suggestion + textAfterCursor;
                        } else {
                            newValue = suggestion + textAfterCursor;
                        }
                        this.input.value = newValue;
                        this.input.focus();
                        const newCursorPos = lastCommaIndex >= 0 ? lastCommaIndex + 2 + suggestion.length : suggestion.length;
                        this.input.setSelectionRange(newCursorPos, newCursorPos);
                        this.closeSuggestions();
                    }

                    handleKeydown(e) {
                        const items = this.suggestionsContainer.querySelectorAll('.keyword-autocomplete-item');
                        if (!items.length) return;
                        if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            this.currentFocus++;
                            if (this.currentFocus >= items.length) this.currentFocus = 0;
                            this.addActiveClass(items);
                        } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            this.currentFocus--;
                            if (this.currentFocus < 0) this.currentFocus = items.length - 1;
                            this.addActiveClass(items);
                        } else if (e.key === 'Enter') {
                            if (this.currentFocus > -1 && items[this.currentFocus]) {
                                e.preventDefault();
                                items[this.currentFocus].click();
                            }
                        } else if (e.key === 'Escape') {
                            this.closeSuggestions();
                        }
                    }

                    addActiveClass(items) {
                        this.removeActiveClass();
                        if (this.currentFocus >= items.length) this.currentFocus = 0;
                        if (this.currentFocus < 0) this.currentFocus = items.length - 1;
                        items[this.currentFocus].classList.add('keyword-autocomplete-active');
                        items[this.currentFocus].style.backgroundColor = '#e9ecef';
                        items[this.currentFocus].scrollIntoView({ block: 'nearest' });
                    }

                    removeActiveClass() {
                        const items = this.suggestionsContainer.querySelectorAll('.keyword-autocomplete-item');
                        items.forEach(item => {
                            item.classList.remove('keyword-autocomplete-active');
                            item.style.backgroundColor = '';
                        });
                    }

                    handleBlur() {
                        setTimeout(() => this.closeSuggestions(), 200);
                    }

                    closeSuggestions() {
                        this.suggestionsContainer.style.display = 'none';
                        this.suggestionsContainer.innerHTML = '';
                        this.currentFocus = -1;
                    }
                }

                // Initialize keyword autocomplete
                const keywordInput = document.getElementById('id_keywords');
                if (keywordInput) {
                    new KeywordAutocomplete(keywordInput);
                }

                // Update dataset name display
                function updateDatasetNameDisplay() {
                    const nameInput = document.getElementById('id_name');
                    const displaySpan = document.querySelector('.dataset-name-display');
                    if (nameInput && displaySpan) {
                        const name = nameInput.value.trim() || 'Untitled Dataset';
                        displaySpan.textContent = name;
                    }
                }

                // Update on input change
                const nameInput = document.getElementById('id_name');
                if (nameInput) {
                    nameInput.addEventListener('input', updateDatasetNameDisplay);
                    // Update immediately if there's an existing value
                    updateDatasetNameDisplay();
                }

                // Basic step navigation fallback
                const nextBtn = document.getElementById('nextStep');
                const prevBtn = document.getElementById('prevStep');
                const submitBtn = document.getElementById('submitForm');
                const stepTabs = document.querySelectorAll('#stepTabs button');
                const tabPanes = document.querySelectorAll('.tab-pane');

                let currentStep = 0;

                function showStep(stepIndex) {
                    // Hide all tab panes
                    tabPanes.forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });

                    // Remove active classes from tabs
                    stepTabs.forEach(tab => {
                        tab.classList.remove('btn-primary', 'active-tab');
                        tab.classList.add('btn-outline-primary', 'inactive-tab');
                    });

                    // Show current step
                    if (tabPanes[stepIndex]) {
                        tabPanes[stepIndex].classList.add('show', 'active');
                    }

                    if (stepTabs[stepIndex]) {
                        stepTabs[stepIndex].classList.remove('btn-outline-primary', 'inactive-tab');
                        stepTabs[stepIndex].classList.add('btn-primary', 'active-tab');
                    }

                    // Update button visibility
                    prevBtn.style.display = stepIndex === 0 ? 'none' : 'inline-block';
                    nextBtn.style.display = stepIndex === tabPanes.length - 1 ? 'none' : 'inline-block';
                    // Submit button should always be visible
                    submitBtn.style.display = 'inline-block';
                }

                // Next button
                nextBtn.addEventListener('click', () => {
                    if (currentStep < tabPanes.length - 1) {
                        currentStep++;
                        showStep(currentStep);
                    }
>>>>>>> 283791a (Added keyword model and frontend view)
                });

                // Make it globally available
                window.datasetModeManager = datasetModeManager;

                // Show the body after basic initialization
                document.getElementById('body').classList.remove('d-none');
            });

</script>
        {# djlint:on #}
    {% endblock extra_js %}
{% endblock content %}
