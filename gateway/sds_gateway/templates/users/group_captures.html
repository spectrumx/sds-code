{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block title %}
    Group Captures
{% endblock title %}
{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
          rel="stylesheet" />
{% endblock extra_css %}
{% block content %}
    <body class="{% block bodyclass %} hero-white-page {% endblock bodyclass %} mb-4 page-body"
          id="body">
        <div class="container-fluid px-5 pt-4">
            <!-- Back button -->
            <div class="mb-3">
                <a href="{% url 'users:dataset_list' %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dataset List
                </a>
            </div>
            <form method="post" id="datasetForm">
                <div class="card mb-4" id="group-captures-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            {% if existing_dataset %}
                                Edit Dataset: {{ existing_dataset.name }}
                            {% else %}
                                Create Dataset from Captures and Artifact Files
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body" id="main-card-body">
                        <!-- Step Navigation -->
                        <div id="stepTabs-container">
                            <div class="btn-group w-100{% if not existing_dataset %} btn-group-disabled{% endif %}" role="group" id="stepTabs">
                                <button type="button" class="btn btn-primary active-tab" id="step1-tab">
                                    <span class="step-number">1</span> Dataset Info
                                </button>
                                <button type="button" class="btn btn-outline-primary inactive-tab" id="step2-tab">
                                    <span class="step-number">2</span> Select Captures
                                </button>
                                <button type="button" class="btn btn-outline-primary inactive-tab" id="step3-tab">
                                    <span class="step-number">3</span> Select Artifact Files
                                </button>
                                <button type="button" class="btn btn-outline-primary inactive-tab" id="step4-tab">
                                    <span class="step-number">4</span> {% if existing_dataset %}Review and Update{% else %}Review and Create{% endif %}
                                </button>
                            </div>
                        </div>
                        <div id="stepTabsContent">
                            {% csrf_token %}
                            <!-- Error alert container -->
                            <div id="formErrors"
                                 class="alert alert-danger bg-danger-subtle text-danger mb-4 form-error-container d-none">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div class="error-content"></div>
                                </div>
                            </div>
                            <!-- Hidden fields for selected items -->
                            <input type="hidden"
                                   name="selected_captures"
                                   id="selected_captures"
                                   value="" />
                            <input type="hidden" name="selected_files" id="selected_files" value="" />
                            <div class="tab-content" id="stepTabsContent">
                                <!-- Step 1: Dataset Info -->
                                <div class="tab-pane fade show active" id="step1">
                                    <div class="row g-4">
                                        <div class="col-md-2"></div>
                                        <div class="col-md-8">
                                            <div class="row g-6">
                                                <div class="col-md-4">
                                                    {% if can_edit_metadata %}
                                                        <div class="form-group mt-4">
                                                            <label for="{{ dataset_form.name.id_for_label }}" class="form-label">
                                                                {{ dataset_form.name.label }}
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            {{ dataset_form.name }}
                                                        </div>
                                                        <div class="form-group mt-4">
                                                            <label for="{{ dataset_form.status.id_for_label }}" class="form-label">
                                                                {{ dataset_form.status.label }}
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            {{ dataset_form.status }}
                                                            {% if dataset_form.status.help_text %}<div class="form-text">{{ dataset_form.status.help_text }}</div>{% endif %}
                                                        </div>
                                                    {% else %}
                                                        <div class="form-group mt-4">
                                                            <label class="form-label">Dataset Name</label>
                                                            <input type="text" class="form-control" value="{{ existing_dataset.name }}" readonly>
                                                        </div>
                                                        <div class="form-group mt-4">
                                                            <label class="form-label">Status</label>
                                                            <input type="text" class="form-control" value="{{ existing_dataset.get_status_display }}" readonly>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-8">
                                                    {% if can_edit_metadata %}
                                                        <div class="form-group mt-4">
                                                            <label for="{{ dataset_form.description.id_for_label }}" class="form-label">
                                                                {{ dataset_form.description.label }}
                                                                <span class="text-muted">(Optional)</span>
                                                            </label>
                                                            {{ dataset_form.description }}
                                                        </div>
                                                    {% else %}
                                                        <div class="form-group mt-4">
                                                            <label class="form-label">Description</label>
                                                            <textarea class="form-control" rows="3" readonly>{{ existing_dataset.description|default:"No description provided." }}</textarea>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <!-- Authors Section -->
                                            <div class="row g-6">
                                                <div class="col-12">
                                                    {% if can_edit_metadata %}
                                                        <div class="form-group">
                                                            <label class="form-label">
                                                                Authors
                                                                <span class="text-danger">*</span>
                                                            </label>
                                                            <div id="authors-container">
                                                                <div class="authors-list">
                                                                    <!-- Authors will be dynamically added here -->
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-author-btn">
                                                                    <i class="bi bi-plus"></i> Add Author
                                                                </button>
                                                            </div>
                                                            {{ dataset_form.authors }}
                                                        </div>
                                                    {% else %}
                                                        <div class="form-group">
                                                            <label class="form-label">Authors</label>
                                                            <div class="readonly-authors">
                                                                {% for author in existing_dataset.authors %}
                                                                    <div class="author-item mb-2 p-2 border rounded bg-light">
                                                                        <div class="d-flex justify-content-between align-items-start">
                                                                            <div class="flex-grow-1">
                                                                                <strong>{{ author.name|default:"Unnamed Author" }}</strong>
                                                                                {% if author.orcid_id %}
                                                                                    <br><small class="text-muted">ORCID: <a href="https://orcid.org/{{ author.orcid_id }}" target="_blank" class="text-decoration-none">{{ author.orcid_id }}</a></small>
                                                                                {% endif %}
                                                                            </div>
                                                                            <div>
                                                                                {% if forloop.first %}<span class="badge bg-primary">Primary</span>{% endif %}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="text-muted small mt-3">
                                                <span class="text-danger">*</span> Required fields
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>
                                <!-- Step 2: Captures Selection -->
                                <div class="tab-pane fade" id="step2">
                                    {% if existing_dataset %}
                                        {% include "users/partials/captures_management.html" %}
                                    {% else %}
                                        <div class="row g-4">
                                            <div class="col-md-8">
                                                <div class="card">
                                                    <div class="card-header">
                                                        <h5 class="mb-0">
                                                            Select Captures for Dataset: "<span class="dataset-name-display">Untitled Dataset</span>"
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3" id="captures-search-form">
                                                            <div class="row g-3">
                                                                {% for field in capture_search_form %}
                                                                    <div class="col-md-3">
                                                                        <div class="form-group">
                                                                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                                                            {{ field }}
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                                <div class="col-12 d-flex gap-2">
                                                                    <button type="button"
                                                                            class="btn btn-primary btn-sm btn-fixed-width"
                                                                            id="search-captures">Search Captures</button>
                                                                    <button type="button"
                                                                            class="btn btn-secondary btn-sm btn-fixed-width"
                                                                            id="clear-captures-search">Clear</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% include "users/partials/captures_table.html" %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Step 3: Files Selection -->
                                <div class="tab-pane fade" id="step3">
                                    {% if existing_dataset %}
                                        {% include "users/partials/files_management.html" %}
                                    {% else %}
                                        <div class="row g-4">
                                            <div class="col-md-1"></div>
                                            <div class="col-md-10">{% include "users/partials/file_browser.html" %}</div>
                                        </div>
                                    {% endif %}
                                </div>
                                <!-- Step 4: Review and Create -->
                                <div class="tab-pane fade" id="step4">
                                    <div class="row g-4">{% include "users/partials/review_create_dataset.html" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" id="prevStep">Previous</button>
                            <button type="button" class="btn btn-primary me-2" id="nextStep">Next</button>
                            <button type="submit" class="btn btn-success" id="submitForm">
                                {% if existing_dataset %}
                                    Update Dataset
                                {% else %}
                                    Create Dataset
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </body>
    {% block extra_js %}
        <!-- Direct include of captureGroupingComponents.js as fallback -->
        <script src="{% static 'js/captureGroupingComponents.js' %}"></script>
        {% if existing_dataset %}
            <script src="{% static 'js/datasetEditingComponents.js' %}"></script>
        {% endif %}
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'webpack_bundles/js/vendors.js' %}"></script>
        <script src="{% static 'webpack_bundles/js/project.js' %}"></script>
        {# djlint:off #}
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Update dataset name display
                function updateDatasetNameDisplay() {
                    const nameInput = document.getElementById('id_name');
                    const displaySpan = document.querySelector('.dataset-name-display');
                    if (nameInput && displaySpan) {
                        const name = nameInput.value.trim() || 'Untitled Dataset';
                        displaySpan.textContent = name;
                    }
                }

                // Update on input change
                const nameInput = document.getElementById('id_name');
                if (nameInput) {
                    nameInput.addEventListener('input', updateDatasetNameDisplay);
                    // Update immediately if there's an existing value
                    updateDatasetNameDisplay();
                }

                // Initialize form handler immediately - no fallback needed
                // Get initial selected captures and files
                const initialCaptures = {{ selected_captures|safe }};
                const initialFiles = {{ selected_files|safe }};

                // Get initial capture details from Django context
                const initialCaptureDetails = {{ selected_captures_details_json|safe }};
                const initialFileDetails = {{ selected_files_details_json|safe }};

                {% if existing_dataset %}
                    // Initialize dataset editing handler
                    window.datasetEditingHandler = new DatasetEditingHandler({
                        datasetUuid: '{{ existing_dataset.uuid }}',
                        permissionLevel: '{{ permission_level }}',
                        canEditMetadata: {% if can_edit_metadata %}true{% else %}false{% endif %},
                        canAddAssets: {% if can_add_assets %}true{% else %}false{% endif %},
                        canRemoveAssets: {% if can_remove_assets %}true{% else %}false{% endif %},
                        currentUserId: {{ request.user.id }},
                        initialCaptures: Object.values(initialCaptureDetails),
                        initialFiles: Object.values(initialFileDetails),
                    });
                {% endif %}

                // Global variables for updateReviewDatasetDisplay function
                let globalAuthors = [];
                let globalOriginalAuthors = [];
                let globalAuthorChanges = { added: [], removed: [], modified: [] };
                let globalDatasetChanges = {
                    name: { old: '', new: '', changed: false },
                    status: { old: '', new: '', changed: false },
                    description: { old: '', new: '', changed: false }
                };
                
                // Get original values for edit mode
                {% if existing_dataset %}
                    globalDatasetChanges.name.old = '{{ existing_dataset.name|escapejs }}';
                    globalDatasetChanges.status.old = '{{ existing_dataset.get_status_display|escapejs }}';
                    globalDatasetChanges.description.old = '{{ existing_dataset.description|default:""|escapejs }}';
                {% endif %}
                
                // Make updateReviewDatasetDisplay available globally BEFORE FormHandler initialization
                window.updateReviewDatasetDisplay = function() {
                    console.log('=== updateReviewDatasetDisplay called ===');
                    console.log('can_edit_metadata:', {% if can_edit_metadata %}true{% else %}false{% endif %});
                    
                    // Update current values display
                    const nameDisplay = document.querySelector("#step4 .dataset-name");
                    const statusDisplay = document.querySelector("#step4 .dataset-status");
                    const descriptionDisplay = document.querySelector("#step4 .dataset-description");
                    
                    if (nameDisplay) {
                        let nameValue = '';
                        {% if can_edit_metadata %}
                            // Co-owner/owner: get value from editable form field
                            const nameField = document.getElementById('id_name');
                            nameValue = nameField ? nameField.value : '';
                        {% else %}
                            // Contributor: get value from readonly input or template
                            const readonlyNameInput = document.querySelector('input[value="{{ existing_dataset.name|escapejs }}"]');
                            if (readonlyNameInput) {
                                nameValue = readonlyNameInput.value;
                            } else {
                                nameValue = '{{ existing_dataset.name|escapejs }}';
                            }
                        {% endif %}
                        nameDisplay.textContent = nameValue;
                    }
                    
                    if (statusDisplay) {
                        let statusValue = '';
                        {% if can_edit_metadata %}
                            // Co-owner/owner: get value from editable form field
                            const statusField = document.getElementById('id_status');
                            if (statusField) {
                                const selectedOption = statusField.options[statusField.selectedIndex];
                                statusValue = selectedOption ? selectedOption.text : '';
                            }
                        {% else %}
                            // Contributor: get value from readonly input or template
                            const readonlyStatusInput = document.querySelector('input[value="{{ existing_dataset.get_status_display|escapejs }}"]');
                            if (readonlyStatusInput) {
                                statusValue = readonlyStatusInput.value;
                            } else {
                                statusValue = '{{ existing_dataset.get_status_display|escapejs }}';
                            }
                        {% endif %}
                        statusDisplay.textContent = statusValue;
                    }
                    
                    if (descriptionDisplay) {
                        let descriptionValue = '';
                        {% if can_edit_metadata %}
                            // Co-owner/owner: get value from editable form field
                            const descriptionField = document.getElementById('id_description');
                            descriptionValue = descriptionField ? descriptionField.value : '';
                        {% else %}
                            // Contributor: get value from readonly input or template
                            const readonlyDescriptionInput = document.querySelector('input[value="{{ existing_dataset.description|escapejs }}"]');
                            if (readonlyDescriptionInput) {
                                descriptionValue = readonlyDescriptionInput.value;
                            } else {
                                descriptionValue = '{{ existing_dataset.description|escapejs }}';
                            }
                        {% endif %}
                        descriptionDisplay.textContent = descriptionValue || 'No description provided.';
                    }
                    
                    // Update authors display
                    {% if not existing_dataset %}
                        // In create mode, just show the current authors (no change tracking)
                        const authorsDisplay = document.querySelector("#step4 .dataset-authors");
                        if (authorsDisplay) {
                            authorsDisplay.innerHTML = '';
                            globalAuthors.forEach((author, index) => {
                                const authorDiv = document.createElement('div');
                                authorDiv.className = 'author-item mb-2 p-2 border rounded bg-light';
                                
                                const name = typeof author === 'string' ? author : author.name || 'Unnamed Author';
                                const orcid = typeof author === 'string' ? '' : author.orcid_id || '';
                                
                                authorDiv.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong>${name}</strong>
                                            ${orcid ? `<br><small class="text-muted">ORCID: <a href="https://orcid.org/${orcid}" target="_blank" class="text-decoration-none">${orcid}</a></small>` : ''}
                                        </div>
                                        <div>
                                            ${index === 0 ? '<span class="badge bg-primary">Primary</span>' : ''}
                                        </div>
                                    </div>
                                `;
                                authorsDisplay.appendChild(authorDiv);
                            });
                        }
                        return;
                    {% endif %}
                    
                    {% if existing_dataset %}
                        // In edit mode, show changes in the change list
                        const changeList = document.querySelector("#step4 .dataset-authors-change-list");
                        if (changeList) {
                            changeList.innerHTML = '';
                            
                            // Show added authors
                            if (globalAuthorChanges.added.length > 0) {
                                const addedDiv = document.createElement('div');
                                addedDiv.className = 'mb-2';
                                addedDiv.innerHTML = '<strong class="text-success">Added Authors:</strong>';
                                changeList.appendChild(addedDiv);
                                
                                globalAuthorChanges.added.forEach(index => {
                                    if (globalAuthors[index]) {
                                        const authorDiv = document.createElement('div');
                                        authorDiv.className = 'author-item mb-1 p-2 border rounded bg-light border-success';
                                        
                                        const name = typeof globalAuthors[index] === 'string' ? globalAuthors[index] : globalAuthors[index].name || 'Unnamed Author';
                                        const orcid = typeof globalAuthors[index] === 'string' ? '' : globalAuthors[index].orcid_id || '';
                                        
                                        authorDiv.innerHTML = `
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>${name}</strong>
                                                    ${orcid ? `<br><small class="text-muted">ORCID: <a href="https://orcid.org/${orcid}" target="_blank" class="text-decoration-none">${orcid}</a></small>` : ''}
                                                </div>
                                                <div>
                                                    <span class="badge bg-success">Added</span>
                                                </div>
                                            </div>
                                        `;
                                        changeList.appendChild(authorDiv);
                                    }
                                });
                            }
                            
                            // Show removed authors
                            if (globalAuthorChanges.removed.length > 0) {
                                const removedDiv = document.createElement('div');
                                removedDiv.className = 'mb-2';
                                removedDiv.innerHTML = '<strong class="text-danger">Removed Authors:</strong>';
                                changeList.appendChild(removedDiv);
                                
                                globalAuthorChanges.removed.forEach(index => {
                                    if (globalOriginalAuthors[index]) {
                                        const authorDiv = document.createElement('div');
                                        authorDiv.className = 'author-item mb-1 p-2 border rounded bg-light border-danger';
                                        
                                        const name = typeof globalOriginalAuthors[index] === 'string' ? globalOriginalAuthors[index] : globalOriginalAuthors[index].name || 'Unnamed Author';
                                        const orcid = typeof globalOriginalAuthors[index] === 'string' ? '' : globalOriginalAuthors[index].orcid_id || '';
                                        
                                        authorDiv.innerHTML = `
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>${name}</strong>
                                                    ${orcid ? `<br><small class="text-muted">ORCID: <a href="https://orcid.org/${orcid}" target="_blank" class="text-decoration-none">${orcid}</a></small>` : ''}
                                                </div>
                                                <div>
                                                    <span class="badge bg-danger">Removed</span>
                                                </div>
                                            </div>
                                        `;
                                        changeList.appendChild(authorDiv);
                                    }
                                });
                            }
                            
                            // Show modified authors
                            if (globalAuthorChanges.modified.length > 0) {
                                const modifiedDiv = document.createElement('div');
                                modifiedDiv.className = 'mb-2';
                                modifiedDiv.innerHTML = '<strong class="text-warning">Modified Authors:</strong>';
                                changeList.appendChild(modifiedDiv);
                                
                                globalAuthorChanges.modified.forEach(index => {
                                    if (globalAuthors[index] && globalOriginalAuthors[index]) {
                                        const authorDiv = document.createElement('div');
                                        authorDiv.className = 'author-item mb-1 p-2 border rounded bg-light border-warning';
                                        
                                        const name = typeof globalAuthors[index] === 'string' ? globalAuthors[index] : globalAuthors[index].name || 'Unnamed Author';
                                        const orcid = typeof globalAuthors[index] === 'string' ? '' : globalAuthors[index].orcid_id || '';
                                        
                                        authorDiv.innerHTML = `
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>${name}</strong>
                                                    ${orcid ? `<br><small class="text-muted">ORCID: <a href="https://orcid.org/${orcid}" target="_blank" class="text-decoration-none">${orcid}</a></small>` : ''}
                                                </div>
                                                <div>
                                                    <span class="badge bg-warning">Modified</span>
                                                </div>
                                            </div>
                                        `;
                                        changeList.appendChild(authorDiv);
                                    }
                                });
                            }
                            
                            // Show current authors (unchanged)
                            const currentAuthorsDisplay = document.querySelector("#step4 .dataset-authors-current");
                            if (currentAuthorsDisplay) {
                                currentAuthorsDisplay.innerHTML = '';
                                
                                // Show authors that are not in any change category
                                const allChangedIndices = new Set([
                                    ...globalAuthorChanges.added,
                                    ...globalAuthorChanges.removed,
                                    ...globalAuthorChanges.modified
                                ]);
                                
                                globalAuthors.forEach((author, index) => {
                                    if (!allChangedIndices.has(index)) {
                                        const authorDiv = document.createElement('div');
                                        authorDiv.className = 'author-item mb-2 p-2 border rounded bg-light';
                                        
                                        const name = typeof author === 'string' ? author : author.name || 'Unnamed Author';
                                        const orcid = typeof author === 'string' ? '' : author.orcid_id || '';
                                        
                                        authorDiv.innerHTML = `
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <strong>${name}</strong>
                                                    ${orcid ? `<br><small class="text-muted">ORCID: <a href="https://orcid.org/${orcid}" target="_blank" class="text-decoration-none">${orcid}</a></small>` : ''}
                                                </div>
                                                <div>
                                                    ${index === 0 ? '<span class="badge bg-primary">Primary</span>' : ''}
                                                </div>
                                            </div>
                                        `;
                                        currentAuthorsDisplay.appendChild(authorDiv);
                                    }
                                });
                            }
                        }
                        
                        // Update dataset changes display
                        const datasetChangesList = document.querySelector("#step4 .dataset-changes-list");
                        if (datasetChangesList) {
                            datasetChangesList.innerHTML = '';
                            
                            // Show name changes
                            if (globalDatasetChanges.name.changed) {
                                const nameChangeList = document.querySelector("#step4 .dataset-name-change-list");
                                if (nameChangeList) {
                                    nameChangeList.innerHTML = '';
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item d-flex align-items-center';
                                    li.style.color = '#d97706';
                                    li.innerHTML = `<i class="bi bi-pencil me-1"></i>Change Name: "${globalDatasetChanges.name.old}" → "${globalDatasetChanges.name.new}"`;
                                    nameChangeList.appendChild(li);
                                }
                            }
                            
                            // Show status changes
                            if (globalDatasetChanges.status.changed) {
                                const statusChangeList = document.querySelector("#step4 .dataset-status-change-list");
                                if (statusChangeList) {
                                    statusChangeList.innerHTML = '';
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item d-flex align-items-center';
                                    li.style.color = '#d97706';
                                    li.innerHTML = `<i class="bi bi-pencil me-1"></i>Change Status: "${globalDatasetChanges.status.old}" → "${globalDatasetChanges.status.new}"`;
                                    statusChangeList.appendChild(li);
                                }
                            }
                            
                            // Show description changes
                            if (globalDatasetChanges.description.changed) {
                                const descriptionChangeList = document.querySelector("#step4 .dataset-description-change-list");
                                if (descriptionChangeList) {
                                    descriptionChangeList.innerHTML = '';
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item d-flex align-items-center';
                                    li.style.color = '#d97706';
                                    const oldDesc = globalDatasetChanges.description.old || 'No description provided.';
                                    const newDesc = globalDatasetChanges.description.new || 'No description provided.';
                                    li.innerHTML = `<i class="bi bi-pencil me-1"></i>Change Description: "${oldDesc}" → "${newDesc}"`;
                                    descriptionChangeList.appendChild(li);
                                }
                            }
                        }
                    {% endif %}
                    
                    console.log('Dataset info and authors updated');
                };

                // Initialize form handler with initial values
                const formHandler = new FormHandler({
                    formId: 'datasetForm',
                    steps: ['step1', 'step2', 'step3', 'step4'],
                    initialCaptures: new Set(initialCaptures),
                    initialFiles: new Set(initialFiles.map(file => file.id)),
                    initialCaptureDetails: initialCaptureDetails,
                    isEditMode: {% if existing_dataset %}true{% else %}false{% endif %},
                    onStepChange: (step) => {
                        // Scroll card body to top
                        document.getElementById('main-card-body').scrollTop = 0;

                        if (step === 1) {
                            if (!formHandler.capturesSearchHandler) {
                                formHandler.capturesSearchHandler = new SearchHandler({
                                    searchFormId: 'captures-search-form',
                                    searchButtonId: 'search-captures',
                                    clearButtonId: 'clear-captures-search',
                                    tableBodyId: 'captures-table-body',
                                    paginationContainerId: 'captures-pagination',
                                    type: 'captures',
                                    formHandler: {% if existing_dataset %}window.datasetEditingHandler{% else %}formHandler{% endif %},
                                    isEditMode: {% if existing_dataset %}true{% else %}false{% endif %},
                                    initialCaptureDetails: initialCaptureDetails
                                });
                                formHandler.capturesSearchHandler.initializeCapturesSearch();
                            }
                        } else if (step === 2) {
                            if (!formHandler.filesSearchHandler) {
                                formHandler.filesSearchHandler = new SearchHandler({
                                    searchFormId: 'files-search-form',
                                    searchButtonId: 'search-files',
                                    clearButtonId: 'clear-files-search',
                                    tableBodyId: 'file-tree-table',
                                    paginationContainerId: 'files-pagination',
                                    type: 'files',
                                    confirmFileSelectionId: 'confirm-file-selection',
                                    formHandler: {% if existing_dataset %}window.datasetEditingHandler{% else %}formHandler{% endif %},
                                    isEditMode: {% if existing_dataset %}true{% else %}false{% endif %},
                                    initialFileDetails: initialFileDetails
                                });
                                formHandler.filesSearchHandler.loadFileTree();
                            }
                        } else if (step === 3) {
                            console.log('Navigating to step 4');
                            console.log('window.updateReviewDatasetDisplay:', window.updateReviewDatasetDisplay);
                            // Update review display when navigating to step 4
                            if (window.updateReviewDatasetDisplay) {
                                window.updateReviewDatasetDisplay();
                            }
                        }
                    }
                });
                
                // Initialize authors management after FormHandler is created
                initializeAuthorsManagement();

                // Show the body after basic initialization
                document.getElementById('body').classList.remove('d-none');
            });

            // Authors management functionality
            function initializeAuthorsManagement() {
                const authorsContainer = document.getElementById('authors-container');
                const authorsList = authorsContainer?.querySelector('.authors-list');
                const addAuthorBtn = document.getElementById('add-author-btn');
                const authorsHiddenField = document.getElementById('id_authors');
                if (!authorsContainer || !authorsList || !authorsHiddenField) return;

                // Check if we're in edit mode
                const isEditMode = {% if existing_dataset %}true{% else %}false{% endif %};
                
                // Get initial authors from the hidden field
                let authors = [];
                let originalAuthors = []; // Store original authors for edit mode
                try {
                    const initialAuthors = authorsHiddenField.value;
                    if (initialAuthors && initialAuthors.trim() !== '') {
                        authors = JSON.parse(initialAuthors);
                        if (isEditMode) {
                            // In edit mode, get original authors from the dataset
                            // The hidden field contains the current authors (including any new ones)
                            // We need to get the original authors from the dataset context
                            {% if existing_dataset %}
                                const datasetAuthors = {{ existing_dataset.authors|safe }};
                                originalAuthors = Array.isArray(datasetAuthors) ? datasetAuthors : [];
                                // Convert to consistent format
                                originalAuthors = originalAuthors.map(author => {
                                    if (typeof author === 'string') {
                                        return { name: author, orcid_id: '' };
                                    }
                                    return author;
                                });
                            {% else %}
                                originalAuthors = [...authors]; // Keep a copy of original authors
                            {% endif %}
                        }
                    }
                } catch (e) {
                    console.error('Error parsing initial authors:', e);
                }
                // Convert legacy string authors to new format if needed
                authors = authors.map(author => {
                    if (typeof author === 'string') {
                        return {
                            name: author,
                            orcid_id: ''
                        };
                    }
                    return author;
                });
                
                if (isEditMode) {
                    originalAuthors = originalAuthors.map(author => {
                        if (typeof author === 'string') {
                            return {
                                name: author,
                                orcid_id: ''
                            };
                        }
                        return author;
                    });
                }
                
                // If no authors after conversion, add the current user as the first author
                // (This should only happen in create mode, as edit mode should always have authors)
                if (authors.length === 0 && !isEditMode) {
                    const currentUserName = '{{ request.user.name|default:request.user.email }}';
                    const currentUserOrcid = '{{ request.user.orcid_id|default:"" }}';
                    authors = [{
                        name: currentUserName,
                        orcid_id: currentUserOrcid
                    }];
                }

                // Track author changes ONLY for edit mode
                // In create mode, changes are applied immediately - no pending lists
                let authorChanges = {
                    added: [],    // Only used in edit mode
                    removed: [],  // Only used in edit mode  
                    modified: {}  // Only used in edit mode: index -> {old: string, new: string}
                };

                // In edit mode, detect initial changes by comparing current authors with original authors
                if (isEditMode && originalAuthors.length > 0) {
                    
                    // Find new authors (authors in current list but not in original list)
                    authors.forEach((author, index) => {
                        const authorName = typeof author === 'string' ? author : author.name;
                        const authorOrcid = typeof author === 'string' ? '' : author.orcid_id;
                        
                        // Check if this author exists in the original authors
                        const existsInOriginal = originalAuthors.some(origAuthor => {
                            const origName = typeof origAuthor === 'string' ? origAuthor : origAuthor.name;
                            const origOrcid = typeof origAuthor === 'string' ? '' : origAuthor.orcid_id;
                            return origName === authorName && origOrcid === authorOrcid;
                        });
                        
                        if (!existsInOriginal) {
                            authorChanges.added.push(index);
                        }
                    });
                    
                    // Find removed authors (authors in original list but not in current list)
                    originalAuthors.forEach((origAuthor, origIndex) => {
                        const origName = typeof origAuthor === 'string' ? origAuthor : origAuthor.name;
                        const origOrcid = typeof origAuthor === 'string' ? '' : origAuthor.orcid_id;
                        
                        // Check if this author exists in the current authors
                        const existsInCurrent = authors.some(author => {
                            const authorName = typeof author === 'string' ? author : author.name;
                            const authorOrcid = typeof author === 'string' ? '' : author.orcid_id;
                            return authorName === origName && authorOrcid === origOrcid;
                        });
                        
                        if (!existsInCurrent) {
                            // Find the index in the current authors array (it might be different due to additions)
                            const currentIndex = authors.findIndex(author => {
                                const authorName = typeof author === 'string' ? author : author.name;
                                return authorName === origName;
                            });
                            if (currentIndex >= 0) {
                                authorChanges.removed.push(currentIndex);
                            }
                        }
                    });
                }

                function updateAuthorsDisplay() {
                    // Clear the entire authors list
                    authorsList.innerHTML = '';
                    
                    console.log('Updating authors display. Authors count:', authors.length, 'Mode:', isEditMode ? 'edit' : 'create');
                    
                    // Rebuild the display from the current authors array
                    authors.forEach((author, index) => {
                        const authorDiv = document.createElement('div');
                        authorDiv.className = 'author-item mb-3 p-3 border rounded';
                        
                        // In create mode, never mark authors for removal - they are completely removed
                        // In edit mode, check if this author is marked for removal
                        const isMarkedForRemoval = isEditMode && authorChanges.removed.includes(index);
                        
                        // Apply visual styling for marked authors (only in edit mode)
                        if (isMarkedForRemoval) {
                            authorDiv.classList.add('marked-for-removal');
                            authorDiv.classList.add('border-danger');
                        }
                        
                        const authorName = typeof author === 'string' ? author : author.name || '';
                        const authorOrcid = typeof author === 'string' ? '' : author.orcid_id || '';
                        
                        authorDiv.innerHTML = `
                            <div class="position-relative">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="flex-grow-1">
                                        <!-- Empty space for alignment -->
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        ${index === 0 ? 
                                            '<span class="badge bg-primary">Primary</span><i class="bi bi-lock-fill text-muted" title="Primary author cannot be removed"></i>' : 
                                            (isEditMode && isMarkedForRemoval ? 
                                                `<button type="button" class="btn btn-sm btn-outline-secondary cancel-remove-author" data-index="${index}" title="Cancel removal"><i class="bi bi-arrow-counterclockwise"></i></button>` :
                                                `<button type="button" class="btn btn-sm btn-outline-danger remove-author" data-index="${index}" title="${isEditMode ? 'Mark for removal' : 'Remove author'}"><i class="bi bi-trash"></i></button>`
                                            )
                                        }
                                    </div>
                                </div>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">Author Name</label>
                                        <input type="text" 
                                               class="form-control author-name-input" 
                                               value="${authorName}" 
                                               placeholder="Enter full name"
                                               ${index === 0 ? 'readonly' : ''}
                                               ${isMarkedForRemoval ? 'disabled' : ''}
                                               data-index="${index}"
                                               data-field="name">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">ORCID ID</label>
                                        <input type="text" 
                                               class="form-control author-orcid-input" 
                                               value="${authorOrcid}" 
                                               placeholder="0000-0000-0000-0000"
                                               ${index === 0 ? 'readonly' : ''}
                                               ${isMarkedForRemoval ? 'disabled' : ''}
                                               data-index="${index}"
                                               data-field="orcid_id">
                                    </div>
                                </div>
                            </div>
                        `;
                        authorsList.appendChild(authorDiv);
                    });

                    // Update hidden field
                    authorsHiddenField.value = JSON.stringify(authors);

                    // Show/hide add button based on permissions
                    if (addAuthorBtn) {
                        addAuthorBtn.style.display = {% if can_edit_metadata %}''{% else %}'none'{% endif %};
                    }
                }

                function addAuthor() {
                    const newIndex = authors.length;
                    authors.push({
                        name: '',
                        orcid_id: ''
                    });
                    
                    if (isEditMode) {
                        // In edit mode, track as added for change management
                        // Note: If this newly added author is later removed, it will be completely deleted
                        // rather than marked for removal (see removeAuthor function)
                        if (!authorChanges.added.includes(newIndex)) {
                            authorChanges.added.push(newIndex);
                        }
                    }
                    // In create mode, no tracking needed - just add to the array
                    
                    updateAuthorsDisplay();
                    
                    // Focus on the new name input
                    const newInput = authorsList.querySelector(`input[data-index="${newIndex}"][data-field="name"]`);
                    if (newInput) {
                        newInput.focus();
                    }
                    
                    // Update review display
                    if (window.updateReviewDatasetDisplay) {
                        window.updateReviewDatasetDisplay();
                    }
                }

                function removeAuthor(index) {
                    if (index > 0) { // Don't remove the primary author
                        if (isEditMode) {
                            // In edit mode, check if this is a newly added author
                            const isNewlyAdded = authorChanges.added.includes(index);
                            
                            if (isNewlyAdded) {
                                // If it's a newly added author, completely remove it (no pending state)
                                // Remove from the authors array
                                authors.splice(index, 1);
                                
                                // Remove from the added list
                                const addIndex = authorChanges.added.indexOf(index);
                                if (addIndex > -1) {
                                    authorChanges.added.splice(addIndex, 1);
                                }
                                
                                // Adjust indices in the added list for authors that come after this one
                                authorChanges.added = authorChanges.added.map(addedIndex => 
                                    addedIndex > index ? addedIndex - 1 : addedIndex
                                );
                                
                                // Adjust indices in the removed list for authors that come after this one
                                authorChanges.removed = authorChanges.removed.map(removedIndex => 
                                    removedIndex > index ? removedIndex - 1 : removedIndex
                                );
                                
                                // Adjust indices in the modified list for authors that come after this one
                                const newModified = {};
                                Object.entries(authorChanges.modified).forEach(([modifiedIndex, changes]) => {
                                    const numIndex = parseInt(modifiedIndex);
                                    if (numIndex > index) {
                                        newModified[numIndex - 1] = changes;
                                    } else if (numIndex < index) {
                                        newModified[numIndex] = changes;
                                    }
                                    // Skip the current index (it's being removed)
                                });
                                authorChanges.modified = newModified;
                                
                                console.log('Removed newly added author at index:', index);
                            } else {
                                // For existing authors, mark for removal instead of actually removing
                                if (!authorChanges.removed.includes(index)) {
                                    authorChanges.removed.push(index);
                                }
                                console.log('Marked existing author for removal at index:', index);
                            }
                            
                            updateAuthorsDisplay();
                            
                            // Update review display
                            if (window.updateReviewDatasetDisplay) {
                                window.updateReviewDatasetDisplay();
                            }
                        } else {
                            // In create mode, completely remove the author immediately
                            // No pending lists or change tracking - just remove from the array
                            // This will cause the author entry to disappear from the UI
                            authors.splice(index, 1);
                            
                            // Clear any potential tracking data (shouldn't exist in create mode, but be safe)
                            if (authorChanges.removed.includes(index)) {
                                const removeIndex = authorChanges.removed.indexOf(index);
                                authorChanges.removed.splice(removeIndex, 1);
                            }
                            if (authorChanges.added.includes(index)) {
                                const addIndex = authorChanges.added.indexOf(index);
                                authorChanges.added.splice(addIndex, 1);
                            }
                            
                            // Immediately update the display - the author entry will disappear
                            updateAuthorsDisplay();
                            
                            // Update review display
                            if (window.updateReviewDatasetDisplay) {
                                window.updateReviewDatasetDisplay();
                            }
                        }
                    } else {
                        // Show warning that primary author cannot be removed
                        showNotification('The primary author cannot be removed. This is the dataset creator.', 'warning');
                    }
                }

                function cancelAuthorRemoval(index) {
                    if (isEditMode && authorChanges.removed.includes(index)) {
                        const removeIndex = authorChanges.removed.indexOf(index);
                        if (removeIndex > -1) {
                            authorChanges.removed.splice(removeIndex, 1);
                        }
                        updateAuthorsDisplay();
                        
                        // Update review display
                        if (window.updateReviewDatasetDisplay) {
                            window.updateReviewDatasetDisplay();
                        }
                    }
                }

                function showNotification(message, type = 'info') {
                    const errorContainer = document.getElementById('formErrors');
                    const errorContent = errorContainer?.querySelector('.error-content');
                    
                    if (errorContainer && errorContent) {
                        // Change alert type based on message type
                        errorContainer.className = `alert alert-${type === 'warning' ? 'warning' : 'danger'} bg-${type === 'warning' ? 'warning' : 'danger'}-subtle text-${type === 'warning' ? 'warning' : 'danger'} mb-4 form-error-container`;
                        
                        // Update icon based on type
                        const icon = errorContainer.querySelector('i');
                        if (icon) {
                            icon.className = `bi bi-${type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle'}-fill me-2`;
                        }
                        
                        errorContent.innerHTML = `<ul class="mb-0 list-unstyled"><li>${message}</li></ul>`;
                        
                        // Show the notification
                        errorContainer.classList.remove('d-none');
                        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        
                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            errorContainer.classList.add('d-none');
                        }, 5000);
                    }
                }

                // Event listeners
                if (addAuthorBtn) {
                    addAuthorBtn.addEventListener('click', addAuthor);
                }

                // Handle input changes
                authorsList.addEventListener('input', (e) => {
                    if (e.target.classList.contains('author-name-input') || e.target.classList.contains('author-orcid-input')) {
                        const index = parseInt(e.target.dataset.index);
                        const field = e.target.dataset.field;
                        
                        // Ensure author object exists
                        if (!authors[index] || typeof authors[index] === 'string') {
                            authors[index] = {
                                name: typeof authors[index] === 'string' ? authors[index] : '',
                                orcid_id: ''
                            };
                        }
                        
                        const oldValue = authors[index][field];
                        authors[index][field] = e.target.value;
                        
                        // Track modifications in edit mode
                        if (isEditMode && index < originalAuthors.length) {
                            const originalAuthor = originalAuthors[index];
                            const originalValue = typeof originalAuthor === 'string' ? 
                                (field === 'name' ? originalAuthor : '') : 
                                (originalAuthor[field] || '');
                            
                            if (e.target.value !== originalValue) {
                                if (!authorChanges.modified[index]) {
                                    authorChanges.modified[index] = {};
                                }
                                authorChanges.modified[index][field] = {
                                    old: originalValue,
                                    new: e.target.value
                                };
                            } else {
                                if (authorChanges.modified[index]) {
                                    delete authorChanges.modified[index][field];
                                    if (Object.keys(authorChanges.modified[index]).length === 0) {
                                        delete authorChanges.modified[index];
                                    }
                                }
                            }
                        }
                        
                        // Only update display if we need to remove empty authors
                        let needsUpdate = false;
                        if (index > 0 && !authors[index].name.trim() && !authors[index].orcid_id.trim()) {
                            authors.splice(index, 1);
                            needsUpdate = true;
                        }
                        
                        authorsHiddenField.value = JSON.stringify(authors);
                        
                        // Only call updateAuthorsDisplay if we actually removed an author
                        if (needsUpdate) {
                            updateAuthorsDisplay();
                        }
                        
                        // Update review display if we're on the review step
                        if (window.updateReviewDatasetDisplay) {
                            window.updateReviewDatasetDisplay();
                        }
                    }
                });

                // Handle remove and cancel buttons
                authorsList.addEventListener('click', (e) => {
                    const removeButton = e.target.closest('.remove-author');
                    const cancelButton = e.target.closest('.cancel-remove-author');
                    
                    if (removeButton) {
                        e.preventDefault();
                        e.stopPropagation();
                        const index = parseInt(removeButton.dataset.index);
                        console.log('Remove button clicked for index:', index, 'in mode:', isEditMode ? 'edit' : 'create');
                        removeAuthor(index);
                    } else if (cancelButton) {
                        e.preventDefault();
                        e.stopPropagation();
                        const index = parseInt(cancelButton.dataset.index);
                        cancelAuthorRemoval(index);
                    }
                });


                // Initial display
                updateAuthorsDisplay();
                
                // Dataset metadata changes tracking
                let datasetChanges = {
                    name: { old: '', new: '', changed: false },
                    status: { old: '', new: '', changed: false },
                    description: { old: '', new: '', changed: false }
                };
                
                // Populate global variables for updateReviewDatasetDisplay
                globalAuthors = authors;
                globalOriginalAuthors = originalAuthors;
                globalAuthorChanges = authorChanges;
                globalDatasetChanges = datasetChanges;
                
                window.getAuthorChanges = () => authorChanges;
                console.log('Global variables populated for updateReviewDatasetDisplay');
                
                // Get original values for edit mode
                {% if existing_dataset %}
                    datasetChanges.name.old = '{{ existing_dataset.name|escapejs }}';
                    datasetChanges.status.old = '{{ existing_dataset.get_status_display|escapejs }}';
                    datasetChanges.description.old = '{{ existing_dataset.description|default:""|escapejs }}';
                {% endif %}
                
                // Track changes to dataset fields
                function trackDatasetChanges() {
                    const nameField = document.getElementById('id_name');
                    const statusField = document.getElementById('id_status');
                    const descriptionField = document.getElementById('id_description');
                    
                    if (nameField) {
                        nameField.addEventListener('input', () => {
                            datasetChanges.name.new = nameField.value;
                            datasetChanges.name.changed = datasetChanges.name.new !== datasetChanges.name.old;
                            window.updateReviewDatasetDisplay();
                        });
                    }
                    
                    if (statusField) {
                        statusField.addEventListener('change', () => {
                            const selectedOption = statusField.options[statusField.selectedIndex];
                            datasetChanges.status.new = selectedOption ? selectedOption.text : '';
                            datasetChanges.status.changed = datasetChanges.status.new !== datasetChanges.status.old;
                            window.updateReviewDatasetDisplay();
                        });
                    }
                    
                    if (descriptionField) {
                        descriptionField.addEventListener('input', () => {
                            datasetChanges.description.new = descriptionField.value;
                            datasetChanges.description.changed = datasetChanges.description.new !== datasetChanges.description.old;
                            window.updateReviewDatasetDisplay();
                        });
                    }
                }
                
                // Initialize dataset change tracking
                trackDatasetChanges();
                
                // Initialize current values
                const nameField = document.getElementById('id_name');
                const statusField = document.getElementById('id_status');
                const descriptionField = document.getElementById('id_description');
                
                if (nameField) {
                    datasetChanges.name.new = nameField.value;
                    datasetChanges.name.changed = datasetChanges.name.new !== datasetChanges.name.old;
                }
                
                if (statusField) {
                    const selectedOption = statusField.options[statusField.selectedIndex];
                    datasetChanges.status.new = selectedOption ? selectedOption.text : '';
                    datasetChanges.status.changed = datasetChanges.status.new !== datasetChanges.status.old;
                }
                
                if (descriptionField) {
                    datasetChanges.description.new = descriptionField.value;
                    datasetChanges.description.changed = datasetChanges.description.new !== datasetChanges.description.old;
                }
                
                // Make function available globally (already assigned above)
                window.getDatasetChanges = () => datasetChanges;
                
                // Initialize the review display with current values
                updateReviewDatasetDisplay();
                
                // Cancel functions for pending changes
                window.cancelAuthorAddition = (index) => {
                    if (authorChanges.added.includes(index)) {
                        const removeIndex = authorChanges.added.indexOf(index);
                        if (removeIndex > -1) {
                            authorChanges.added.splice(removeIndex, 1);
                        }
                        // Remove the author from the authors array
                        authors.splice(index, 1);
                        updateAuthorsDisplay();
                        if (window.updateReviewDatasetDisplay) {
                            window.updateReviewDatasetDisplay();
                        }
                    }
                };
                
                window.cancelAuthorRemoval = (index) => {
                    if (authorChanges.removed.includes(index)) {
                        const removeIndex = authorChanges.removed.indexOf(index);
                        if (removeIndex > -1) {
                            authorChanges.removed.splice(removeIndex, 1);
                        }
                        updateAuthorsDisplay();
                        if (window.updateReviewDatasetDisplay) {
                            window.updateReviewDatasetDisplay();
                        }
                    }
                };
                
                window.cancelAuthorModification = (index, field) => {
                    if (authorChanges.modified[index] && authorChanges.modified[index][field]) {
                        delete authorChanges.modified[index][field];
                        if (Object.keys(authorChanges.modified[index]).length === 0) {
                            delete authorChanges.modified[index];
                        }
                        // Restore original value
                        if (originalAuthors[index]) {
                            const originalAuthor = originalAuthors[index];
                            const originalValue = typeof originalAuthor === 'string' ? 
                                (field === 'name' ? originalAuthor : '') : 
                                (originalAuthor[field] || '');
                            authors[index][field] = originalValue;
                        }
                        updateAuthorsDisplay();
                        if (window.updateReviewDatasetDisplay) {
                            window.updateReviewDatasetDisplay();
                        }
                    }
                };
            }
</script>
        {# djlint:on #}
    {% endblock extra_js %}
{% endblock content %}
