{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block title %}
    Group Captures
{% endblock title %}
{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
          rel="stylesheet" />
    <style>
        .page-body {
            display: none;
        }

        .page-body.show {
            display: block;
        }

        .form-error-container {
            border-left: 4px solid #dc3545;
        }

        .form-error-container.show {
            display: block !important;
        }

        /* Rest of existing styles remain unchanged */
        .btn-group {
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .btn-group .btn {
            border-radius: 0;
            position: relative;
            flex: 1;
        }

        .btn-group .btn:first-child {
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .btn-group .btn:last-child {
            border-top-right-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        .btn-group .btn:not(:first-child) {
            margin-left: -1px;
        }

        .btn-group .btn:not(:last-child) {
            border-right: none;
        }

        .step-number {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #fff;
            color: #0d6efd;
        }

        .btn-primary .step-number {
            background-color: #fff;
            color: #0d6efd;
        }

        .btn-outline-primary.disabled .step-number {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .btn-outline-primary:hover .step-number {
            background-color: #fff;
            color: #0d6efd;
        }

        /* Make tabs non-interactive */
        .btn-group .btn {
            pointer-events: none;
            user-select: none;
        }

        /* File tree styles */
        .file-tree-table {
            border: 1px solid #dee2e6;
        }

        /* Remove hover effect and background from nested rows */
        #file-tree-table tbody tr:hover {
            background-color: transparent !important;
        }

        /* Remove the default table striping */
        #file-tree-table {
            --bs-table-striped-bg: transparent;
        }

        .file-tree-table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }

        .folder-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .folder-toggle {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            cursor: pointer;
            user-select: none;
            font-size: 12px;
            color: #6c757d;
            transition: transform 0.2s;
        }

        .nested-content {
            padding-left: 0.5rem;
            background-color: rgb(255, 255, 255);
        }

        .nested-content .table {
            margin-bottom: 0;
        }

        .form-check-input {
            cursor: pointer;
        }

        .bi {
            margin-right: 0.5rem;
        }

        .bi-folder {
            color: #ffd43b;
        }

        .bi-file-earmark {
            color: #868e96;
        }

        /* Add padding for nested levels */
        .ps-3 {
            padding-left: 1rem !important;
        }

        .ps-6 {
            padding-left: 2rem !important;
        }

        .ps-9 {
            padding-left: 3rem !important;
        }

        .ps-12 {
            padding-left: 4rem !important;
        }

        /* Clickable row styles */
        .clickable-row {
            cursor: pointer;
            user-select: none;
        }

        .clickable-row:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }

        .clickable-row td:first-child {
            cursor: default;
        }

        /* Preserve folder row styles */
        .folder-row {
            cursor: pointer;
        }

        .folder-row:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }

        /* Error message styles */
        #formErrors {
            border-left: 4px solid #dc3545;
        }

        #formErrors .bi-exclamation-triangle-fill {
            color: #dc3545;
            font-size: 1.2rem;
        }

        #formErrors ul {
            margin: 0;
        }

        #formErrors li {
            margin-bottom: 0.25rem;
        }

        #formErrors li:last-child {
            margin-bottom: 0;
        }

        #formErrors strong {
            color: #dc3545;
        }
    </style>
{% endblock extra_css %}
{% block content %}
    <body class="{% block bodyclass %} hero-white-page {% endblock bodyclass %} mb-4 page-body"
          id="body">
        <div class="container">
            <form method="post" id="datasetForm">
                <div class="card mb-4" id="group-captures-card">
                    <div class="card-header">
                        <h5 class="mb-0">Create Dataset from Captures and Artifact Files</h5>
                    </div>
                    <div class="card-body" id="main-card-body">
                        <!-- Step Navigation -->
                        <div id="stepTabs-container">
                            <div class="btn-group w-100" role="group" id="stepTabs">
                                <button class="btn btn-outline-primary active" id="step1-tab">
                                    <span class="step-number">1</span> Dataset Info
                                </button>
                                <button class="btn btn-outline-primary disabled" id="step2-tab">
                                    <span class="step-number">2</span> Select Captures
                                </button>
                                <button class="btn btn-outline-primary disabled" id="step3-tab">
                                    <span class="step-number">3</span> Select Files
                                </button>
                                <button class="btn btn-outline-primary disabled" id="step4-tab">
                                    <span class="step-number">4</span> Review and Create
                                </button>
                            </div>
                        </div>
                        <div id="stepTabsContent">
                            {% csrf_token %}
                            <!-- Error alert container -->
                            <div id="formErrors"
                                 class="alert alert-danger bg-danger-subtle text-danger mb-4 form-error-container"
                                 style="display: none">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div class="error-content"></div>
                                </div>
                            </div>
                            <!-- Hidden fields for selected items -->
                            <input type="hidden"
                                   name="selected_captures"
                                   id="selected_captures"
                                   value="" />
                            <input type="hidden" name="selected_files" id="selected_files" value="" />
                            <div class="tab-content" id="stepTabsContent">
                                <!-- Step 1: Dataset Info -->
                                <div class="tab-pane fade show active" id="step1">
                                    <div class="row g-4">
                                        <div class="col-md-2"></div>
                                        <div class="col-md-8">
                                            <div class="row g-6">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label for="{{ dataset_form.name.id_for_label }}" class="form-label">
                                                            {{ dataset_form.name.label }}
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        {{ dataset_form.name }}
                                                    </div>
                                                    <div class="form-group mt-4">
                                                        <label for="{{ dataset_form.author.id_for_label }}" class="form-label">
                                                            {{ dataset_form.author.label }}
                                                            <span class="text-danger">*</span>
                                                        </label>
                                                        {{ dataset_form.author }}
                                                    </div>
                                                </div>
                                                <div class="col-md-8">
                                                    <div class="form-group">
                                                        <label for="{{ dataset_form.description.id_for_label }}" class="form-label">
                                                            {{ dataset_form.description.label }}
                                                            <span class="text-muted">(Optional)</span>
                                                        </label>
                                                        {{ dataset_form.description }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-muted small mt-3">
                                                <span class="text-danger">*</span> Required fields
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Step 2: Captures Selection -->
                                <div class="tab-pane fade" id="step2">
                                    <div class="row g-4">
                                        <div class="col-md-8">
                                            <div class="card">
                                                <div class="card-header">
                                                    <h5 class="mb-0">
                                                        Select Captures for Dataset: "<span class="dataset-name-display">Untitled Dataset</span>"
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="mb-3" id="captures-search-form">
                                                        <div class="row g-3">
                                                            {% for field in capture_search_form %}
                                                                <div class="col-md-3">
                                                                    <div class="form-group">
                                                                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                                                        {{ field }}
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                            <div class="col-12">
                                                                <button type="button" class="btn btn-primary btn-sm" id="search-captures">Search Captures</button>
                                                                <button type="button"
                                                                        class="btn btn-outline-secondary btn-sm"
                                                                        id="clear-captures-search">Clear</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {% include "users/partials/captures_table.html" %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Step 3: Files Selection -->
                                <div class="tab-pane fade" id="step3">
                                    <div class="row g-4">
                                        <div class="col-md-1"></div>
                                        <div class="col-md-10">{% include "users/partials/file_browser.html" %}</div>
                                    </div>
                                </div>
                                <!-- Step 4: Review and Create -->
                                <div class="tab-pane fade" id="step4">
                                    <div class="row g-4">{% include "users/partials/review_create_dataset.html" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary me-2" id="prevStep">Previous</button>
                            <button type="button" class="btn btn-primary me-2" id="nextStep">Next</button>
                            <button type="submit" class="btn btn-success" id="submitForm">Create Dataset</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </body>
    {% block extra_js %}
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'webpack_bundles/js/vendors.js' %}"></script>
        <script src="{% static 'webpack_bundles/js/project.js' %}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Wait for webpack bundles to load
                const interval = setInterval(() => {
                    if (window.SearchHandler && window.FormHandler) {
                        clearInterval(interval);

                        // Initialize form handler first
                        const formHandler = new FormHandler({
                            formId: 'datasetForm',
                            steps: ['step1', 'step2', 'step3', 'step4'],
                            onStepChange: (step) => {
                                // Scroll card body to top
                                document.getElementById('main-card-body').scrollTop = 0;

                                if (step === 1) {
                                    if (!formHandler.capturesSearchHandler) {
                                        formHandler.capturesSearchHandler = new SearchHandler({
                                            searchFormId: 'captures-search-form',
                                            searchButtonId: 'search-captures',
                                            clearButtonId: 'clear-captures-search',
                                            tableBodyId: 'captures-table-body',
                                            paginationContainerId: 'captures-pagination',
                                            type: 'captures',
                                            formHandler: formHandler
                                        });
                                        formHandler.capturesSearchHandler.initializeCapturesSearch();
                                    }
                                } else if (step === 2) {
                                    if (!formHandler.filesSearchHandler) {
                                        formHandler.filesSearchHandler = new SearchHandler({
                                            searchFormId: 'files-search-form',
                                            searchButtonId: 'search-files',
                                            clearButtonId: 'clear-files-search',
                                            tableBodyId: 'file-tree-table',
                                            paginationContainerId: 'files-pagination',
                                            type: 'files',
                                            confirmFileSelectionId: 'confirm-file-selection',
                                            formHandler: formHandler
                                        });
                                        formHandler.filesSearchHandler.loadFileTree();
                                    }
                                }
                            }
                        });

                        // Show the body after initialization
                        document.getElementById('body').classList.remove('d-none');
                    }
                }, 100);
            });
        </script>
    {% endblock extra_js %}
{% endblock content %}
