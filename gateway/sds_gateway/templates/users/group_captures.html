{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block title %}
    Group Captures
{% endblock title %}
{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
          rel="stylesheet" />
{% endblock extra_css %}
{% block content %}
    <body class="{% block bodyclass %} hero-white-page {% endblock bodyclass %} mb-4 page-body"
          id="body">
        <div class="container-fluid px-5 pt-4">
            <!-- Back button -->
            <div class="mb-3">
                <a href="{% url 'users:dataset_list' %}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Dataset List
                </a>
            </div>
            <form method="post" id="datasetForm">
                <div class="card mb-4" id="group-captures-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            {% if existing_dataset %}
                                Edit Dataset: {{ existing_dataset.name }} (v{{ existing_dataset.version }})
                            {% else %}
                                Create Dataset from Captures and Artifact Files
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body" id="main-card-body">
                        <!-- Step Navigation -->
                        <div id="stepTabs-container">
                            <div class="btn-group w-100{% if not existing_dataset %} btn-group-disabled{% endif %}"
                                 role="group"
                                 id="stepTabs">
                                <button type="button" class="btn btn-primary active-tab" id="step1-tab">
                                    <span class="step-number">1</span> Dataset Info
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step2-tab">
                                    <span class="step-number">2</span> Select Captures
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step3-tab">
                                    <span class="step-number">3</span> Select Artifact Files
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step4-tab">
                                    <span class="step-number">4</span> Publishing Info
                                </button>
                                <button type="button"
                                        class="btn btn-outline-primary inactive-tab"
                                        id="step5-tab">
                                    <span class="step-number">5</span>
                                    {% if existing_dataset %}
                                        Review and Update
                                    {% else %}
                                        Review and Create
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                        <div id="stepTabsContent">
                            {% csrf_token %}
                            <!-- Error alert container -->
                            <div id="formErrors"
                                 class="alert alert-danger bg-danger-subtle text-danger mb-4 form-error-container d-none">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div class="error-content"></div>
                                </div>
                            </div>
                            <!-- Hidden fields for selected items -->
                            <input type="hidden"
                                   name="selected_captures"
                                   id="selected_captures"
                                   value="" />
                            <input type="hidden" name="selected_files" id="selected_files" value="" />
                            <div class="tab-content" id="stepTabsContentInner">
                                {% include "users/partials/step_1.html" %}
                                {% include "users/partials/step_2.html" %}
                                {% include "users/partials/step_3.html" %}
                                {% include "users/partials/step_4.html" %}
                                {% include "users/partials/step_5.html" %}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" id="prevStep">Previous</button>
                            <button type="button" class="btn btn-primary me-2" id="nextStep">Next</button>
                            <button type="submit" class="btn btn-success d-none" id="submitForm">
                                {% if existing_dataset %}
                                    Update Dataset
                                {% else %}
                                    Create Dataset
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </body>
    {% block extra_js %}
        <!-- Dataset components -->
        <script src="{% static 'js/dataset/DatasetModeManager.js' %}"></script>
        <script src="{% static 'js/dataset/DatasetCreationHandler.js' %}"></script>
        <script src="{% static 'js/dataset/DatasetEditingHandler.js' %}"></script>
        <!-- Search components -->
        <script src="{% static 'js/search/AssetSearchHandler.js' %}"></script>
        <!-- External JavaScript files -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="{% static 'webpack_bundles/js/vendors.js' %}"></script>
        <script src="{% static 'webpack_bundles/js/project.js' %}"></script>
        {# djlint:off #}
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                // Initialize keyword autocomplete
                const keywordInput = document.getElementById('id_keywords');
                if (keywordInput) {
                    new window.KeywordAutocomplete(keywordInput);
                }

                // Initialize the dataset mode manager
                const datasetModeManager = new DatasetModeManager({
                    isEditMode: {{ existing_dataset|yesno:"true,false" }},
                    datasetUuid: "{{ existing_dataset.uuid|default:'' }}",
                    userPermissionLevel: '{{ permission_level }}',
                    currentUserId: {{ request.user.id }},
                    isOwner: {% if is_owner %}true{% else %}false{% endif %},
                    datasetPermissions: {
                        canEditMetadata: {% if can_edit_metadata %}true{% else %}false{% endif %},
                        canAddAssets: {% if can_add_assets %}true{% else %}false{% endif %},
                        canRemoveAnyAssets: {% if can_remove_assets %}true{% else %}false{% endif %},
                        canRemoveOwnAssets: true,
                        canShare: {% if can_edit_metadata %}true{% else %}false{% endif %},
                        canDownload: true,
                        canDelete: {% if is_owner %}true{% else %}false{% endif %}
                    },
                    initialCaptures: {{ selected_captures|safe }},
                    initialFiles: {{ selected_files|safe }},
                    initialCaptureDetails: {{ selected_captures_details_json|safe }},
                    initialFileDetails: {{ selected_files_details_json|safe }},
                    initialAuthors: {{ existing_dataset.authors|safe|default:"[]" }},
                    existingDatasetStatus: {% if existing_dataset %}'{{ existing_dataset.status }}'{% else %}null{% endif %},
                    existingDatasetIsPublic: {% if existing_dataset %}{{ existing_dataset.is_public|yesno:"true,false" }}{% else %}false{% endif %}
                });

                // Make it globally available
                window.datasetModeManager = datasetModeManager;

                // Show the body after basic initialization
                document.getElementById('body').classList.remove('d-none');
            });

</script>
        {# djlint:on #}
    {% endblock extra_js %}
{% endblock content %}
