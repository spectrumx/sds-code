{% extends "base.html" %}

{% load static %}

{% block title %}
    Files
{% endblock title %}
{% block css %}
    {{ block.super }}
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
          rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap"
          rel="stylesheet" />
    <!-- File Manager Styles -->
    <link href="{% static 'css/file-manager.css' %}" rel="stylesheet" />
    <!-- Reuse captures modal styling from file_list -->
    <link rel="stylesheet" href="{% static 'css/file-list.css' %}" />
{% endblock css %}
{% block content %}
    <!-- Main Container -->
    <div class="container-fluid">
        <!-- New Button Dropdown -->
        <div class="files-actions-bar align-items-center mb-4">
            <div class="dropdown">
                <button class="new-button"
                        type="button"
                        id="newButton"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                    <i class="bi bi-plus"></i> New
                </button>
                <ul class="new-menu dropdown-menu" aria-labelledby="newButton">
                    <li>
                        <a class="dropdown-item"
                           href="#"
                           data-bs-toggle="modal"
                           data-bs-target="#uploadCaptureModal">
                            <i class="bi bi-folder"></i> Capture
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item"
                           href="#"
                           data-bs-toggle="modal"
                           data-bs-target="#uploadFileModal">
                            <i class="material-icons file-icon">description</i> Text File
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Files Container -->
        <div class="files-container"
             data-current-dir="{{ current_dir }}"
             data-user-email="{{ user_email }}">
            {% if dataset %}
                <div class="dataset-context mb-4">
                    <h4>
                        <i class="bi bi-database me-2"></i>
                        {{ dataset.name }}
                    </h4>
                    <nav aria-label="Dataset breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{% url 'users:files' %}">Home</a>
                            </li>
                            <li class="breadcrumb-item active">Dataset Contents</li>
                        </ol>
                    </nav>
                </div>
            {% else %}
                <nav aria-label="File location breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'users:files' %}">Home</a>
                        </li>
                        {% for part in breadcrumb_parts %}
                            <li class="breadcrumb-item">
                                <a href="{% url 'users:files' %}?dir={{ part.path|urlencode }}">{{ part.name }}</a>
                            </li>
                        {% endfor %}
                    </ol>
                </nav>
            {% endif %}
            <!-- Files Grid -->
            <div class="files-grid">
                <div class="file-card header">
                    <div class="file-card-content">
                        <div class="file-name">Name</div>
                        <div class="file-meta">Modified</div>
                        <div class="file-shared">Shared by</div>
                        <div class="file-actions text-center">Actions</div>
                    </div>
                </div>
                {% for item in items %}
                    <div class="file-card"
                         data-type="{{ item.type }}"
                         data-path="{{ item.path }}"
                         data-uuid="{{ item.uuid|default:'' }}"
                         data-is-capture="{{ item.is_capture|yesno:'true,false' }}"
                         data-is-dataset="{{ item.is_dataset|yesno:'true,false' }}"
                         data-is-shared="{{ item.is_shared|yesno:'true,false' }}"
                         data-capture-uuid="{{ item.capture_uuid|default:'' }}"
                         data-description="{{ item.description|default:'' }}">
                        <div class="file-card-content">
                            {% if item.is_dataset %}
                                <i class="bi bi-database dataset-icon"></i>
                            {% elif item.type == "directory" %}
                                <i class="bi bi-folder folder-icon"></i>
                            {% else %}
                                <i class="material-icons file-icon">description</i>
                            {% endif %}
                            <div class="file-name">
                                <span class="file-name-text">{{ item.name }}</span>
                                {% if item.is_shared %}
                                    <span class="align-middle" data-bs-toggle="tooltip" title="Shared with you">
                                        <i class="bi bi-people-fill text-success"></i>
                                    </span>
                                {% endif %}
                            </div>
                            <div class="file-meta">
                                {% if item.modified_at %}
                                    {{ item.modified_at }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </div>
                            <div class="file-shared">
                                {% if item.shared_by %}{{ item.shared_by }}{% endif %}
                            </div>
                            <div class="file-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle btn-icon-dropdown d-flex align-items-center justify-content-center"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            data-bs-popper="static"
                                            aria-expanded="false"
                                            aria-label="Actions for {{ item.name }}">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% if item.is_dataset %}
                                            {% if item.is_owner %}
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            onclick="window.location.href='{% url 'users:group_captures' %}?dataset_uuid={{ item.uuid }}'">
                                                        <i class="bi bi-pencil me-2"></i>Edit
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#share-modal-{{ item.uuid }}">
                                                        <i class="bi bi-share me-2"></i>Share
                                                    </button>
                                                </li>
                                            {% endif %}
                                            <li>
                                                <button class="dropdown-item download-dataset-btn"
                                                        type="button"
                                                        data-dataset-uuid="{{ item.uuid }}"
                                                        data-dataset-name="{{ item.name }}">
                                                    <i class="bi bi-download me-2"></i>Download
                                                </button>
                                            </li>
                                        {% elif item.is_capture %}
                                            {% if item.is_owner %}
                                                <li>
                                                    <button class="dropdown-item capture-details-btn"
                                                            type="button"
                                                            data-uuid="{{ item.uuid }}"
                                                            data-name="{{ item.name|default:'' }}"
                                                            data-channel="{{ item.capture_uuid }}"
                                                            data-scan-group=""
                                                            data-capture-type=""
                                                            data-top-level-dir=""
                                                            data-owner="{{ request.user.email }}"
                                                            data-origin=""
                                                            data-dataset=""
                                                            data-created-at=""
                                                            data-updated-at=""
                                                            data-is-public="false"
                                                            data-center-frequency-ghz=""
                                                            data-is-multi-channel="false"
                                                            data-channels="">
                                                        <i class="bi bi-pencil me-2"></i>Edit
                                                    </button>
                                                </li>
                                                <li>
                                                    <button class="dropdown-item"
                                                            type="button"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#share-modal-{{ item.uuid }}">
                                                        <i class="bi bi-share me-2"></i>Share
                                                    </button>
                                                </li>
                                            {% endif %}
                                            <li>
                                                <button class="dropdown-item download-capture-btn"
                                                        type="button"
                                                        data-capture-uuid="{{ item.uuid }}"
                                                        data-capture-name="{{ item.name }}">
                                                    <i class="bi bi-download me-2"></i>Download
                                                </button>
                                            </li>
                                        {% elif item.type == 'file' %}
                                            <li>
                                                <a class="dropdown-item"
                                                   href="{% url 'users:file_download' uuid=item.uuid %}">
                                                    <i class="bi bi-download me-2"></i>Download
                                                </a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="no-files">
                        <i class="material-icons empty-folder-icon">folder_open</i>
                        <p>
                            {% if dataset %}
                                This dataset has no files or captures
                            {% else %}
                                This folder is empty
                            {% endif %}
                        </p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <!-- Download Confirmation Modal (shared with captures page style) -->
    <div class="custom-modal"
         id="downloadModal"
         tabindex="-1"
         aria-labelledby="downloadModalLabel">
        <div class="custom-modal-backdrop"></div>
        <div class="custom-modal-dialog">
            <div class="custom-modal-content">
                <div class="custom-modal-header">
                    <h5 class="custom-modal-title" id="downloadModalLabel">Download</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            onclick="closeCustomModal('downloadModal')"></button>
                </div>
                <div class="custom-modal-body">
                    <p>Are you sure you want to download this item?</p>
                    <p>
                        <strong>Item:</strong> <span id="downloadCaptureName"></span>
                    </p>
                </div>
                <div class="custom-modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            onclick="closeCustomModal('downloadModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmDownloadBtn">Download</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const key = 'filesAlert';
            const stored = sessionStorage.getItem(key);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (window.components && typeof window.components.showError === 'function' && data?.type === 'error') {
                        window.components.showError(data.message || 'An error occurred.');
                    } else if (window.components && typeof window.components.showSuccess === 'function' && data?.type === 'success') {
                        window.components.showSuccess(data.message || 'Success');
                    }
                } catch (e) {}
                sessionStorage.removeItem(key);
            }
        });
    </script>
    {# Removed unused generic Upload Modal (not referenced) #}
    <!-- Upload Capture Modal -->
    <div class="modal fade"
         id="uploadCaptureModal"
         tabindex="-1"
         aria-labelledby="uploadCaptureModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="uploadCaptureForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadCaptureModalLabel">Upload Files & Create Capture</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"
                                tabindex="-1"></button>
                    </div>
                    <div class="modal-body">
                        <!-- File Selection Section (styled like file_list, but wrapper keeps drag & drop) -->
                        <label for="captureFileInput" class="form-label">Select a folder to upload</label>
                        <input type="file"
                               id="captureFileInput"
                               name="files"
                               multiple
                               webkitdirectory
                               directory
                               class="form-control"
                               tabindex="0" />
                        <div class="upload-zone mt-2"
                             id="uploadZone"
                             aria-label="Drag and drop folder here">
                            <i class="material-icons upload-zone-icon">cloud_upload</i>
                            <div class="upload-zone-text">Drag and drop your folder here</div>
                            <div class="upload-zone-subtext">Or use the file picker above</div>
                        </div>
                        <div class="selected-files" id="selectedFiles">
                            <div class="selected-files-header">Selected Files:</div>
                            <ul class="selected-files-list" id="selectedFilesList">
                            </ul>
                        </div>
                        <!-- Progress Bar Section (initially hidden) -->
                        <div id="checkingProgressSection" class="mt-3 progress-section-hidden">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2" role="status">
                                    <span class="visually-hidden">Processing...</span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="progress progress-bar-custom">
                                        <div id="checkingProgressBar"
                                             class="progress-bar"
                                             role="progressbar"
                                             class="progress-bar progress-bar-width-0"></div>
                                    </div>
                                </div>
                                <small class="ms-2 text-muted" id="checkingProgressText">0%</small>
                            </div>
                            <small class="text-muted" id="progressMessage">Checking files for duplicates...</small>
                        </div>
                        <!-- Capture Type Selection -->
                        <div class="mt-3">
                            <label for="captureTypeSelect" class="form-label">Capture Type</label>
                            <select class="form-select"
                                    id="captureTypeSelect"
                                    name="capture_type"
                                    required
                                    tabindex="0">
                                <option value="">Select capture type...</option>
                                <option value="drf">DigitalRF</option>
                                <option value="rh">RadioHound</option>
                            </select>
                            <div class="form-text">
                                <strong>DigitalRF:</strong> For .h5/.hdf5 files with channel-based structure
                                <br />
                                <strong>RadioHound:</strong> For .rh.json files with scan group metadata
                            </div>
                        </div>
                        <!-- Channel input (DigitalRF) -->
                        <div id="channelInputGroup" class="mt-3 hidden-input-group">
                            <label for="captureChannelsInput" class="form-label">Capture Channel Names (comma-separated)</label>
                            <input type="text"
                                   id="captureChannelsInput"
                                   name="channels"
                                   class="form-control"
                                   placeholder="e.g. ch1,ch2,ch3"
                                   tabindex="0" />
                            <div class="form-text">Required for DigitalRF captures</div>
                        </div>
                        <!-- Scan Group input (RadioHound) -->
                        <div id="scanGroupInputGroup" class="mt-3 hidden-input-group">
                            <label for="captureScanGroupInput" class="form-label">Scan Group</label>
                            <input type="text"
                                   id="captureScanGroupInput"
                                   name="scan_group"
                                   class="form-control"
                                   placeholder="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
                                   tabindex="0" />
                            <div class="form-text">For RadioHound captures, optional UUID</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                                tabindex="0">Cancel</button>
                        <button type="submit"
                                class="btn btn-primary"
                                id="uploadSubmitBtn"
                                tabindex="0">
                            <span class="upload-text">Check & Upload Files</span>
                            <span class="upload-spinner d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Uploading...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Upload Result Modal -->
    <div class="modal fade"
         id="uploadResultModal"
         tabindex="-1"
         aria-labelledby="uploadResultModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadResultModalLabel">Upload Result</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            tabindex="-1"></button>
                </div>
                <div class="modal-body" id="uploadResultModalBody"></div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            tabindex="0">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload File Modal -->
    <div class="modal fade"
         id="uploadFileModal"
         tabindex="-1"
         aria-labelledby="uploadFileModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="uploadFileForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadFileModalLabel">Upload File</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"
                                tabindex="-1"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Select File</label>
                            <input type="file"
                                   id="fileInput"
                                   name="files"
                                   class="form-control"
                                   required
                                   tabindex="0" />
                        </div>
                        <div class="mb-3">
                            <label for="datasetSelect" class="form-label">Select Dataset</label>
                            <select class="form-select"
                                    id="datasetSelect"
                                    name="dataset_uuid"
                                    required
                                    tabindex="0">
                                <option value="">Select a dataset...</option>
                                {% for dataset in datasets %}<option value="{{ dataset.uuid }}">{{ dataset.name }}</option>{% endfor %}
                            </select>
                            <div class="form-text">Choose which dataset this file should be added to.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-secondary"
                                data-bs-dismiss="modal"
                                tabindex="0">Cancel</button>
                        <button type="submit"
                                class="btn btn-primary"
                                id="uploadFileSubmitBtn"
                                tabindex="0">
                            <span class="upload-text">Upload</span>
                            <span class="upload-spinner d-none">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Uploading...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- File Preview Modal -->
    <div class="modal fade"
         id="filePreviewModal"
         tabindex="-1"
         aria-labelledby="filePreviewModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="filePreviewModalLabel">File Preview</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            tabindex="-1"></button>
                </div>
                <div class="modal-body">
                    <div class="preview-content"></div>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            tabindex="0">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Include capture modal for editing -->
    {% include "users/partials/capture_modal.html" %}
    <!-- Include share modals for datasets and captures -->
    {% for item in items %}
        {% if item.is_dataset %}
            {% include "users/partials/share_modal.html" with item=item item_type="dataset" %}
        {% elif item.is_capture %}
            {% include "users/partials/share_modal.html" with item=item item_type="capture" %}
        {% endif %}
    {% endfor %}
{% endblock content %}
{% block javascript %}
    <script src="{% static 'js/components.js' %}"></script>
    <script src="{% static 'js/userSearchComponent.js' %}"></script>
    {# Fallback modal helpers provided by components.js; inline duplicates removed #}
    <script src="{% static 'js/file-manager.js' %}?v=7"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Upload Capture Modal JS

            let isProcessing = false; // Flag to track if processing is active

            // Reset cancellation state on page load

            // Add page refresh/close confirmation
            let uploadInProgress = false;

            // Clear any existing result modals on page load
            const existingResultModal = document.getElementById('uploadResultModal');
            if (existingResultModal) {
                const modalInstance = bootstrap.Modal.getInstance(existingResultModal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }

            // No session storage needed since no navigation protection

            // No beforeunload protection - user wants modal to simply close on success

            // Get button references
            const cancelButton = document.querySelector('#uploadCaptureModal .btn-secondary');
            const submitButton = document.getElementById('uploadSubmitBtn');

            // Store abort controller reference for cancellation
            let currentAbortController = null;

            // Reset cancellation state when modal is opened
            document.getElementById('uploadCaptureModal').addEventListener('show.bs.modal', function() {
                isProcessing = false;
                currentAbortController = null;
            });

            // Reset cancellation state when files are selected
            document.getElementById('captureFileInput').addEventListener('change', function() {

                isProcessing = false;
                currentAbortController = null;
            });

            // Reset cancellation state when modal is hidden
            document.getElementById('uploadCaptureModal').addEventListener('hidden.bs.modal', function() {
                isProcessing = false;
                currentAbortController = null;
            });

            // Handle cancel button click
            let cancelRequested = false;

            cancelButton.addEventListener('click', function() {
                if (isProcessing) {
                    // Cancel processing
                    cancelRequested = true;

                    // Abort current upload if controller exists
                    if (currentAbortController) {
                        currentAbortController.abort();
                    }

                    // Update UI immediately
                    cancelButton.textContent = 'Cancelling...';
                    cancelButton.disabled = true;

                    // Update progress message
                    const progressMessage = document.getElementById('progressMessage');
                    if (progressMessage) {
                        progressMessage.textContent = 'Cancelling upload...';
                    }

                    // Force UI reset after a short delay to ensure it happens
                    setTimeout(() => {
                        if (cancelRequested) {
                            resetUIState();
                        }
                    }, 500);
                } else {
                    // Normal cancel (no processing active)
                }
            });

            // Only progress bar handler runs (basic file-manager.js handler was removed)
            document.getElementById('uploadCaptureForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                // Set processing state
                isProcessing = true;
                uploadInProgress = true;
                cancelRequested = false; // Reset cancel flag for new upload



                // Check if files are selected
                if (!window.selectedFiles || window.selectedFiles.length === 0) {
                    alert('Please select files to upload.');
                    return;
                }

                // Show progress section
                const progressSection = document.getElementById('checkingProgressSection');
                const progressBar = document.getElementById('checkingProgressBar');
                const progressText = document.getElementById('checkingProgressText');
                const progressMessage = document.getElementById('progressMessage');

                progressSection.style.display = 'block';
                progressMessage.textContent = 'Checking files for duplicates...';

                // Update UI to show processing state
                cancelButton.textContent = 'Cancel Processing';
                cancelButton.classList.add('btn-warning');
                submitButton.disabled = true;

                // Initialize variables for file checking
                window.filesToSkip = new Set();
                window.fileCheckResults = new Map();
                const files = window.selectedFiles;
                const totalFiles = files.length;

                // Check each file for duplicates with progress
                for (let i = 0; i < files.length; i++) {

                    const file = files[i];

                    // Update progress
                    const progress = Math.round(((i + 1) / totalFiles) * 100);
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';

                    // Calculate BLAKE3 hash
                    const buffer = await file.arrayBuffer();
                    const hasher = await hashwasm.createBLAKE3();
                    hasher.init();
                    hasher.update(new Uint8Array(buffer));
                    const hashHex = hasher.digest('hex');

                    // Calculate directory path
                    let directory = "/";
                    if (file.webkitRelativePath) {
                        const pathParts = file.webkitRelativePath.split('/');
                        if (pathParts.length > 1) {
                            pathParts.pop();
                            directory = "/" + pathParts.join("/");
                        }
                    }

                    // Check if file exists
                    const checkData = {
                        directory: directory,
                        filename: file.name,
                        checksum: hashHex
                    };

                    try {
                        const response = await fetch("{% url 'users:check_file_exists' %}", {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify(checkData)
                        });
                        const data = await response.json();

                        // Store the result
                        const fileKey = `${directory}/${file.name}`;
                        window.fileCheckResults.set(fileKey, {
                            file: file,
                            directory: directory,
                            filename: file.name,
                            checksum: hashHex,
                            data: data.data
                        });

                        // Mark for skipping if file exists in tree
                        if (data.data && data.data.file_exists_in_tree === true) {
                            window.filesToSkip.add(fileKey);
                        }
                    } catch (error) {
                        // Error checking file
                    }

                    // Check for cancellation after each file check
                    if (cancelRequested) {
                        // Break out of the loop instead of throwing
                        break;
                    }

                }

                // Check if cancellation was requested during file checking
                if (cancelRequested) {
                    // Small delay to ensure UI updates are visible
                    await new Promise(resolve => setTimeout(resolve, 100));
                    throw new Error('Upload cancelled by user');
                }

                // Update progress message for upload phase
                progressMessage.textContent = 'Uploading files and creating captures...';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';

                // Hide progress section
                progressSection.style.display = 'none';

                // Prepare files for upload (only non-skipped files)
                const filesToUpload = [];
                const relativePathsToUpload = [];

                // Always collect all relative paths for capture creation, even for skipped files
                const allRelativePaths = [];

                for (const file of files) {
                    let directory = "/";
                    if (file.webkitRelativePath) {
                        const pathParts = file.webkitRelativePath.split('/');
                        if (pathParts.length > 1) {
                            pathParts.pop();
                            directory = "/" + pathParts.join("/");
                        }
                    }
                    const fileKey = `${directory}/${file.name}`;
                    const relativePath = file.webkitRelativePath || file.name;

                    // Add to all paths for capture creation
                    allRelativePaths.push(relativePath);

                    // Only add to upload list if not skipped
                    if (!window.filesToSkip.has(fileKey)) {
                        filesToUpload.push(file);
                        relativePathsToUpload.push(relativePath);
                    }
                }

                // Show upload progress if there are files to upload
                if (filesToUpload.length > 0) {
                    progressSection.style.display = 'block';
                    progressMessage.textContent = 'Uploading files and creating captures...';
                    progressBar.style.width = '50%';
                    progressText.textContent = '50%';
                }




                // Upload files in chunks
                try {
                    // Update progress message for upload
                    progressMessage.textContent = 'Uploading files and creating captures...';

                    // Create AbortController for upload
                    const abortController = new AbortController();
                    currentAbortController = abortController;

                    // Chunk size for file uploads
                    const CHUNK_SIZE = 5;
                    const totalFiles = filesToUpload.length;
                    let allResults = {
                        file_upload_status: 'success',
                        saved_files_count: 0,
                        captures: [],
                        errors: [],
                        message: ''
                    };

                    // Special case: if all files are skipped, send a single request without chunking
                    if (filesToUpload.length === 0) {
                        // Create form data for skipped files case
                        const skippedFormData = new FormData();

                        // Always add all relative paths for capture creation
                        allRelativePaths.forEach(path => {
                            skippedFormData.append('all_relative_paths', path);
                        });

                        // Add other form fields
                        const captureType = document.getElementById('captureTypeSelect').value;
                        skippedFormData.append('capture_type', captureType);

                        if (captureType === 'drf') {
                            const channels = document.getElementById('captureChannelsInput').value;
                            skippedFormData.append('channels', channels);
                        } else if (captureType === 'rh') {
                            const scanGroup = document.getElementById('captureScanGroupInput').value;
                            skippedFormData.append('scan_group', scanGroup);
                        }

                        // Don't send chunk information for skipped files
                        // This ensures capture creation happens

                        const response = await fetch("{% url 'users:upload_files' %}", {
                            method: 'POST',
                            body: skippedFormData,
                            signal: abortController.signal
                        });

                        const result = await response.json();

                        // Use the result directly
                        allResults = result;

                    } else {
                        // Upload files in chunks
                        for (let i = 0; i < filesToUpload.length; i += CHUNK_SIZE) {
                            const chunk = filesToUpload.slice(i, i + CHUNK_SIZE);
                            const chunkPaths = relativePathsToUpload.slice(i, i + CHUNK_SIZE);

                            // Calculate chunk information first
                            const totalChunks = Math.ceil(filesToUpload.length / CHUNK_SIZE);
                            const currentChunk = Math.floor(i / CHUNK_SIZE) + 1;
                            const isFinalChunk = currentChunk === totalChunks;

                            // Update progress
                            const progress = Math.round(((i + chunk.length) / totalFiles) * 100);
                            progressBar.style.width = progress + '%';
                            progressText.textContent = progress + '%';
                            progressMessage.textContent = `Uploading files ${i + 1}-${Math.min(i + CHUNK_SIZE, totalFiles)} of ${totalFiles} (chunk ${currentChunk}/${totalChunks})...`;

                            // Create form data for this chunk
                            const chunkFormData = new FormData();

                            // Add files for this chunk
                            chunk.forEach(file => {
                                chunkFormData.append('files', file);
                            });
                            chunkPaths.forEach(path => {
                                chunkFormData.append('relative_paths', path);
                            });

                            // Always add all relative paths for capture creation
                            allRelativePaths.forEach(path => {
                                chunkFormData.append('all_relative_paths', path);
                            });

                            // Add other form fields
                            const captureType = document.getElementById('captureTypeSelect').value;
                            chunkFormData.append('capture_type', captureType);

                            if (captureType === 'drf') {
                                const channels = document.getElementById('captureChannelsInput').value;
                                chunkFormData.append('channels', channels);
                            } else if (captureType === 'rh') {
                                const scanGroup = document.getElementById('captureScanGroupInput').value;
                                chunkFormData.append('scan_group', scanGroup);
                            }

                            // Add chunk information
                            chunkFormData.append('is_chunk', 'true');
                            chunkFormData.append('chunk_number', currentChunk.toString());
                            chunkFormData.append('total_chunks', totalChunks.toString());

                            // Check for cancellation before starting this chunk
                            if (cancelRequested) {
                                break; // Break out of the chunk loop
                            }

                            // Upload this chunk with timeout
                            const controller = new AbortController();
                            currentAbortController = controller; // Update current controller for this chunk
                            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minute timeout

                            let response;
                            let chunkResult;

                            try {
                                response = await fetch("{% url 'users:upload_files' %}", {
                                    method: 'POST',
                                    body: chunkFormData,
                                    signal: controller.signal
                                });

                                clearTimeout(timeoutId);

                                if (!response.ok) {
                                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                                }

                                chunkResult = await response.json();

                            } catch (error) {
                                clearTimeout(timeoutId);
                                if (error.name === 'AbortError') {
                                    throw new Error('Upload timeout - connection may be lost');
                                }
                                throw error;
                            }

                            // Merge results
                            if (chunkResult.saved_files_count !== undefined) {
                                allResults.saved_files_count += chunkResult.saved_files_count;
                            }
                            // Only collect captures from the final chunk
                            if (chunkResult.captures && isFinalChunk) {
                                allResults.captures = allResults.captures.concat(chunkResult.captures);
                            }
                            if (chunkResult.errors) {
                                allResults.errors = allResults.errors.concat(chunkResult.errors);
                            }

                            // Check if any chunk failed
                            if (chunkResult.file_upload_status === 'error') {
                                allResults.file_upload_status = 'error';
                                allResults.message = chunkResult.message || 'Upload failed';
                                // Update progress message to show upload was aborted
                                const progressMessage = document.getElementById('progressMessage');
                                if (progressMessage) {
                                    progressMessage.textContent = 'Upload aborted due to errors. Please check the results.';
                                }
                                // Abort uploading on error
                                break; // Break out of the chunk loop
                            } else if (chunkResult.file_upload_status === 'success') {
                                // Only update to success if this is the final chunk
                                if (isFinalChunk) {
                                    allResults.file_upload_status = 'success';
                                }
                            }

                            // Check if cancel was requested between chunks
                            if (cancelRequested) {
                                break; // Break out of the chunk loop
                            }
                        }
                    }

                    // Check if cancellation was requested during chunk upload
                    if (cancelRequested) {
                        // Small delay to ensure UI updates are visible
                        await new Promise(resolve => setTimeout(resolve, 100));
                        throw new Error('Upload cancelled by user');
                    }

                    // Check if upload was aborted due to errors
                    if (allResults.file_upload_status === 'error') {
                        // Clear the reference since upload was aborted
                        currentAbortController = null;
                        // Show error results
                        showUploadResults(allResults, allResults.saved_files_count, totalFiles);
                        return; // Exit early, don't continue with normal flow
                    }

                    // Clear the reference since upload completed
                    currentAbortController = null;

                    // Show results
                    showUploadResults(allResults, allResults.saved_files_count, totalFiles);

                    // Don't auto-reload for successful uploads - let user close modal first
                } catch (error) {
                    if (cancelRequested) {
                        alert('Upload cancelled. Any files uploaded before cancellation have been saved.');
                        // Reload page after cancellation
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else if (error.name === 'AbortError') {
                        alert('Upload was interrupted. Any files uploaded before the interruption have been saved.');
                        // Reload page after interruption
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        alert('Network error during upload. Please check your connection and try again.');
                    } else {
                        alert('Upload failed: ' + error.message);
                        // Reload page after other errors
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                } finally {
                    // Clean up UI state - ensure this always runs
                    resetUIState();
                }
            });

            // Function to reset UI state
            function resetUIState() {

                // Reset submit button
                submitButton.disabled = false;

                // Hide progress section
                const progressSection = document.getElementById('checkingProgressSection');
                if (progressSection) {
                    progressSection.style.display = 'none';
                }

                // Reset cancel button
                cancelButton.textContent = 'Cancel';
                cancelButton.classList.remove('btn-warning');
                cancelButton.disabled = false;

                // Reset progress elements
                const progressBar = document.getElementById('checkingProgressBar');
                const progressText = document.getElementById('checkingProgressText');
                const progressMessage = document.getElementById('progressMessage');

                if (progressBar) progressBar.style.width = '0%';
                if (progressText) progressText.textContent = '0%';
                if (progressMessage) progressMessage.textContent = '';

                // Reset state flags
                isProcessing = false;
                uploadInProgress = false;
                cancelRequested = false;

                // State cleared above

                // Clear abort controller
                currentAbortController = null;
            }

            // Function to handle upload completion
            function showUploadResults(result, uploadedCount, totalCount) {
                // Close the upload modal
                const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadCaptureModal'));
                if (uploadModal) {
                    uploadModal.hide();
                }

                if (result.file_upload_status === 'success') {
                    // Success - just reload the page to show updated file list
                    setTimeout(() => {
                        window.location.reload();
                    }, 500); // Small delay to let modal close animation finish
                } else {
                    // Only show error modal for failures
                    let modalBody = document.getElementById('uploadResultModalBody');
                    let resultModalEl = document.getElementById('uploadResultModal');
                    let modal = new bootstrap.Modal(resultModalEl);

                    let msg = '<b>Upload Failed</b><br />';
                    if (result.message) {
                        msg += `${result.message}<br /><br />`;
                    }
                    msg += '<b>Please remove the problematic files and try again.</b>';

                    if (result.errors && result.errors.length > 0) {
                        let errs = result.errors.map(e => `<li>${e}</li>`).join('');
                        msg += `<br /><br /><b>Error Details:</b><ul>${errs}</ul>`;
                    }
                    modalBody.innerHTML = msg;
                    modal.show();
                }
            }
        });
    </script>
    <!-- Capture Type Selection JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const captureTypeSelect = document.getElementById('captureTypeSelect');
            const channelInputGroup = document.getElementById('channelInputGroup');
            const scanGroupInputGroup = document.getElementById('scanGroupInputGroup');
            const captureChannelsInput = document.getElementById('captureChannelsInput');
            const captureScanGroupInput = document.getElementById('captureScanGroupInput');

            if (captureTypeSelect) {
                captureTypeSelect.addEventListener('change', function() {
                    const selectedType = this.value;

                    // Hide both input groups initially
                    if (channelInputGroup) channelInputGroup.classList.add('hidden-input-group');
                    if (scanGroupInputGroup) scanGroupInputGroup.classList.add('hidden-input-group');

                    // Clear required attributes
                    if (captureChannelsInput) captureChannelsInput.removeAttribute('required');
                    if (captureScanGroupInput) captureScanGroupInput.removeAttribute('required');

                    // Show appropriate input group based on selection
                    if (selectedType === 'drf') {
                        if (channelInputGroup) channelInputGroup.classList.remove('hidden-input-group');
                        if (captureChannelsInput) captureChannelsInput.setAttribute('required', 'required');
                    } else if (selectedType === 'rh') {
                        if (scanGroupInputGroup) scanGroupInputGroup.classList.remove('hidden-input-group');
                        // scan_group is optional for RadioHound captures
                    }
                });
            }

            // Reset form when modal is hidden
            const uploadModal = document.getElementById('uploadCaptureModal');
            if (uploadModal) {
                uploadModal.addEventListener('hidden.bs.modal', function() {
                    // Reset the form
                    const form = document.getElementById('uploadCaptureForm');
                    if (form) {
                        form.reset();
                    }

                    // Hide input groups
                    if (channelInputGroup) channelInputGroup.classList.add('hidden-input-group');
                    if (scanGroupInputGroup) scanGroupInputGroup.classList.add('hidden-input-group');

                    // Clear required attributes
                    if (captureChannelsInput) captureChannelsInput.removeAttribute('required');
                    if (captureScanGroupInput) captureScanGroupInput.removeAttribute('required');

                    // Clear global variables
                    window.filesToSkip.clear();
                    window.fileCheckResults.clear();
                });
            }
        });
    </script>
    <!-- This code calculates BLAKE3 hashes in the browser for file deduplication -->
    <!-- Load the WASM library first -->
    <script src="https://cdn.jsdelivr.net/npm/hash-wasm@4.12.0/dist/blake3.umd.min.js"></script>
    <script>
        // Global variable to track files that should be skipped
        window.filesToSkip = new Set();
        window.fileCheckResults = new Map(); // Store detailed results for each file

        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('uploadCaptureModal');
            if (!modal) {
                console.warn('uploadCaptureModal not found');
                return;
            }
            modal.addEventListener('shown.bs.modal', function() {
                var fileInput = document.getElementById('captureFileInput');
                if (!fileInput) {
                    console.warn('captureFileInput not found');
                    return;
                }
                // Remove any previous handler to avoid duplicates
                fileInput.removeEventListener('change', window._blake3CaptureHandler);

                // Simple file handler that just stores the selected files
                window._blake3CaptureHandler = async function(event) {
                    const files = event.target.files;
                    if (!files || files.length === 0) {
                        return;
                    }

                    // Store the selected files for later processing
                    window.selectedFiles = Array.from(files);
                };
                fileInput.addEventListener('change', window._blake3CaptureHandler);
            });
        });
    </script>
    <script>
        // Initialize capture table manager for capture edit functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize ModalManager for capture modal
            let modalManager = null;
            if (window.ModalManager) {
                modalManager = new window.ModalManager({
                    modalId: "capture-modal",
                    modalBodyId: "capture-modal-body",
                    modalTitleId: "capture-modal-label",
                });
            }

            // Initialize CapturesTableManager for capture edit/download functionality
            if (window.CapturesTableManager) {
                window.capturesTableManager = new window.CapturesTableManager({
                    modalHandler: modalManager,
                });
            }

            // Create a UserSearchHandler for each share modal
            document.querySelectorAll('.modal[data-item-uuid]').forEach(modal => {
                const itemUuid = modal.getAttribute('data-item-uuid');
                const itemType = modal.getAttribute('data-item-type');
                if (window.UserSearchHandler) {
                    const handler = new window.UserSearchHandler();
                    // Store the handler on the modal element
                    modal.userSearchHandler = handler;
                }

                // On modal show, set the item info and call init()
                modal.addEventListener('show.bs.modal', function() {
                    if (modal.userSearchHandler) {
                        modal.userSearchHandler.setItemInfo(itemUuid, itemType);
                        modal.userSearchHandler.init();
                    }
                });

                // On modal hide, reset all selections and entered data
                modal.addEventListener('hidden.bs.modal', function() {
                    if (modal.userSearchHandler) {
                        modal.userSearchHandler.resetAll();
                    }
                });
            });
        });
    </script>
{% endblock javascript %}
