<!-- Generic Share Modal -->
<div class="modal fade"
     id="share-modal-{{ item.uuid }}"
     data-item-uuid="{{ item.uuid }}"
     data-item-type="{{ item_type }}"
     tabindex="-1"
     aria-labelledby="share-modal-label-{{ item.uuid }}"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="share-modal-label-{{ item.uuid }}">Share {{ item_type|title }}</h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fw-bold">Share this {{ item_type }} with others:</p>
                <div>
                    <form id="share-form-{{ item.uuid }}"
                          action="{% url 'users:share_item' item_type item.uuid %}"
                          method="post">
                        {% csrf_token %}
                        <div class="user-search-input-container">
                            <input type="text"
                                   class="form-control user-search-input mb-3"
                                   placeholder="Search users by name or email..."
                                   id="user-search-{{ item.uuid }}"
                                   name="user-search"
                                   autocomplete="off" />
                            <!-- User search dropdown -->
                            <div class="user-search-dropdown d-none"
                                 id="user-search-dropdown-{{ item.uuid }}">
                                <div class="list-group">
                                    <!-- Search results will be populated here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Users with Individual Permission Levels -->
                        <div class="selected-users-permissions-section mb-3">
                            <label class="form-label fw-bold">
                                <i class="bi bi-shield-lock me-1"></i>Selected Users & Permission Levels:
                            </label>
                            <div class="selected-users-chips d-flex flex-column gap-2"></div>
                            <div class="form-text">
                                <small class="text-muted">
                                    <strong>Viewer:</strong> Can view dataset information and download files<br>
                                    <strong>Contributor:</strong> Can add their own assets to the dataset<br>
                                    <strong>Co-Owner:</strong> Can add/remove assets and edit dataset metadata
                                </small>
                            </div>
                        </div>
                        
                        <!-- Notify/message section, shown only if chips are present -->
                        <div id="notify-message-section-{{ item.uuid }}" class="d-none mt-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input"
                                       type="checkbox"
                                       value="1"
                                       id="notify-users-checkbox-{{ item.uuid }}"
                                       name="notify_users"
                                       checked />
                                <label class="form-check-label" for="notify-users-checkbox-{{ item.uuid }}">Notify users by email</label>
                            </div>
                            <div id="notify-message-textarea-container-{{ item.uuid }}"
                                 class="mb-2 notify-message-anim">
                                <textarea class="form-control"
                                          id="notify-message-textarea-{{ item.uuid }}"
                                          name="notify_message"
                                          rows="3"
                                          placeholder="Add a message (optional)"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <hr class="modal-divider" />
                <!-- Users with Access section, hidden if chips are present -->
                <div id="users-with-access-section-{{ item.uuid }}">
                    <p class="fw-bold">Users with Access:</p>
                    <table class="table table-bordered rounded-3">
                        <tbody>
                            <!-- Owner row -->
                            <tr>
                                <td class="p-2 shadow-sm">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <div>
                                                <h5 class="mb-1">
                                                    {{ item.owner_name|default:"Owner" }}
                                                    <i class="bi bi-person-fill text-primary"
                                                       data-bs-toggle="tooltip"
                                                       title="Owner"></i>
                                                </h5>
                                                <p class="mb-0">
                                                    <small class="text-muted">{{ item.owner_email }}</small>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="col-md-2 d-flex justify-content-end align-items-center">
                                            <h5>
                                                <span class="badge bg-primary ms-2 align-middle">Owner</span>
                                            </h5>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <!-- Shared users and groups (excluding owner) -->
                            {% for user in item.shared_users %}
                                {% if user.email != item.owner_email %}
                                    <tr>
                                        <td class="p-2 shadow-sm">
                                            <div class="row">
                                                <div class="col-md-10">
                                                    <div>
                                                        <h5 class="mb-1">
                                                            {% if user.type == "group" %}
                                                                <i class="bi bi-people-fill text-info me-1"
                                                                   data-bs-toggle="tooltip"
                                                                   title="Group"></i>
                                                                {{ user.name }}
                                                                <span class="badge bg-secondary ms-1">{{ user.member_count }} members</span>
                                                            {% else %}
                                                                <i class="bi bi-person-fill text-primary me-1"
                                                                   data-bs-toggle="tooltip"
                                                                   title="User"></i>
                                                                {{ user.name }}
                                                            {% endif %}
                                                        </h5>
                                                        <p class="mb-0">
                                                            <small class="text-muted">
                                                                {% if user.type == "group" %}
                                                                    Group â€¢ Hover to see members
                                                                {% else %}
                                                                    {{ user.email }}
                                                                {% endif %}
                                                            </small>
                                                        </p>
                                                        {% if user.type == "group" %}
                                                            <div class="group-members-popup d-none">
                                                                <div class="popover-header">Group Members</div>
                                                                <div class="popover-body">
                                                                    <small class="text-muted">
                                                                        {% for member in user.members %}
                                                                            {{ member.name }} &lt;{{ member.email }}&gt;
                                                                            <br />
                                                                        {% endfor %}
                                                                    </small>
                                                                </div>
                                                            </div>
                                                            <!-- Group Permission Management -->
                                                            <div class="group-permission-management mt-2">
                                                                <div class="d-flex align-items-center gap-2">
                                                                    <small class="text-muted">Group Permission:</small>
                                                                    <select class="form-select form-select-sm group-permission-selector" 
                                                                            data-group-uuid="{{ user.email|slice:'6:' }}"
                                                                            data-item-uuid="{{ item.uuid }}"
                                                                            data-item-type="{{ item_type }}"
                                                                            style="min-width: 120px;">
                                                                        <option value="viewer" {% if user.permission_level == 'viewer' %}selected{% endif %}>
                                                                            <i class="bi bi-eye"></i> Viewer
                                                                        </option>
                                                                        <option value="contributor" {% if user.permission_level == 'contributor' %}selected{% endif %}>
                                                                            <i class="bi bi-plus-circle"></i> Contributor
                                                                        </option>
                                                                        <option value="co-owner" {% if user.permission_level == 'co-owner' %}selected{% endif %}>
                                                                            <i class="bi bi-gear"></i> Co-Owner
                                                                        </option>
                                                                        <option value="multiple" {% if user.permission_level == 'multiple' %}selected{% endif %}>
                                                                            <i class="bi bi-three-dots"></i> Multiple
                                                                        </option>
                                                                    </select>
                                                                </div>
                                                                <!-- Individual Member Permissions (collapsible) -->
                                                                <div class="member-permissions mt-2" style="display: none;">
                                                                    <small class="text-muted d-block mb-1">Individual Permissions:</small>
                                                                    {% for member in user.members %}
                                                                        <div class="d-flex align-items-center gap-2 mb-1">
                                                                            <small class="text-muted" style="min-width: 120px;">{{ member.name }}:</small>
                                                                            <select class="form-select form-select-sm member-permission-selector" 
                                                                                    data-group-uuid="{{ user.email|slice:'6:' }}"
                                                                                    data-member-email="{{ member.email }}"
                                                                                    data-item-uuid="{{ item.uuid }}"
                                                                                    data-item-type="{{ item_type }}"
                                                                                    style="min-width: 100px;">
                                                                                <option value="viewer">Viewer</option>
                                                                                <option value="contributor">Contributor</option>
                                                                                <option value="co-owner">Co-Owner</option>
                                                                            </select>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                                <button type="button" class="btn btn-sm btn-outline-secondary mt-1 toggle-member-permissions">
                                                                    <i class="bi bi-chevron-down"></i> Manage Individual Permissions
                                                                </button>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="col-md-2 d-flex justify-content-end align-items-center">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <!-- Access Level Dropdown Button -->
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm dropdown-toggle access-level-dropdown"
                                                                    type="button"
                                                                    data-bs-toggle="dropdown"
                                                                    data-bs-popper="static"
                                                                    aria-expanded="false"
                                                                    data-user-email="{{ user.email }}"
                                                                    data-user-name="{{ user.name }}"
                                                                    data-item-uuid="{{ item.uuid }}"
                                                                    data-item-type="{{ item_type }}"
                                                                    data-current-permission="{{ user.permission_level }}">
                                                                {% if user.permission_level == 'viewer' %}
                                                                    <i class="bi bi-eye me-1"></i>Viewer
                                                                {% elif user.permission_level == 'contributor' %}
                                                                    <i class="bi bi-plus-circle me-1"></i>Contributor
                                                                {% elif user.permission_level == 'co-owner' %}
                                                                    <i class="bi bi-gear me-1"></i>Co-Owner
                                                                {% else %}
                                                                    <i class="bi bi-question-circle me-1"></i>{{ user.permission_level|title }}
                                                                {% endif %}
                                                            </button>
                                                            <ul class="dropdown-menu access-level-menu">
                                                                <li>
                                                                    <button class="dropdown-item permission-change-btn {% if user.permission_level == 'viewer' %}selected{% endif %}"
                                                                            type="button"
                                                                            data-permission-level="viewer">
                                                                        <i class="bi bi-eye me-2"></i>Viewer
                                                                        {% if user.permission_level == 'viewer' %}
                                                                            <i class="bi bi-check ms-auto"></i>
                                                                        {% endif %}
                                                                    </button>
                                                                </li>
                                                                <li>
                                                                    <button class="dropdown-item permission-change-btn {% if user.permission_level == 'contributor' %}selected{% endif %}"
                                                                            type="button"
                                                                            data-permission-level="contributor">
                                                                        <i class="bi bi-plus-circle me-2"></i>Contributor
                                                                        {% if user.permission_level == 'contributor' %}
                                                                            <i class="bi bi-check ms-auto"></i>
                                                                        {% endif %}
                                                                    </button>
                                                                </li>
                                                                <li>
                                                                    <button class="dropdown-item permission-change-btn {% if user.permission_level == 'co-owner' %}selected{% endif %}"
                                                                            type="button"
                                                                            data-permission-level="co-owner">
                                                                        <i class="bi bi-gear me-2"></i>Co-Owner
                                                                        {% if user.permission_level == 'co-owner' %}
                                                                            <i class="bi bi-check ms-auto"></i>
                                                                        {% endif %}
                                                                    </button>
                                                                </li>
                                                                <li>
                                                                    <hr class="dropdown-divider" />
                                                                </li>
                                                                <li>
                                                                    <button class="dropdown-item text-danger remove-access-btn permission-change-btn"
                                                                            type="button"
                                                                            data-user-email="{{ user.email }}"
                                                                            data-user-name="{{ user.name }}"
                                                                            data-item-uuid="{{ item.uuid }}"
                                                                            data-item-type="{{ item_type }}">
                                                                        <i class="bi bi-person-slash me-2"></i>Remove access
                                                                    </button>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex align-items-center gap-2">
                        <span id="pending-changes-message-{{ item.uuid }}"
                              class="text-muted d-none">
                            <i class="bi bi-exclamation-triangle me-1"></i>Pending changes
                        </span>
                        <button type="button"
                                class="btn btn-primary"
                                id="share-item-btn-{{ item.uuid }}"
                                disabled>Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
            // Group member popup functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize access level dropdowns
            const accessLevelDropdowns = document.querySelectorAll('.access-level-dropdown');
            accessLevelDropdowns.forEach(dropdown => {
                const currentPermission = dropdown.getAttribute('data-current-permission');
                const dropdownMenu = dropdown.nextElementSibling;
                const permissionBtns = dropdownMenu.querySelectorAll('.permission-change-btn');
                
                // Mark current permission as selected
                permissionBtns.forEach(btn => {
                    if (btn.getAttribute('data-permission-level') === currentPermission) {
                        btn.classList.add('selected');
                    }
                });
                
                // Colors are now handled by CSS based on data-current-permission attribute
            });
            
            const groupRows = document.querySelectorAll('tr:has(.bi-people-fill)');

        groupRows.forEach(row => {
            const popup = row.querySelector('.group-members-popup');
            if (popup) {
                row.addEventListener('mouseenter', function() {
                    popup.style.display = 'block';
                });

                row.addEventListener('mouseleave', function() {
                    popup.style.display = 'none';
                });
            }
        });

        // Store pending changes for each modal
        const pendingChanges = new Map();
        
        // Permission level change functionality
        const permissionChangeBtns = document.querySelectorAll('.permission-change-btn');
        permissionChangeBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const newPermissionLevel = this.getAttribute('data-permission-level');
                const dropdown = this.closest('.dropdown');
                const dropdownButton = dropdown.querySelector('.access-level-dropdown');
                const userEmail = dropdownButton.getAttribute('data-user-email');
                const userName = dropdownButton.getAttribute('data-user-name');
                const itemUuid = dropdownButton.getAttribute('data-item-uuid');
                const itemType = dropdownButton.getAttribute('data-item-type');
                const currentPermission = dropdownButton.getAttribute('data-current-permission');
                
                // Don't do anything if selecting the same permission
                if (newPermissionLevel === currentPermission) {
                    return;
                }
                
                // Update the dropdown button text and icon
                const iconClass = newPermissionLevel === 'viewer' ? 'bi-eye' : 
                                newPermissionLevel === 'contributor' ? 'bi-plus-circle' : 
                                newPermissionLevel === 'co-owner' ? 'bi-gear' : 'bi-question-circle';
                
                dropdownButton.innerHTML = `<i class="bi ${iconClass} me-1"></i>${newPermissionLevel.charAt(0).toUpperCase() + newPermissionLevel.slice(1)}`;
                dropdownButton.setAttribute('data-current-permission', newPermissionLevel);
                
                // Update button colors based on permission level
                dropdownButton.className = 'btn btn-sm dropdown-toggle access-level-dropdown';
                // Colors are now handled by CSS based on data-current-permission attribute
                
                // Update checkmarks in dropdown menu
                const dropdownMenu = dropdown.querySelector('.access-level-menu');
                const allPermissionBtns = dropdownMenu.querySelectorAll('.permission-change-btn');
                
                // Remove selected class and checkmarks from all buttons
                allPermissionBtns.forEach(btn => {
                    btn.classList.remove('selected');
                    const checkmark = btn.querySelector('.bi-check');
                    if (checkmark) {
                        checkmark.remove();
                    }
                });
                
                // Add selected class and checkmark to the clicked button
                this.classList.add('selected');
                const checkmark = document.createElement('i');
                checkmark.className = 'bi bi-check ms-auto';
                this.appendChild(checkmark);
                
                // Store the pending change
                const form = dropdown.closest('form');
                const modalId = form.id;
                if (!pendingChanges.has(modalId)) {
                    pendingChanges.set(modalId, { permissionChanges: [], removals: [] });
                }
                
                const changes = pendingChanges.get(modalId);
                // Remove any existing permission change for this user
                changes.permissionChanges = changes.permissionChanges.filter(change => change.userEmail !== userEmail);
                // Add the new permission change
                changes.permissionChanges.push({
                    userEmail: userEmail,
                    userName: userName,
                    itemUuid: itemUuid,
                    itemType: itemType,
                    newPermissionLevel: newPermissionLevel
                });
                
                // Enable save button and show pending changes
                const saveButton = form.querySelector('[id^="share-item-btn-"]');
                const pendingMessage = form.querySelector('[id^="pending-changes-message-"]');
                
                if (saveButton) saveButton.disabled = false;
                if (pendingMessage) pendingMessage.classList.remove('d-none');
                
                // Close the dropdown
                const bsDropdown = bootstrap.Dropdown.getInstance(dropdownButton);
                if (bsDropdown) {
                    bsDropdown.hide();
                }
            });
        });
        
        // Remove access functionality
        const removeAccessBtns = document.querySelectorAll('.remove-access-btn');
        removeAccessBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const userEmail = this.getAttribute('data-user-email');
                const userName = this.getAttribute('data-user-name');
                const itemUuid = this.getAttribute('data-item-uuid');
                const itemType = this.getAttribute('data-item-type');
                
                // Find the user row and cross out the name
                const userRow = this.closest('tr');
                const userNameElement = userRow.querySelector('h5');
                if (userNameElement) {
                    userNameElement.style.textDecoration = 'line-through';
                    userNameElement.style.opacity = '0.6';
                }
                
                // Store the pending removal
                const form = this.closest('form');
                const modalId = form.id;
                if (!pendingChanges.has(modalId)) {
                    pendingChanges.set(modalId, { permissionChanges: [], removals: [] });
                }
                
                const changes = pendingChanges.get(modalId);
                // Remove any existing removal for this user
                changes.removals = changes.removals.filter(removal => removal.userEmail !== userEmail);
                // Add the new removal
                changes.removals.push({
                    userEmail: userEmail,
                    userName: userName,
                    itemUuid: itemUuid,
                    itemType: itemType
                });
                
                // Enable save button and show pending changes
                const saveButton = form.querySelector('[id^="share-item-btn-"]');
                const pendingMessage = form.querySelector('[id^="pending-changes-message-"]');
                
                if (saveButton) saveButton.disabled = false;
                if (pendingMessage) pendingMessage.classList.remove('d-none');
                
                // Close the dropdown
                const dropdown = this.closest('.dropdown');
                const dropdownButton = dropdown.querySelector('.access-level-dropdown');
                const bsDropdown = bootstrap.Dropdown.getInstance(dropdownButton);
                if (bsDropdown) {
                    bsDropdown.hide();
                }
            });
        });

        // Save button functionality
        const saveButtons = document.querySelectorAll('[id^="share-item-btn-"]');
        saveButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const form = this.closest('form');
                const modalId = form.id;
                const changes = pendingChanges.get(modalId);
                
                if (!changes || (changes.permissionChanges.length === 0 && changes.removals.length === 0)) {
                    return;
                }
                
                // Disable save button and show loading state
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';
                
                // Process permission changes
                const permissionPromises = changes.permissionChanges.map(change => {
                    return fetch(`/users/share/${change.itemType}/${change.itemUuid}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: `user_email=${encodeURIComponent(change.userEmail)}&permission_level=${encodeURIComponent(change.newPermissionLevel)}`
                    }).then(response => response.json());
                });
                
                // Process removals
                const removalPromises = changes.removals.map(removal => {
                    return fetch(`/users/share/${removal.itemType}/${removal.itemUuid}/`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: `user_email=${encodeURIComponent(removal.userEmail)}`
                    }).then(response => response.json());
                });
                
                // Execute all changes
                Promise.all([...permissionPromises, ...removalPromises])
                    .then(results => {
                        const successCount = results.filter(result => result.success).length;
                        const totalCount = results.length;
                        
                        if (successCount === totalCount) {
                            // All changes successful
                            alert(`Successfully updated ${successCount} permission(s)`);
                            
                            // Clear pending changes
                            pendingChanges.delete(modalId);
                            
                            // Reset UI
                            const pendingMessage = form.querySelector('[id^="pending-changes-message-"]');
                            if (pendingMessage) pendingMessage.classList.add('d-none');
                            
                            // Close modal
                            const modal = form.closest('.modal');
                            const bsModal = bootstrap.Modal.getInstance(modal);
                            if (bsModal) {
                                bsModal.hide();
                            }
                            
                            // Reload page to reflect changes
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            // Some changes failed
                            const failedCount = totalCount - successCount;
                            alert(`Updated ${successCount} permission(s), but ${failedCount} failed. Please try again.`);
                        }
                    })
                    .catch(error => {
                        console.error('Error saving changes:', error);
                        alert('An error occurred while saving changes. Please try again.');
                    })
                    .finally(() => {
                        // Reset save button
                        this.disabled = false;
                        this.innerHTML = 'Save';
                    });
            });
        });

        // Update share button state based on selected users and permission level
        function updateShareButtonState(form) {
            const selectedChips = form.querySelectorAll('.selected-user-chip');
            const saveButton = form.querySelector('[id^="share-item-btn-"]');
            const pendingMessage = form.querySelector('[id^="pending-changes-message-"]');
            
            if (selectedChips.length > 0) {
                if (saveButton) saveButton.disabled = false;
                if (pendingMessage) pendingMessage.classList.remove('d-none');
            } else {
                if (saveButton) saveButton.disabled = true;
                if (pendingMessage) pendingMessage.classList.add('d-none');
            }
        }

        // Listen for changes in selected users
        document.addEventListener('userSelected', function(e) {
            const form = e.target.closest('form');
            if (form) {
                updateShareButtonState(form);
            }
        });

        document.addEventListener('userRemoved', function(e) {
            const form = e.target.closest('form');
            if (form) {
                updateShareButtonState(form);
            }
        });
    });
</script>
