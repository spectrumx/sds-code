{% load tz %}

<!-- Search Published Datasets Content -->
<!-- Search Form -->
{% include "users/partials/dataset_search_form.html" with show_clear_button=True %}
<!-- Results count display -->
{% if page_obj.object_list %}
    <div class="d-flex justify-content-end mb-3">
        <span id="search-results-count" aria-live="polite" class="text-muted">
            {{ page_obj.paginator.count }} dataset{{ page_obj.paginator.count|pluralize }} found
        </span>
    </div>
{% endif %}
<!-- Search Results Table -->
<div id="search-results-container" class="table-and-pagination">
    <div class="table-container">
        <div class="table-responsive">
            {% if not page_obj or not page_obj.object_list %}
                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">No datasets found</h4>
                    <p>
                        {% if search_form.query.value or search_form.keywords.value or search_form.min_frequency.value or search_form.max_frequency.value %}
                            Try adjusting your search criteria or <a href="{% url 'users:search_datasets' %}" class="alert-link">clear the filters</a> to see all published datasets.
                        {% else %}
                            There are no published datasets available yet.
                        {% endif %}
                    </p>
                </div>
            {% else %}
                <table class="table table-striped table-hover datasets-table-fixed">
                    <caption class="visually-hidden">Published datasets search results</caption>
                    <thead>
                        <tr>
                            <th scope="col" class="w-30">Dataset Name</th>
                            <th scope="col" class="w-25">Authors</th>
                            <th scope="col" class="w-20">Keywords</th>
                            <th scope="col" class="w-15">Created At</th>
                            <th scope="col" class="w-10">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="search-results-tbody">
                        {% for dataset in page_obj %}
                            <tr class="clickable-row" data-dataset-uuid="{{ dataset.uuid }}">
                                <td class="text-nowrap">
                                    <a href="#"
                                       class="dataset-name-link"
                                       data-bs-toggle="modal"
                                       data-bs-target="#datasetDetailsModal"
                                       data-dataset-uuid="{{ dataset.uuid }}"
                                       aria-label="View details for {{ dataset.name }}">{{ dataset.name }}</a>
                                    {% if dataset.is_public %}<i class="bi bi-globe me-1 text-primary" title="Public"></i>{% endif %}
                                </td>
                                <td class="text-break">
                                    {% if dataset.authors %}
                                        {% for author in dataset.authors %}
                                            {% if forloop.counter <= 2 %}
                                                {% if author.name %}
                                                    {% if author.orcid_id %}
                                                        <a href="https://orcid.org/{{ author.orcid_id }}"
                                                           target="_blank"
                                                           rel="noopener noreferrer"
                                                           class="text-decoration-none"
                                                           title="View {{ author.name }}'s ORCID profile">
                                                            {{ author.name }}
                                                            <i class="bi bi-box-arrow-up-right text-muted sort-icon"></i>
                                                        </a>
                                                    {% else %}
                                                        {{ author.name }}
                                                    {% endif %}
                                                    {% if not forloop.last and forloop.counter < 2 and dataset.authors|length > 1 %},{% endif %}
                                                {% else %}
                                                    {{ author }}
                                                    {% if not forloop.last and forloop.counter < 2 and dataset.authors|length > 1 %},{% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if dataset.authors|length > 2 %}<span class="text-muted">...</span>{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-break">
                                    {% if dataset.keywords %}
                                        {% for keyword in dataset.keywords|slice:":3" %}
                                            <span class="badge bg-secondary me-1">{{ keyword }}</span>
                                        {% endfor %}
                                        {% if dataset.keywords|length > 3 %}<span class="text-muted">...</span>{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-nowrap">
                                    {% if dataset.dataset.created_at %}
                                        {% localtime on %}
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="bg-transparent pe-2">{{ dataset.dataset.created_at|date:"Y-m-d" }}</span>
                                            <span class="text-muted bg-transparent">{{ dataset.dataset.created_at|date:"H:i:s T" }}</span>
                                        </div>
                                    {% endlocaltime %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-light dropdown-toggle btn-icon-dropdown"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            data-bs-boundary="viewport"
                                            aria-expanded="false"
                                            aria-label="Actions for {{ dataset.name }}">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item"
                                                    type="button"
                                                    onclick="showWebDownloadModal('{{ dataset.uuid }}', '{{ dataset.name }}')">
                                                <i class="bi bi-download me-2"></i>Web Download
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    type="button"
                                                    onclick="showSDKDownloadModal('{{ dataset.uuid }}')">
                                                <i class="bi bi-code-slash me-2"></i>SDK Download Instructions
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    </div>
</div>
<!-- Pagination for Search Results -->
{% if page_obj and page_obj.has_other_pages %}
    <nav aria-label="Search results pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page=1{% if search_form.query.value %}&query={{ search_form.query.value|urlencode }}{% endif %}{% if search_form.keywords.value %}&keywords={{ search_form.keywords.value|urlencode }}{% endif %}{% if search_form.min_frequency.value %}&min_frequency={{ search_form.min_frequency.value }}{% endif %}{% if search_form.max_frequency.value %}&max_frequency={{ search_form.max_frequency.value }}{% endif %}">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ page_obj.previous_page_number }}{% if search_form.query.value %}&query={{ search_form.query.value|urlencode }}{% endif %}{% if search_form.keywords.value %}&keywords={{ search_form.keywords.value|urlencode }}{% endif %}{% if search_form.min_frequency.value %}&min_frequency={{ search_form.min_frequency.value }}{% endif %}{% if search_form.max_frequency.value %}&max_frequency={{ search_form.max_frequency.value }}{% endif %}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">First</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ page_obj.next_page_number }}{% if search_form.query.value %}&query={{ search_form.query.value|urlencode }}{% endif %}{% if search_form.keywords.value %}&keywords={{ search_form.keywords.value|urlencode }}{% endif %}{% if search_form.min_frequency.value %}&min_frequency={{ search_form.min_frequency.value }}{% endif %}{% if search_form.max_frequency.value %}&max_frequency={{ search_form.max_frequency.value }}{% endif %}">Next</a>
                </li>
                <li class="page-item">
                    <a class="page-link"
                       href="?page={{ page_obj.paginator.num_pages }}{% if search_form.query.value %}&query={{ search_form.query.value|urlencode }}{% endif %}{% if search_form.keywords.value %}&keywords={{ search_form.keywords.value|urlencode }}{% endif %}{% if search_form.min_frequency.value %}&min_frequency={{ search_form.min_frequency.value }}{% endif %}{% if search_form.max_frequency.value %}&max_frequency={{ search_form.max_frequency.value }}{% endif %}">Last</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Last</span>
                </li>
            {% endif %}
        </ul>
    </nav>
{% endif %}
</div>
