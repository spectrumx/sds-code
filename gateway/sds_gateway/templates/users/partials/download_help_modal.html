<!-- Download Help Modal -->
<div class="modal fade"
     id="downloadHelpModal"
     tabindex="-1"
     aria-labelledby="downloadHelpModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="downloadHelpModalLabel">
                    <i class="bi bi-question-circle"></i> Download Help
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs" id="downloadHelpTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active"
                                id="sdk-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#sdk-content"
                                type="button"
                                role="tab"
                                aria-controls="sdk-content"
                                aria-selected="true">
                            <i class="bi bi-code-slash"></i> SDK Instructions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="confirmation-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#confirmation-content"
                                type="button"
                                role="tab"
                                aria-controls="confirmation-content"
                                aria-selected="false">
                            <i class="bi bi-download"></i> Download Confirmation
                        </button>
                    </li>
                </ul>
                <!-- Tab Content -->
                <div class="tab-content mt-3" id="downloadHelpTabContent">
                    <!-- SDK Instructions Tab -->
                    <div class="tab-pane fade show active"
                         id="sdk-content"
                         role="tabpanel"
                         aria-labelledby="sdk-tab">{% include "users/partials/sdk_download_instructions.html" %}</div>
                    <!-- Download Confirmation Tab -->
                    <div class="tab-pane fade"
                         id="confirmation-content"
                         role="tabpanel"
                         aria-labelledby="confirmation-tab">
                        {% include "users/partials/download_confirmation.html" %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const helpModal = document.getElementById('downloadHelpModal');
        const confirmBtn = document.getElementById('confirmDownloadBtn');
        const sdkTab = document.getElementById('sdk-tab');
        const confirmationTab = document.getElementById('confirmation-tab');

        // Function to show confirmation tab and enable download button
        function showConfirmation(datasetName, datasetUuid) {
            // Set the dataset name in the confirmation content
            const modalDatasetName = document.getElementById('modalDatasetName');
            if (modalDatasetName) {
                modalDatasetName.textContent = datasetName;
            }

            // Switch to confirmation tab
            const confirmationTabInstance = new bootstrap.Tab(confirmationTab);
            confirmationTabInstance.show();

            // Store dataset info for download
            confirmBtn.dataset.datasetUuid = datasetUuid;
            confirmBtn.dataset.datasetName = datasetName;
        }

        // Handle download confirmation
        confirmBtn.addEventListener('click', function() {
            const datasetUuid = this.dataset.datasetUuid;
            const datasetName = this.dataset.datasetName;

            if (datasetUuid) {
                // Make the download request
                fetch(`/api/datasets/${datasetUuid}/download/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            include_artifacts: true,
                            include_captures: true
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Show success message
                            showAlert('Download request submitted successfully! You will receive an email when ready.', 'success');

                            // Close the modal
                            const modal = bootstrap.Modal.getInstance(helpModal);
                            modal.hide();

                            // Reset the modal state
                            setTimeout(() => {
                                const sdkTabInstance = new bootstrap.Tab(sdkTab);
                                sdkTabInstance.show();
                                confirmBtn.dataset.datasetUuid = '';
                                confirmBtn.dataset.datasetName = '';
                            }, 500);
                        } else {
                            showAlert('Error requesting download: ' + (data.message || 'Unknown error'), 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Error requesting download. Please try again.', 'error');
                    });
            }
        });

        // Reset modal state when hidden
        helpModal.addEventListener('hidden.bs.modal', function() {
            const sdkTabInstance = new bootstrap.Tab(sdkTab);
            sdkTabInstance.show();
            confirmBtn.dataset.datasetUuid = '';
            confirmBtn.dataset.datasetName = '';
        });

        // Make the showConfirmation function globally available
        window.showDownloadConfirmation = showConfirmation;
    });

    // Global function to show alert (if not already defined)
    function showAlert(message, type = 'info') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        const alertClass = type === 'error' ? 'alert-danger' : type === 'success' ? 'alert-success' : 'alert-info';

        const toastHtml = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">${type === 'error' ? 'Error' : type === 'success' ? 'Success' : 'Info'}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;

        toastContainer.innerHTML = toastHtml;

        // Auto-remove after 5 seconds
        setTimeout(() => {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.remove();
            }
        }, 5000);
    }
</script>
