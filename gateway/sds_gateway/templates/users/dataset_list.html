{% extends "base.html" %}

{% load static %}
{% load custom_filters %}
{% load tz %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/permission-levels.css' %}" />
{% endblock css %}
{% block bodyclass %}
    hero-white-page
{% endblock bodyclass %}
{% block content %}
    {% csrf_token %}
    <!-- Add Bootstrap Icons for sort arrows -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <div class="content-wrapper">
        <div class="main-content-area">
            <div class="container mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title">Datasets</h1>
                    <a href="{% url 'users:group_captures' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add Dataset
                    </a>
                </div>
                
                <!-- Tabs for My Datasets / Search Published Datasets -->
                <ul class="nav nav-tabs mb-4" id="datasetTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if mode != 'search' %}active{% endif %}" 
                                id="my-datasets-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#my-datasets" 
                                type="button" 
                                role="tab"
                                aria-controls="my-datasets"
                                aria-selected="{% if mode != 'search' %}true{% else %}false{% endif %}">
                            <i class="bi bi-folder me-2"></i>My Datasets
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if mode == 'search' %}active{% endif %}" 
                                id="search-datasets-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#search-datasets" 
                                type="button" 
                                role="tab"
                                aria-controls="search-datasets"
                                aria-selected="{% if mode == 'search' %}true{% else %}false{% endif %}">
                            <i class="bi bi-search me-2"></i>Search Published Datasets
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="datasetTabsContent">
                    <!-- My Datasets Tab -->
                    <div class="tab-pane fade {% if mode != 'search' %}show active{% endif %}" 
                         id="my-datasets" 
                         role="tabpanel" 
                         aria-labelledby="my-datasets-tab">
                        {% include "users/partials/my_datasets_tab.html" %}
                    </div>

                    <!-- Search Published Datasets Tab -->
                    <div class="tab-pane fade {% if mode == 'search' %}show active{% endif %}" 
                         id="search-datasets" 
                         role="tabpanel" 
                         aria-labelledby="search-datasets-tab">
                        {% include "users/partials/search_published_datasets_tab.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modals to reveal on click -->
{% include "users/partials/web_download_modal.html" %}
{% include "users/partials/dataset_details_modal.html" %}
{% if page_obj %}
    {% for dataset in page_obj %}
        {% include "users/partials/share_modal.html" with item=dataset item_type="dataset" %}
        {% include "users/partials/sdk_download_modal.html" with dataset=dataset %}
        {% if dataset.is_owner or dataset.permission_level == 'co-owner' %}
            {% if not dataset.dataset.status == 'final' or not dataset.is_public %}
                {% include "users/partials/publish_dataset_modal.html" with dataset=dataset %}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endif %}
{% endblock content %}
{% block javascript %}
    {# djlint:off #}
    {{ block.super }}
    <!-- Search components -->
    <script src="{% static 'js/search/AssetSearchHandler.js' %}"></script>
    <script src="{% static 'js/search/DatasetSearchHandler.js' %}"></script>
    <!-- Dataset components -->
    <script src="{% static 'js/dataset/DatasetCreationHandler.js' %}"></script>
    <script src="{% static 'js/dataset/DatasetEditingHandler.js' %}"></script>
    <script src="{% static 'js/dataset/DatasetModeManager.js' %}"></script>
    <!-- Action components -->
    <script src="{% static 'js/actions/ShareActionManager.js' %}"></script>
    <script src="{% static 'js/actions/DownloadActionManager.js' %}"></script>
    <script src="{% static 'js/actions/DetailsActionManager.js' %}"></script>
    <script src="{% static 'js/actions/PublishActionManager.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-icon-dropdown').forEach(function(toggle) {
                const dropdown = new bootstrap.Dropdown(toggle, {
                    container: 'body',
                    boundary: 'viewport',
                    popperConfig: {
                        modifiers: [{
                            name: 'preventOverflow',
                            options: {
                                boundary: 'viewport'
                            }
                        }]
                    }
                });

                // Manually move dropdown to body when shown
                toggle.addEventListener('show.bs.dropdown', function() {
                    const dropdownMenu = toggle.nextElementSibling;
                    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                        document.body.appendChild(dropdownMenu);
                    }
                });
            });

            // Initialize PageLifecycleManager for dataset list page
            const pageConfig = {
                pageType: 'dataset-list',
                permissions: {
                    userPermissionLevel: 'owner', // User is always owner of their own datasets
                    currentUserId: {{ request.user.id|default:"null" }},
                    isOwner: true,
                    datasetPermissions: {
                        canEditMetadata: true,
                        canAddAssets: true,
                        canRemoveAnyAssets: true,
                        canRemoveOwnAssets: true,
                        canShare: true,
                        canDownload: true,
                        canDelete: true
                    }
                }
            };

            // Initialize the page lifecycle manager
            // This will automatically handle all modal initialization including share modals
            window.pageLifecycleManager = new PageLifecycleManager(pageConfig);

            // Initialize PublishActionManager for publish modals
            if (typeof PublishActionManager !== 'undefined') {
                window.publishActionManager = new PublishActionManager();
            }

            // Check for dataset download alert messages only
            const downloadAlert = sessionStorage.getItem('datasetDownloadAlert');
            if (downloadAlert) {
                const alertData = JSON.parse(downloadAlert);
                showAlert(alertData.message, alertData.type);
                sessionStorage.removeItem('datasetDownloadAlert');
            }

            // Prevent row click when clicking on dropdown elements
            document.addEventListener('click', function(event) {
                if (event.target.closest('.dropdown') ||
                    event.target.closest('.btn-icon-dropdown') ||
                    event.target.closest('.dropdown-toggle') ||
                    event.target.closest('.dropdown-menu')) {
                    event.stopPropagation();
                }
            });

        });
</script>
    {# djlint:on #}
{% endblock javascript %}
