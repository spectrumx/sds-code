{% extends "base.html" %}

{% load static %}
{% load custom_filters %}
{% load tz %}

{% block bodyclass %}
    hero-white-page
{% endblock bodyclass %}
{% block content %}
    {% csrf_token %}
    <!-- Add Bootstrap Icons for sort arrows -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <div class="content-wrapper">
        <div class="main-content-area">
            <div class="container mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title">Datasets</h1>
                    <a href="{% url 'users:group_captures' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Add Dataset
                    </a>
                </div>
                <hr />
                <!-- Results count display -->
                {% if page_obj.object_list %}
                    <div class="d-flex justify-content-end mb-3">
                        <span id="results-count" aria-live="polite" class="text-muted">
                            {{ page_obj.paginator.count }} dataset{{ page_obj.paginator.count|pluralize }} found
                        </span>
                    </div>
                {% endif %}
                <!-- AJAX‑Updatable Table & Pagination -->
                <div id="dynamic-table-container" class="table-and-pagination">
                    <div class="table-container">
                        <div class="table-responsive">
                            {% if not page_obj %}
                                <table class="table table-striped table-hover datasets-table-fixed">
                                    <caption class="visually-hidden">Your datasets list</caption>
                                    <thead>
                                        <tr>
                                            <th scope="col" class="sortable w-20" data-sort="name">
                                                Dataset Name <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="sortable w-25" data-sort="authors">
                                                Author <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="sortable w-25" data-sort="created_at">
                                                Created At <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="w-10">Actions</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div class="alert alert-info" role="alert">
                                    <h4 class="alert-heading">No datasets yet</h4>
                                    <p>
                                        It looks like you don't have any datasets yet. To get started, <a href="{% url 'users:group_captures' %}" class="alert-link">create a new dataset</a> from your captures and files.
                                    </p>
                                </div>
                            {% else %}
                                <table class="table table-striped table-hover datasets-table-fixed">
                                    <caption class="visually-hidden">Your datasets list</caption>
                                    <thead>
                                        <tr>
                                            <th scope="col" class="sortable w-15" data-sort="name">
                                                Dataset Name <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="sortable w-25" data-sort="authors">
                                                Author <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="sortable w-25" data-sort="created_at">
                                                Created At <i class="bi bi-caret-down-fill sort-icon"></i>
                                            </th>
                                            <th scope="col" class="w-10">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for dataset in page_obj %}
                                            <tr class="clickable-row" data-dataset-uuid="{{ dataset.uuid }}">
                                                <td class="text-break">
                                                    {% if dataset.is_owner %}
                                                        <a href="#"
                                                           class="dataset-name-link"
                                                           data-bs-toggle="modal"
                                                           data-bs-target="#datasetDetailsModal"
                                                           data-dataset-uuid="{{ dataset.uuid }}"
                                                           aria-label="View details for {{ dataset.name }}">
                                                            {{ dataset.name }}
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted dataset-name-link"
                                                              data-bs-toggle="modal"
                                                              data-bs-target="#datasetDetailsModal"
                                                              data-dataset-uuid="{{ dataset.uuid }}">{{ dataset.name }}</span>
                                                    {% endif %}
                                                    {% if dataset.status == 'draft' %}
                                                        <span class="ms-2 badge bg-secondary">{{ dataset.status_display }}</span>
                                                    {% endif %}
                                                    {% if dataset.is_shared_with_me %}
                                                        <span class="ms-2 align-middle"
                                                              data-bs-toggle="tooltip"
                                                              title="Shared with you">
                                                            <i class="bi bi-people-fill text-success"></i>
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-break">
                                                    {% if dataset.authors %}
                                                        {% for author in dataset.authors %}
                                                            {% if forloop.counter <= 2 %}
                                                                {% if author.name %}
                                                                    {{ author.name }}
                                                                    {% if forloop.counter == 1 and dataset.authors|length > 1 %},{% endif %}
                                                                {% else %}
                                                                    {{ author }}
                                                                    {% if forloop.counter == 1 and dataset.authors|length > 1 %},{% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        {% if dataset.authors|length > 2 %}<span class="text-muted">...</span>{% endif %}
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                                <td class="text-nowrap">
                                                    {% if dataset.dataset.created_at %}
                                                        <!-- Actual display -->
                                                        {% localtime on %}
                                                        <div class="d-flex align-items-center gap-2">
                                                            <span class="bg-transparent pe-2">{{ dataset.dataset.created_at|date:"Y-m-d" }}</span>
                                                            <span class="text-muted bg-transparent">{{ dataset.dataset.created_at|date:"H:i:s T" }}</span>
                                                        </div>
                                                    {% endlocaltime %}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-light dropdown-toggle btn-icon-dropdown"
                                                            type="button"
                                                            data-bs-toggle="dropdown"
                                                            data-bs-boundary="viewport"
                                                            aria-expanded="false"
                                                            aria-label="Actions for {{ dataset.name }}">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        {% if dataset.is_owner %}
                                                            <li>
                                                                <button class="dropdown-item"
                                                                        type="button"
                                                                        onclick="window.location.href='{% url 'users:group_captures' %}?dataset_uuid={{ dataset.uuid }}'">
                                                                    <i class="bi bi-pencil me-2"></i>Edit
                                                                </button>
                                                            </li>
                                                            <li>
                                                                <button class="dropdown-item"
                                                                        type="button"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#share-modal-{{ dataset.uuid }}">
                                                                    <i class="bi bi-share me-2"></i>Share
                                                                </button>
                                                            </li>
                                                        {% endif %}
                                                        <li>
                                                            <button class="dropdown-item"
                                                                    type="button"
                                                                    onclick="showWebDownloadModal('{{ dataset.uuid }}', '{{ dataset.name }}')">
                                                                <i class="bi bi-download me-2"></i>Web Download
                                                            </button>
                                                        </li>
                                                        <li>
                                                            <button class="dropdown-item"
                                                                    type="button"
                                                                    onclick="showSDKDownloadModal('{{ dataset.uuid }}')">
                                                                <i class="bi bi-code-slash me-2"></i>SDK Download Instructions
                                                            </button>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Pagination - Updated to match search.html style -->
            {% if page_obj.object_list %}
                <nav aria-label="Dataset pagination">
                    <ul class="pagination justify-content-center" id="pagination-controls">
                        {% if page_obj.paginator.num_pages > 1 %}
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page={{ page_obj.previous_page_number }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}"
                                       aria-label="Previous">
                                        <span aria-hidden="true">«</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                        <span aria-hidden="true">«</span>
                                    </a>
                                </li>
                            {% endif %}
                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num|add:0 > page_obj.number|add:'-3' and num|add:0 < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link"
                                           href="?page={{ num }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link"
                                       href="?page={{ page_obj.next_page_number }}&amp;sort_by={{ sort_by }}&amp;sort_order={{ sort_order }}"
                                       aria-label="Next">
                                        <span aria-hidden="true">»</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1" aria-disabled="true">
                                        <span aria-hidden="true">»</span>
                                    </a>
                                </li>
                            {% endif %}
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
</div>
<!-- Modals to reveal on click -->
{% include "users/partials/web_download_modal.html" %}
{% include "users/partials/dataset_details_modal.html" %}
{% for dataset in page_obj %}
    {% include "users/partials/share_modal.html" with item=dataset item_type="dataset" %}
    {% include "users/partials/sdk_download_modal.html" with dataset=dataset %}
{% endfor %}
<!-- Toast container for notifications -->
<div aria-live="polite"
     aria-atomic="true"
     class="position-fixed top-0 end-0 p-3 toast-container">
    <div id="toast-container"></div>
</div>
{% endblock content %}
{% block javascript %}
    {{ block.super }}
    <!-- Action components -->
    <script src="{% static 'js/actions/ShareActionManager.js' %}"></script>
    <script src="{% static 'js/actions/DownloadActionManager.js' %}"></script>
    <script src="{% static 'js/actions/DetailsActionManager.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-icon-dropdown').forEach(function(toggle) {
                const dropdown = new bootstrap.Dropdown(toggle, {
                    container: 'body',
                    boundary: 'viewport',
                    popperConfig: {
                        modifiers: [{
                            name: 'preventOverflow',
                            options: {
                                boundary: 'viewport'
                            }
                        }]
                    }
                });

                // Manually move dropdown to body when shown
                toggle.addEventListener('show.bs.dropdown', function() {
                    const dropdownMenu = toggle.nextElementSibling;
                    if (dropdownMenu && dropdownMenu.classList.contains('dropdown-menu')) {
                        document.body.appendChild(dropdownMenu);
                    }
                });
            });
        
            // Initialize PageLifecycleManager for dataset list page
            const pageConfig = {
                pageType: 'dataset-list',
                permissions: {
                    userPermissionLevel: 'owner', // User is always owner of their own datasets
                    currentUserId: {{ request.user.id }},
                    isOwner: true,
                    datasetPermissions: {
                        canEditMetadata: true,
                        canAddAssets: true,
                        canRemoveAnyAssets: true,
                        canRemoveOwnAssets: true,
                        canShare: true,
                        canDownload: true,
                        canDelete: true
                    }
                }
            };

            // Initialize the page lifecycle manager
            // This will automatically handle all modal initialization including share modals
            window.pageLifecycleManager = new PageLifecycleManager(pageConfig);

            // Check for dataset download alert messages only
            const downloadAlert = sessionStorage.getItem('datasetDownloadAlert');
            if (downloadAlert) {
                const alertData = JSON.parse(downloadAlert);
                showAlert(alertData.message, alertData.type);
                sessionStorage.removeItem('datasetDownloadAlert');
            }

            // Prevent row click when clicking on dropdown elements
            document.addEventListener('click', function(event) {
                if (event.target.closest('.dropdown') ||
                    event.target.closest('.btn-icon-dropdown') ||
                    event.target.closest('.dropdown-toggle') ||
                    event.target.closest('.dropdown-menu')) {
                    event.stopPropagation();
                }
            });

        });
    </script>
{% endblock javascript %}
