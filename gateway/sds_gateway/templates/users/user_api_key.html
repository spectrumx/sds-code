{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/user_api_key_table.css' %}" />
{% endblock css %}
{% block bodyclass %}
    hero-white-page
{% endblock bodyclass %}
{% block content %}
    {% csrf_token %}
    <!-- Add Bootstrap Icons for sort arrows -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <div class="content-wrapper">
        <div class="main-content-area">
            <div class="container mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 id="current-api-keys-section" class="page-title">API Keys</h1>
                    <a href="{% url 'users:generate_api_key_form' %}"
                       class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Generate API Key
                    </a>
                </div>
                <hr />
                <div id="dynamic-table-container" class="table-and-pagination">
                    <div class="table-container">
                        <div class="table-responsive">
                            {% if current_api_keys and current_api_keys|length > 0 %}
                                <table class="table table-striped user-api-key-table">
                                    <thead>
                                        <tr>
                                            <th scope="col" class="col-prefix">Prefix</th>
                                            <th scope="col" class="col-name">Name</th>
                                            <th scope="col" class="col-description">Description</th>
                                            <th scope="col" class="col-created">Created</th>
                                            <th scope="col" class="col-expires">Expires</th>
                                            <th scope="col" class="col-revoked">Revoked</th>
                                            <th scope="col" class="col-action">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key in current_api_keys %}
                                            <tr>
                                                <td>
                                                    {{ key.prefix }}
                                                    {% if key.expiry_date and key.expiry_date < now %}
                                                        <div class="text-danger mt-1">
                                                            <strong>Expired</strong>
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if key.name|length > 25 %}
                                                        {{ key.name|slice:":25" }}...
                                                        <a type="button"
                                                           class="capture-link"
                                                           onclick="var nameDiv = document.getElementById('nameDropdown{{ key.id }}'); var btn = this; nameDiv.classList.toggle('d-none'); btn.textContent = nameDiv.classList.contains('d-none') ? 'View More' : 'View Less';">
                                                            View More
                                                        </a>
                                                        <div id="nameDropdown{{ key.id }}" class="d-none mt-2">{{ key.name }}</div>
                                                    {% else %}
                                                        {{ key.name }}
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if key.description|length > 25 %}
                                                        {{ key.description|slice:":25" }}...
                                                        <a type="button"
                                                           class="capture-link"
                                                           onclick="var desc = document.getElementById('descDropdown{{ key.id }}'); var btn = this; desc.classList.toggle('d-none'); btn.textContent = desc.classList.contains('d-none') ? 'View More' : 'View Less';">
                                                            View More
                                                        </a>
                                                        <div id="descDropdown{{ key.id }}" class="d-none mt-2">{{ key.description }}</div>
                                                    {% else %}
                                                        {{ key.description }}
                                                    {% endif %}
                                                </td>
                                                <td>{{ key.created }}</td>
                                                <td>
                                                    {% if key.expiry_date %}
                                                        {{ key.expiry_date }}
                                                    {% else %}
                                                        Does not expire
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if key.revoked %}
                                                        <span class="text-danger">Yes</span>
                                                    {% else %}
                                                        <span class="text-success">No</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-light dropdown-toggle btn-icon-dropdown"
                                                                type="button"
                                                                id="actionDropdown{{ key.id }}"
                                                                data-bs-toggle="dropdown"
                                                                data-bs-popper="static"
                                                                aria-expanded="false">
                                                            <i class="bi bi-three-dots-vertical"></i>
                                                        </button>
                                                        <ul class="dropdown-menu" aria-labelledby="actionDropdown{{ key.id }}">
                                                            <li>
                                                                <button type="button"
                                                                        class="dropdown-item text-danger"
                                                                        onclick="showApiKeyModal('delete', '{{ key.id }}')">
                                                                    Delete
                                                                </button>
                                                            </li>
                                                            {% if not key.revoked %}
                                                                <li>
                                                                    <button type="button"
                                                                            class="dropdown-item text-danger"
                                                                            onclick="showApiKeyModal('revoke', '{{ key.id }}')">
                                                                        Revoke
                                                                    </button>
                                                                </li>
                                                            {% endif %}
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="col-lg-6 offset-lg-3 col-md-8 offset-md-2 col-sm-12 offset-sm-0">
                                    <p>You currently do not have any API Keys.</p>
                                </div>
                            {% endif %}
                            <div class="text-center">
                                <a type="button" class="capture-link" href="#current-api-keys-section">Back to Top</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Custom Modal for Delete/Revoke API Key -->
    <div class="custom-modal"
         id="apiKeyModal"
         tabindex="-1"
         aria-labelledby="apiKeyModalLabel"
         aria-hidden="true">
        <div class="custom-modal-backdrop"
             onclick="closeCustomModal('apiKeyModal')"></div>
        <div class="custom-modal-dialog">
            <div class="custom-modal-content">
                <div class="custom-modal-header">
                    <h5 class="custom-modal-title" id="apiKeyModalLabel">Confirm Action</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                            onclick="closeCustomModal('apiKeyModal')"></button>
                </div>
                <form id="apiKeyModalForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="key_id" id="apiKeyModalKeyId" value="" />
                    <div class="custom-modal-body">
                        <p id="apiKeyModalMessage">Are you sure you want to perform this action?</p>
                    </div>
                    <div class="custom-modal-footer">
                        <button type="button"
                                class="btn btn-secondary"
                                onclick="closeCustomModal('apiKeyModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="apiKeyModalConfirmBtn">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        function showApiKeyModal(action, keyId) {
            var modal = document.getElementById('apiKeyModal');
            var form = document.getElementById('apiKeyModalForm');
            var message = document.getElementById('apiKeyModalMessage');
            var confirmBtn = document.getElementById('apiKeyModalConfirmBtn');
            var keyInput = document.getElementById('apiKeyModalKeyId');
            keyInput.value = keyId;
            if (action === 'delete') {
                form.action = "{% url 'users:delete_api_key' %}";
                message.textContent = 'Are you sure you want to delete this API Key?';
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'btn btn-danger';
            } else if (action === 'revoke') {
                form.action = "{% url 'users:revoke_api_key' %}";
                message.textContent = 'Are you sure you want to revoke this API Key? This cannot be undone.';
                confirmBtn.textContent = 'Revoke';
                confirmBtn.className = 'btn btn-danger';
            }
            modal.style.display = 'block';
        }

        function closeCustomModal(modalId) {
            var modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
    </script>
{% endblock content %}
