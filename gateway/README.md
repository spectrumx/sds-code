# SpectrumX Data System Gateway

Control plane, metadata management, and web interface for SDS

[![Built with Cookiecutter Django](https://img.shields.io/badge/built%20with-Cookiecutter%20Django-ff69b4.svg?logo=cookiecutter)](https://github.com/cookiecutter/cookiecutter-django/)
[![Ruff](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/ruff/main/assets/badge/v2.json)](https://github.com/astral-sh/ruff)

## Development

### Installation

System dependencies

```bash
# dev bindings for python and postgres
sudo apt install python3-dev libpq-dev # on ubuntu
sudo dnf install python3-devel postgresql-devel # on RHEL

# get psql, createdb, etc.
sudo apt install postgresql-client # for psql
sudo dnf install postgresql # for psql
```

Python dependencies

`pip` can be used, but the easiest and fastest way is to use `uv` ([installing `uv`](https://docs.astral.sh/uv/getting-started/installation/)). If you still want to use `pip`, consider the compatible and faster alternative `uv pip` (e.g. `alias pip=uv pip`).

```bash
uv sync --frozen --extra local
# --frozen does not upgrade the dependencies
# --extra local installs the required dependencies + 'local' ones (for local development)
```

> [!NOTE]
> When using `uv`, all base, local, and production dependencies are described in the `pyproject.toml` file.
>
> If you're using `pip`, refer to the `requirements/` directory.

Install pre-commit hooks to automatically run linters, formatters, etc. before committing:

```bash
uv run pre-commit install
```

## Local deploy

1. Set secrets:

    ```bash
    rsync -aP ./.envs/example ./.envs/local
    # manually set the secrets in .envs/local/*.env files
    ```

    > [!NOTE]
    > In `minio.env`, `AWS_SECRET_ACCESS_KEY == MINIO_ROOT_PASSWORD`;
    >
    > In `django.env`, to generate the `API_KEY` get it running first, then navigate to [localhost:8000/users/generate-api-key](http://localhost:8000/users/generate-api-key). Copy the generated key to that file. The key is not stored in the database, so you will only see it at creation time.

2. Deploy with Docker (recommended):

    ```bash
    docker compose -f compose.local.yaml up
    ```

    If you have issues with static files, you can check which ones are being generated by the node service:

    ```bash
    http://localhost:3000/webpack-dev-server
    ```

3. Make Django migrations and run them:

    ```bash
    docker exec -it sds_gateway_local_django python manage.py makemigrations
    docker exec -it sds_gateway_local_django python manage.py migrate
    ```

4. Create the first superuser:

    ```bash
    docker exec -it sds_gateway_local_django python manage.py createsuperuser
    # or
    # docker compose -f compose.local.yaml exec django python manage.py createsuperuser
    ```

5. Access the web interface:

    Open the web interface at [localhost:8000](http://localhost:8000). You can create regular users bt signing up there.

    You can sign in with the superuser credentials at [localhost:8000/admin](http://localhost:8000/admin) to access the admin interface.

6. Run tests:

    ```bash
    docker exec -it sds-gateway-app python manage.py test
    ```

    Tests that run:
    * `test_authenticate`
    * `test_create_file`
    * `test_retrieve_file`
    * `test_retrieve_latest_file`
    * `test_update_file`
    * `test_delete_file`
    * `test_file_contents_check`
    * `test_download_file`
    * `test_minio_health_check`
    * `test_opensearch_health_check`
