set shell := ["bash", "-eu", "-o", "pipefail", "-c"]

# TIP: Looking into running a production setting?
#   Add your machine hostname to ./scripts/prod-hostnames.env

# constants
env_selection_script := "./scripts/env-selection.sh"
snapshot_log_dir := "./logs/snapshots"
secrets_generator := "./scripts/generate-secrets.sh"

# variables | run `just env` to see current values
app_container := shell(env_selection_script + ' $1', "app_container")
compose_file := shell(env_selection_script + ' $1', "compose_file")
env := shell(env_selection_script + ' $1', "env")
env_file := shell(env_selection_script + ' $1', "env_file")
docker_compose := "COMPOSE_FILE=" + compose_file + " docker compose --env-file " + env_file
uv_cmd := docker_compose + " run '" + app_container + "' uv"
uv_runner := uv_cmd + " run"

alias run := up
alias upgrade := update

# pulls and rebuild the compose services with optional args
build *args:
    @echo "Pulling and building sds-gateway"
    {{docker_compose}} pull --ignore-buildable
    {{docker_compose}} build {{args}}

# pulls and rebuilds from scratch without cache
build-full *args:
    @echo "Pulling and building sds-gateway WITHOUT CACHE"
    {{docker_compose}} pull --ignore-buildable
    {{docker_compose}} build --no-cache {{args}}

# removes ephemeral files, like python caches and test coverage reports
clean:
    #!/usr/bin/env bash
    declare -a recursive_directories
    recursive_directories=('__pycache__' '.pytest_cache' '.ruff_cache' 'node_modules')
    for dir in "${recursive_directories[@]}"; do
        find . -type d -name "${dir}" -prune -exec rm -rfv {} +
    done
    single_directories=('tests/coverage')
    for dir in "${single_directories[@]}"; do
        rm -rfv "${dir}"
    done
    single_files=(
        'celerybeat-schedule' # legacy; should only be in container
    )
    for file in "${single_files[@]}"; do
        rm -rfv "${file}"
    done
    echo "Removed ephemeral files"

# runs a generic docker compose command e.g. `just dc ps`
dc +args:
    @echo "Running docker compose command: {{args}}"
    {{docker_compose}} {{args}}

# sets up the development environment
dev-setup:
    #!/usr/bin/env bash
    set -euo pipefail
    echo -e "Setting up development environment\n"

    # check for required system dependencies
    echo "Checking system dependencies..."
    missing_deps=()

    if ! command -v docker &> /dev/null; then
        missing_deps+=("docker")
    fi
    if ! docker compose version &> /dev/null; then
        missing_deps+=("docker-compose-plugin")
    fi
    if ! command -v uv &> /dev/null; then
        missing_deps+=("uv (install from: https://docs.astral.sh/uv/getting-started/installation/)")
    fi
    if ! command -v just &> /dev/null; then
        missing_deps+=("just (install from: https://github.com/casey/just#installation/)")
    fi

    # check postgresql client
    pg_client_found=false
    if command -v psql &> /dev/null; then
        pg_client_found=true
    fi
    if [[ "${pg_client_found}" == "false" ]]; then
        missing_deps+=("postgresql-client (Ubuntu/Debian) or postgresql (RHEL/Fedora)")
    fi

    # report missing dependencies
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo -e "\n\e[31m✗ Missing required system dependencies:\e[0m"
        for dep in "${missing_deps[@]}"; do
            echo "  - ${dep}"
        done
        echo -e "\n\e[33mInstall commands (run as needed for your system):\e[0m"
        echo -e "  Ubuntu/Debian:"
        echo "    sudo apt update"
        echo "    sudo apt install -y docker.io docker-compose-v2 python3-dev libpq-dev postgresql-client"
        echo "    curl -LsSf https://astral.sh/uv/install.sh | sh"
        echo "    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/bin"
        echo -e "  RHEL/Fedora:"
        echo "    sudo dnf install -y docker docker-compose-plugin python3-devel postgresql-devel postgresql"
        echo "    curl -LsSf https://astral.sh/uv/install.sh | sh"
        echo "    curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ~/bin"
        echo -e "\n  Node.js 20: https://nodejs.org/ or use nvm/fnm"
        echo ""
        exit 1
    fi

    echo -e "\e[32m✓ All system dependencies found\e[0m\n"

    # install python dependencies
    echo "Installing Python dependencies..."
    uv sync --extra local --frozen

    # install pre-commit hooks
    echo "Installing pre-commit hooks..."
    uv run pre-commit install

    echo -e "\n\e[32m✓ Development environment setup complete\e[0m"
    echo -e "\nFor recommended VS Code extensions, see ../sds-code.code-workspace"

# prints currently selected environment, for debugging and validation purposes
env:
    @echo -e "\nSelected env:\n"
    @echo -e "\tEnvironment: \e[34m             '{{env}}'\e[0m"
    @echo -e "\tEnvironment file: \e[34m        '{{env_file}}'\e[0m"
    @echo -e "\tCompose file: \e[34m            '{{compose_file}}'\e[0m"
    @echo -e "\tDocker compose command: \e[34m  '{{docker_compose}}'\e[0m"
    @echo -e "\tUV runner command: \e[34m       '{{uv_runner}}'\e[0m"

# generates environment secrets for local/production/ci environments
generate-secrets env_type *args:
    @echo "Generating secrets for '{{env_type}}' environment..."
    {{secrets_generator}} {{args}} {{env_type}}

# streams logs until interrupted (tails 10k lines); args are passed to compose logs
logs *args:
    @echo "Showing sds-gateway logs..."
    {{docker_compose}} logs --tail 10000 -f {{args}} || true

# prints all recent logs once; args are passed to compose logs
logs-once *args:
    @echo "Showing gateway logs once..."
    {{docker_compose}} logs {{args}}

# stops and remove compose services; args are passed to compose down
down *args:
    @echo "Stopping sds-gateway"
    {{docker_compose}} down {{args}}

# runs the pre-commit hooks with dev dependencies
pre-commit:
    uv run pre-commit install
    uv run --dev pre-commit run --all-files

# rebuilds then restarts services and shows logs
redeploy services='':
    just build {{services}}
    just down {{services}}
    just up {{services}}
    just logs {{services}}

# restarts running compose services
restart *args:
    @echo "Restarting sds-gateway"
    {{docker_compose}} restart {{args}}

# serves pytest coverage HTML locally
serve-coverage:
    @echo "Serving coverage reports"
    COMPOSE_FILE={{compose_file}} uv run -m http.server 1313 -d "./htmlcov"

# captures a snapshot of the configured environment
snapshot:
    #!/usr/bin/env bash
    echo "Creating a snapshot of '{{env}}' data"
    mkdir -p {{snapshot_log_dir}}
    log_file="{{snapshot_log_dir}}/{{env}}-snapshot-$(date +%Y-%m-%d_%H-%M-%S).log"
    ./scripts/create-snapshot.sh {{env}} 2>&1 | tee "${log_file}"
    echo "See logs at '${log_file}'"

# runs all tests (python and javascript); args are passed to pytest
test *args:
    @echo "Running all tests"
    @just test-py {{args}}
    @just test-js

# validates templates and runs pytest inside the app container
test-py *args:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Validating templates"
    {{uv_runner}} manage.py validate_templates
    echo "Running Python tests"
    # show test names if -k is used (focused test run)
    if [[ "{{args}}" =~ -k ]]; then
        {{uv_runner}} pytest \
            -rA \
            {{args}}
    else
        {{uv_runner}} pytest {{args}}
    fi

# runs javascript tests inside the app container
test-js *args:
    @echo "Running JavaScript tests"
    {{docker_compose}} run node npm run test {{args}}

# starts services in detached mode; if env is local, starts process to watch files
up *args:
    #!/usr/bin/env bash
    echo "Starting sds-gateway in detached mode"
    {{docker_compose}} up --detach --remove-orphans {{args}}

    # this watcher is not working as intended today, and
    # there's no easy way to stop it, so it's disabled for now:

    # if [ "{{env}}" = "local" ]; then
    #     just watch &
    # fi

# upgrades pre-commit hooks and gateway dependencies to their latest compatible versions
update:
    # these run on the host machine, so uv_runner is not used
    @echo "Upgrading pre-commit hooks"
    uv run pre-commit autoupdate
    @echo "Upgrading gateway dependencies"
    uv sync --upgrade --all-extras
    @echo "Upgrading node dependencies"
    {{docker_compose}} run node npm update

# shorthand for 'uv' commands (e.g. `just uv run manage.py migrate`)
uv +args:
    @echo "Running uv command: {{args}}"
    {{uv_cmd}} {{args}}

# watch file changes when in local env mode
watch *args:
    #!/usr/bin/env bash
    if [ "{{env}}" != "local" ]; then
        echo "The 'watch' command is only available in the 'local' environment"
        exit 1
    fi
    echo "Watching for file changes..."
    {{docker_compose}} watch {{args}}
