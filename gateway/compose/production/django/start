#!/bin/bash

set -euo pipefail

APP_DIR="/app"

# logs a message and waits for manual input before exiting and terminating the container
function echo_wait_and_quit() {
    local message="$1"
    echo >&2 "$message"

    # this wait may be useful for manually running manage.py or
    # other shell commands in the container in case of failure:
    echo -e >&2 "\033[0;31mGiving time for manual input before exiting...\033[0m"
    sleep 3600

    exit 1
}

function main() {

    pushd "${APP_DIR}" || {
        echo_wait_and_quit "Failed to change directory to ${APP_DIR}."
    }

    echo "Updating installed dependencies..."
    uv sync --frozen --extra production || {
        echo_wait_and_quit "Failed to sync project dependencies."
    }

    echo "Collecting static files..."
    uv run manage.py collectstatic --noinput || {
        echo_wait_and_quit "Failed to collect static files."
    }

    echo "Applying database migrations..."
    uv run manage.py migrate --noinput || {
        echo_wait_and_quit "Failed to apply database migrations."
    }

echo "Initializing OpenSearch indices..."
uv run manage.py init_indices

exec uv run /usr/local/bin/gunicorn config.asgi --bind 0.0.0.0:18000 --chdir=/app -k uvicorn_worker.UvicornWorker
